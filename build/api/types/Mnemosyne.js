'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
const constants_1 = require("../../constants");
const { odp, SymbolConstructorName, SymbolGaia, SymbolReplaceUranus, MNEMONICA, GAIA, URANUS } = constants_1.constants;
const utils_1 = require("../utils");
const { getTypeChecker, findSubTypeFromParent, reflectPrimitiveWrappers } = utils_1.default;
const extract_1 = require("../../utils/extract");
const parent_1 = require("../../utils/parent");
const pick_1 = require("../../utils/pick");
const exceptionConstructor_1 = require("../errors/exceptionConstructor");
const InstanceCreator_1 = require("./InstanceCreator");
const Props_1 = require("./Props");
const InstanceRoots = new WeakMap;
const Gaia = function (Uranus) {
    const gaiaProto = Uranus ? Uranus : this;
    const GaiaConstructor = function () { };
    Reflect.setPrototypeOf(GaiaConstructor.prototype, Object.create(gaiaProto));
    const gaia = new GaiaConstructor;
    odp(gaia, MNEMONICA, {
        get() {
            return !Uranus ? GAIA : URANUS;
        }
    });
    return gaia;
};
const MnemonicaProtoProps = {
    extract() {
        return function () {
            return (0, extract_1.extract)(this);
        };
    },
    pick() {
        return function (...args) {
            return (0, pick_1.pick)(this, ...args);
        };
    },
    parent() {
        return function (constructorLookupPath) {
            return (0, parent_1.parent)(this, constructorLookupPath);
        };
    },
    clone() {
        return this.fork();
    },
    fork() {
        const props = (0, Props_1._getProps)(this);
        const { __type__: type, __collection__: collection, __parent__: existentInstance, __args__, __self__, } = props;
        const { isSubType, TypeName } = type;
        return function (...forkArgs) {
            let forked;
            const Constructor = isSubType ?
                existentInstance :
                collection;
            const args = forkArgs.length ? forkArgs : __args__;
            if (this === __self__) {
                forked = new (Constructor[TypeName])(...args);
            }
            else {
                forked = new InstanceCreator_1.InstanceCreator(type, reflectPrimitiveWrappers(this), args);
            }
            return forked;
        };
    },
    [SymbolReplaceUranus]() {
        return function (uranus) {
            Reflect.setPrototypeOf(Reflect.getPrototypeOf(this[SymbolGaia]), uranus);
        };
    },
    [SymbolConstructorName]() {
        return MNEMONICA;
    },
    exception() {
        const self = this;
        return function (error, ...args) {
            const target = new.target;
            return exceptionConstructor_1.default.call(self, target, error, ...args);
        };
    },
    sibling() {
        const siblings = (SiblingTypeName) => {
            const props = (0, Props_1._getProps)(this);
            const { __collection__: collection, } = props;
            const sibling = collection[SiblingTypeName];
            return sibling;
        };
        return new Proxy(siblings, {
            get(_, prop) {
                return siblings(prop);
            },
            apply(_, __, args) {
                return siblings(args[0]);
            }
        });
    }
};
const staticProps = [
    'constructor',
    'prototype',
    'then',
    'stack',
    'message',
    'domain',
    'on',
    'once',
    'off',
    'inspect',
    'showDiff',
]
    .concat(Object.keys(MnemonicaProtoProps))
    .concat(Object.getOwnPropertyNames(Object.prototype))
    .concat(Object.getOwnPropertyNames(Function.prototype))
    .reduce((obj, key) => {
    obj[key] = true;
    return obj;
}, Object.create(null));
const makeSubTypeProxy = function (subtype, inheritedInstance) {
    const subtypeProxy = new Proxy(InstanceCreator_1.InstanceCreator, {
        get(Target, _prop) {
            if (_prop === Symbol.hasInstance) {
                return getTypeChecker(subtype.TypeName);
            }
            return Reflect.get(Target, _prop);
        },
        construct(Target, _args) {
            return new Target(subtype, inheritedInstance, _args);
        },
        apply(Target, thisArg, _args) {
            if (thisArg === undefined) {
                thisArg = inheritedInstance;
            }
            let existentInstance = reflectPrimitiveWrappers(thisArg);
            if (!existentInstance[SymbolGaia]) {
                const mnemosyne = new Mnemosyne(new Gaia(existentInstance));
                existentInstance = new Proxy(mnemosyne, {
                    get: mnemosyneProxyHandlerGet
                });
            }
            const entity = new Target(subtype, existentInstance, _args);
            return entity;
        },
    });
    return subtypeProxy;
};
const mnemosyneProxyHandlerGet = (target, prop, receiver) => {
    const result = Reflect.get(target, prop, receiver);
    if (result !== undefined) {
        return result;
    }
    if (typeof prop === 'symbol') {
        return result;
    }
    if (staticProps[prop]) {
        return result;
    }
    const instance = Reflect.getPrototypeOf(receiver);
    const props = (0, Props_1._getProps)(instance);
    const { __type__: { config: { strictChain }, subtypes }, } = props;
    const subtype = subtypes.has(prop) ?
        subtypes.get(prop) :
        strictChain ?
            undefined :
            findSubTypeFromParent(instance, prop);
    return subtype ? makeSubTypeProxy(subtype, receiver) : result;
};
const Mnemosyne = function (gaia) {
    const instance = this;
    const Mnemonica = function () {
        odp(this, SymbolConstructorName, {
            get() {
                return MNEMONICA;
            }
        });
    };
    const mnemonica = Reflect.getPrototypeOf(gaia);
    Reflect.setPrototypeOf(Mnemonica.prototype, mnemonica);
    Object.entries(MnemonicaProtoProps).forEach(([name, method]) => {
        odp(Mnemonica.prototype, name, {
            get() {
                return method.call(this);
            }
        });
    });
    Object.getOwnPropertySymbols(MnemonicaProtoProps).forEach((symbol) => {
        odp(Mnemonica.prototype, symbol, {
            get() {
                const symbolMethod = Reflect.get(MnemonicaProtoProps, symbol);
                return symbolMethod.call(this);
            }
        });
    });
    odp(Mnemonica.prototype, Symbol.hasInstance, {
        get() {
            return getTypeChecker(this.constructor.name);
        }
    });
    odp(Mnemonica.prototype, SymbolGaia, {
        get() {
            return gaia;
        }
    });
    const proto = new Mnemonica();
    Reflect.setPrototypeOf(instance, proto);
    InstanceRoots.set(instance, proto);
};
const createMnemosyne = function (Uranus) {
    const uranus = reflectPrimitiveWrappers(Uranus);
    const mnemosyne = new Mnemosyne(new Gaia(uranus));
    const mnemosyneProxy = new Proxy(mnemosyne, {
        get: mnemosyneProxyHandlerGet
    });
    return mnemosyneProxy;
};
exports.default = {
    Gaia,
    get createMnemosyne() {
        return createMnemosyne;
    },
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTW5lbW9zeW5lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2FwaS90eXBlcy9NbmVtb3N5bmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOztBQUdiLCtDQUE0QztBQUM1QyxNQUFNLEVBQ0wsR0FBRyxFQUNILHFCQUFxQixFQUNyQixVQUFVLEVBQ1YsbUJBQW1CLEVBRW5CLFNBQVMsRUFDVCxJQUFJLEVBQ0osTUFBTSxFQUVOLEdBQUcscUJBQVMsQ0FBQztBQUVkLG9DQUFrQztBQUNsQyxNQUFNLEVBQ0wsY0FBYyxFQUNkLHFCQUFxQixFQUNyQix3QkFBd0IsRUFDeEIsR0FBRyxlQUFVLENBQUM7QUFFZixpREFBOEM7QUFDOUMsK0NBQTRDO0FBQzVDLDJDQUF3QztBQUV4Qyx5RUFBa0U7QUFFbEUsdURBQW9EO0FBRXBELG1DQUEyQztBQUUzQyxNQUFNLGFBQWEsR0FBRyxJQUFJLE9BQU8sQ0FBQztBQUlsQyxNQUFNLElBQUksR0FBRyxVQUFVLE1BQVc7SUFFakMsTUFBTSxTQUFTLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUV6QyxNQUFNLGVBQWUsR0FBRyxjQUFjLENBQWdDLENBQUM7SUFDdkUsT0FBTyxDQUFDLGNBQWMsQ0FBQyxlQUFlLENBQUMsU0FBUyxFQUFFLE1BQU0sQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztJQUU1RSxNQUFNLElBQUksR0FBRyxJQUFJLGVBQWUsQ0FBQztJQUVqQyxHQUFHLENBQUMsSUFBSSxFQUFFLFNBQVMsRUFBRTtRQUNwQixHQUFHO1lBQ0YsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUM7UUFDaEMsQ0FBQztLQUNELENBQUMsQ0FBQztJQUVILE9BQU8sSUFBSSxDQUFDO0FBQ2IsQ0FBZ0MsQ0FBQztBQUdqQyxNQUFNLG1C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RTlCLE9BQU8sQ0FBQyxjQUFjLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBRXhDLGFBQWEsQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQyxDQUFDO0FBRXBDLENBQW9ELENBQUM7QUFFckQsTUFBTSxlQUFlLEdBQUcsVUFBVSxNQUFlO0lBR2hELE1BQU0sTUFBTSxHQUFHLHdCQUF3QixDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ2hELE1BQU0sU0FBUyxHQUFHLElBQUksU0FBUyxDQUFDLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7SUFDbEQsTUFBTSxjQUFjLEdBQUcsSUFBSSxLQUFLLENBQUMsU0FBUyxFQUFFO1FBQzNDLEdBQUcsRUFBRyx3QkFBd0I7S0FDOUIsQ0FBQyxDQUFDO0lBRUgsT0FBTyxjQUFjLENBQUM7QUFDdkIsQ0FBQyxDQUFDO0FBRUYsa0JBQWU7SUFDZCxJQUFJO0lBQ0osSUFBSSxlQUFlO1FBQ2xCLE9BQU8sZUFBZSxDQUFDO0lBQ3hCLENBQUM7Q0FPRCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5pbXBvcnQgeyBDb25zdHJ1Y3RvckZ1bmN0aW9uIH0gZnJvbSAnLi4vLi4vdHlwZXMnO1xuaW1wb3J0IHsgY29uc3RhbnRzIH0gZnJvbSAnLi4vLi4vY29uc3RhbnRzJztcbmNvbnN0IHtcblx0b2RwLFxuXHRTeW1ib2xDb25zdHJ1Y3Rvck5hbWUsXG5cdFN5bWJvbEdhaWEsXG5cdFN5bWJvbFJlcGxhY2VVcmFudXMsXG5cblx0TU5FTU9OSUNBLFxuXHRHQUlBLFxuXHRVUkFOVVNcblxufSA9IGNvbnN0YW50cztcblxuaW1wb3J0IFR5cGVzVXRpbHMgZnJvbSAnLi4vdXRpbHMnO1xuY29uc3Qge1xuXHRnZXRUeXBlQ2hlY2tlcixcblx0ZmluZFN1YlR5cGVGcm9tUGFyZW50LFxuXHRyZWZsZWN0UHJpbWl0aXZlV3JhcHBlcnNcbn0gPSBUeXBlc1V0aWxzO1xuXG5pbXBvcnQgeyBleHRyYWN0IH0gZnJvbSAnLi4vLi4vdXRpbHMvZXh0cmFjdCc7XG5pbXBvcnQgeyBwYXJlbnQgfSBmcm9tICcuLi8uLi91dGlscy9wYXJlbnQnO1xuaW1wb3J0IHsgcGljayB9IGZyb20gJy4uLy4uL3V0aWxzL3BpY2snO1xuXG5pbXBvcnQgZXhjZXB0aW9uQ29uc3RydWN0b3IgZnJvbSAnLi4vZXJyb3JzL2V4Y2VwdGlvbkNvbnN0cnVjdG9yJztcblxuaW1wb3J0IHsgSW5zdGFuY2VDcmVhdG9yIH0gZnJvbSAnLi9JbnN0YW5jZUNyZWF0b3InO1xuXG5pbXBvcnQgeyBfZ2V0UHJvcHMsIFByb3BzIH0gZnJvbSAnLi9Qcm9wcyc7XG5cbmNvbnN0IEluc3RhbmNlUm9vdHMgPSBuZXcgV2Vha01hcDtcblxuXG5cbmNvbnN0IEdhaWEgPSBmdW5jdGlvbiAoVXJhbnVzOiBhbnkpIHtcblxuXHRjb25zdCBnYWlhUHJvdG8gPSBVcmFudXMgPyBVcmFudXMgOiB0aGlzO1xuXG5cdGNvbnN0IEdhaWFDb25zdHJ1Y3RvciA9IGZ1bmN0aW9uICgpIHsgfSBhcyBDb25zdHJ1Y3RvckZ1bmN0aW9uPG9iamVjdD47XG5cdFJlZmxlY3Quc2V0UHJvdG90eXBlT2YoR2FpYUNvbnN0cnVjdG9yLnByb3RvdHlwZSwgT2JqZWN0LmNyZWF0ZShnYWlhUHJvdG8pKTtcblxuXHRjb25zdCBnYWlhID0gbmV3IEdhaWFDb25zdHJ1Y3RvcjtcblxuXHRvZHAoZ2FpYSwgTU5FTU9OSUNBLCB7XG5cdFx0Z2V0ICgpIHtcblx0XHRcdHJldHVybiAhVXJhbnVzID8gR0FJQSA6IFVSQU5VUztcblx0XHR9XG5cdH0pO1xuXG5cdHJldHVybiBnYWlhO1xufSBhcyBDb25zdHJ1Y3RvckZ1bmN0aW9uPG9iamVjdD47XG5cblxuY29uc3QgTW5lbW9uaWNhUHJvdG9Qcm9wcyA9IHtcblxuXHRleHRyYWN0ICgpIHtcblx0XHRyZXR1cm4gZnVuY3Rpb24gKHRoaXM6IGFueSkge1xuXHRcdFx0cmV0dXJuIGV4dHJhY3QodGhpcyk7XG5cdFx0fTtcblx0fSxcblxuXHRwaWNrICgpIHtcblx0XHRyZXR1cm4gZnVuY3Rpb24gKHRoaXM6IGFueSwgLi4uYXJnczogYW55W10pIHtcblx0XHRcdHJldHVybiBwaWNrKHRoaXMsIC4uLmFyZ3MpO1xuXHRcdH07XG5cdH0sXG5cblx0cGFyZW50ICgpIHtcblx0XHRyZXR1cm4gZnVuY3Rpb24gKHRoaXM6IGFueSwgY29uc3RydWN0b3JMb29rdXBQYXRoOiBzdHJpbmcpIHtcblx0XHRcdHJldHVybiBwYXJlbnQodGhpcywgY29uc3RydWN0b3JMb29rdXBQYXRoKTtcblx0XHR9O1xuXHR9LFxuXG5cdGNsb25lICh0aGlzOiBhbnkpIHtcblx0XHRyZXR1cm4gdGhpcy5mb3JrKCk7XG5cdH0sXG5cblx0Zm9yayAodGhpczogYW55KSB7XG5cblx0XHRjb25zdCBwcm9wcyA9IF9nZXRQcm9wcyh0aGlzKSBhcyBQcm9wcztcblxuXHRcdGNvbnN0IHtcblx0XHRcdF9fdHlwZV9fOiB0eXBlLFxuXHRcdFx0X19jb2xsZWN0aW9uX186IGNvbGxlY3Rpb24sXG5cdFx0XHRfX3BhcmVudF9fOiBleGlzdGVudEluc3RhbmNlLFxuXHRcdFx0X19hcmdzX18sXG5cdFx0XHRfX3NlbGZfXyxcblx0XHR9ID0gcHJvcHM7XG5cblx0XHRjb25zdCB7XG5cdFx0XHRpc1N1YlR5cGUsXG5cdFx0XHRUeXBlTmFtZVxuXHRcdH0gPSB0eXBlO1xuXG5cdFx0Ly8gJ2Z1bmN0aW9uJywgY2F1c2UgbWlnaHQgYmUgY2FsbGVkIHdpdGggJ25ldydcblx0XHQvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tc2hhZG93LCBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG5cdFx0cmV0dXJuIGZ1bmN0aW9uICh0aGlzOiBhbnksIC4uLmZvcmtBcmdzOiBhbnlbXSkge1xuXG5cdFx0XHRsZXQgZm9ya2VkO1xuXHRcdFx0Y29uc3QgQ29uc3RydWN0b3IgPSBpc1N1YlR5cGUgP1xuXHRcdFx0XHRleGlzdGVudEluc3RhbmNlIDpcblx0XHRcdFx0Y29sbGVjdGlvbjtcblxuXHRcdFx0Y29uc3QgYXJncyA9IGZvcmtBcmdzLmxlbmd0aCA/IGZvcmtBcmdzIDogX19hcmdzX187XG5cblxuXHRcdFx0aWYgKHRoaXMgPT09IF9fc2VsZl9fKSB7XG5cdFx0XHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvYmFuLXRzLWNvbW1lbnRcblx0XHRcdFx0Ly8gQHRzLWV4cGVjdC1lcnJvciBcblx0XHRcdFx0Zm9ya2VkID0gbmV3IChDb25zdHJ1Y3RvclsgVHlwZU5hbWUgXSkoLi4uYXJncyk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHQvLyBmb3JrLmNhbGwgPyBsZXQncyBkbyBpdCAhXG5cdFx0XHRcdGZvcmtlZCA9IG5ldyBJbnN0YW5jZUNyZWF0b3IodHlwZSwgcmVmbGVjdFByaW1pdGl2ZVdyYXBwZXJzKHRoaXMpLCBhcmdzKTtcblx0XHRcdH1cblxuXHRcdFx0cmV0dXJuIGZvcmtlZDtcblxuXHRcdH07XG5cdH0sXG5cblx0WyBTeW1ib2xSZXBsYWNlVXJhbnVzIF0gKCkge1xuXHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG5cdFx0cmV0dXJuIGZ1bmN0aW9uICh0aGlzOiBhbnksIHVyYW51czogYW55KSB7XG5cdFx0XHQvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L2Jhbi10cy1jb21tZW50XG5cdFx0XHQvLyBAdHMtaWdub3JlXG5cdFx0XHRSZWZsZWN0LnNldFByb3RvdHlwZU9mKFJlZmxlY3QuZ2V0UHJvdG90eXBlT2YodGhpc1sgU3ltYm9sR2FpYSBdKSwgdXJhbnVzKTtcblx0XHR9O1xuXHR9LFxuXG5cdFsgU3ltYm9sQ29uc3RydWN0b3JOYW1lIF0gKCkge1xuXHRcdHJldHVybiBNTkVNT05JQ0E7XG5cdH0sXG5cblx0ZXhjZXB0aW9uICgpIHtcblx0XHQvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXRoaXMtYWxpYXNcblx0XHRjb25zdCBzZWxmID0gdGhpcztcblx0XHRyZXR1cm4gZnVuY3Rpb24gKGVycm9yOiBFcnJvciwgLi4uYXJnczogYW55W10pIHtcblx0XHRcdGNvbnN0IHRhcmdldCA9IG5ldy50YXJnZXQ7XG5cdFx0XHRyZXR1cm4gZXhjZXB0aW9uQ29uc3RydWN0b3IuY2FsbChzZWxmLCB0YXJnZXQsIGVycm9yLCAuLi5hcmdzKTtcblx0XHR9O1xuXHR9LFxuXG5cdHNpYmxpbmcgKCkge1xuXHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdGhpcy1hbGlhcywgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuXHRcdGNvbnN0IHNpYmxpbmdzID0gKFNpYmxpbmdUeXBlTmFtZTogc3RyaW5nKSA9PiB7XG5cblx0XHRcdGNvbnN0IHByb3BzID0gX2dldFByb3BzKHRoaXMpIGFzIFByb3BzO1xuXHRcdFx0Y29uc3Qge1xuXHRcdFx0XHRfX2NvbGxlY3Rpb25fXzogY29sbGVjdGlvbixcblx0XHRcdH0gPSBwcm9wcztcblx0XHRcdGNvbnN0IHNpYmxpbmc6IGFueSA9IGNvbGxlY3Rpb25bIFNpYmxpbmdUeXBlTmFtZSBdO1xuXHRcdFx0cmV0dXJuIHNpYmxpbmc7XG5cdFx0fTtcblxuXHRcdHJldHVybiBuZXcgUHJveHkoc2libGluZ3MsIHtcblx0XHRcdGdldCAoXywgcHJvcDogc3RyaW5nKSB7XG5cdFx0XHRcdHJldHVybiBzaWJsaW5ncyhwcm9wKTtcblx0XHRcdH0sXG5cdFx0XHRhcHBseSAoXywgX18sIGFyZ3MsKSB7XG5cdFx0XHRcdHJldHVybiBzaWJsaW5ncyhhcmdzWyAwIF0pO1xuXHRcdFx0fVxuXHRcdH0pO1xuXHR9XG5cbn07XG5cbmNvbnN0IHN0YXRpY1Byb3BzID0gW1xuXG5cdC8vIGJ1aWx0aW5zOiBmdW5jdGlvbnMgKyBQcm9taXNlc1xuXHQnY29uc3RydWN0b3InLFxuXHQncHJvdG90eXBlJyxcblx0J3RoZW4nLFxuXG5cdC8vIGJ1aWx0aW5zOiBlcnJvcnNcblx0J3N0YWNrJyxcblx0J21lc3NhZ2UnLFxuXHQnZG9tYWluJyxcblxuXHQvLyBidWlsdGluczogRXZlbnRFbWl0dGVyXG5cdCdvbicsXG5cdCdvbmNlJyxcblx0J29mZicsXG5cblx0Ly8gbW9jaGEgKyBjaGFpID0+IGJ1ZzogLi91dGlscy5qcyAuZmluZFN1YlR5cGVGcm9tUGFyZW50ICdpbnNwZWN0J1xuXHQnaW5zcGVjdCcsXG5cdCdzaG93RGlmZicsXG5cbl1cblx0LmNvbmNhdChPYmplY3Qua2V5cyhNbmVtb25pY2FQcm90b1Byb3BzKSlcblx0LmNvbmNhdChPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhPYmplY3QucHJvdG90eXBlKSlcblx0LmNvbmNhdChPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhGdW5jdGlvbi5wcm90b3R5cGUpKVxuXHQucmVkdWNlKChvYmosIGtleSkgPT4ge1xuXHRcdG9ialsga2V5IF0gPSB0cnVlO1xuXHRcdHJldHVybiBvYmo7XG5cdH0sIE9iamVjdC5jcmVhdGUobnVsbCkpO1xuXG4vLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG9ubHktYXJyb3ctZnVuY3Rpb25zXG5jb25zdCBtYWtlU3ViVHlwZVByb3h5ID0gZnVuY3Rpb24gKHN1YnR5cGU6IGFueSwgaW5oZXJpdGVkSW5zdGFuY2U6IGFueSkge1xuXG5cdGNvbnN0IHN1YnR5cGVQcm94eSA9IG5ldyBQcm94eShJbnN0YW5jZUNyZWF0b3IsIHtcblxuXHRcdGdldCAoVGFyZ2V0LCBfcHJvcCkge1xuXG5cdFx0XHRpZiAoX3Byb3AgPT09IFN5bWJvbC5oYXNJbnN0YW5jZSkge1xuXHRcdFx0XHRyZXR1cm4gZ2V0VHlwZUNoZWNrZXIoc3VidHlwZS5UeXBlTmFtZSk7XG5cdFx0XHR9XG5cblx0XHRcdHJldHVybiBSZWZsZWN0LmdldChUYXJnZXQsIF9wcm9wKTtcblxuXHRcdH0sXG5cblx0XHRjb25zdHJ1Y3QgKFRhcmdldCwgX2FyZ3MpIHtcblx0XHRcdHJldHVybiBuZXcgVGFyZ2V0KHN1YnR5cGUsIGluaGVyaXRlZEluc3RhbmNlLCBfYXJncyk7XG5cdFx0fSxcblxuXHRcdGFwcGx5IChUYXJnZXQsIHRoaXNBcmcsIF9hcmdzKSB7XG5cblx0XHRcdGlmICh0aGlzQXJnID09PSB1bmRlZmluZWQpIHtcblx0XHRcdFx0dGhpc0FyZyA9IGluaGVyaXRlZEluc3RhbmNlO1xuXHRcdFx0fVxuXG5cdFx0XHQvLyBUT0RPOiBpZiB3ZSB3b3VsZCBtYWtlIG5ldyBrZXl3b3JkIG9ibGlnYXRvcnlcblx0XHRcdC8vIHRoZW4gd2Ugc2hvdWxkIGF2b2lkIGl0IGhlcmUsIHdpdGggdGhyb3cgRXJyb3JcblxuXHRcdFx0bGV0IGV4aXN0ZW50SW5zdGFuY2UgPSByZWZsZWN0UHJpbWl0aXZlV3JhcHBlcnModGhpc0FyZyk7XG5cblx0XHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvYmFuLXRzLWNvbW1lbnRcblx0XHRcdC8vIEB0cy1pZ25vcmVcblx0XHRcdGlmICghZXhpc3RlbnRJbnN0YW5jZVsgU3ltYm9sR2FpYSBdKSB7XG5cdFx0XHRcdGNvbnN0IG1uZW1vc3luZSA9IG5ldyBNbmVtb3N5bmUobmV3IEdhaWEoZXhpc3RlbnRJbnN0YW5jZSkpO1xuXHRcdFx0XHRleGlzdGVudEluc3RhbmNlID0gbmV3IFByb3h5KG1uZW1vc3luZSwge1xuXHRcdFx0XHRcdGdldCA6IG1uZW1vc3luZVByb3h5SGFuZGxlckdldFxuXHRcdFx0XHR9KTtcblx0XHRcdH1cblx0XHRcdC8vIGVsc2UgaXMgdGhlIG9yZGluYXJ5IHdheSBmb3IgYWxsIGVudGl0aWVzXG5cblx0XHRcdGNvbnN0IGVudGl0eSA9IG5ldyBUYXJnZXQoc3VidHlwZSwgZXhpc3RlbnRJbnN0YW5jZSwgX2FyZ3MpO1xuXHRcdFx0cmV0dXJuIGVudGl0eTtcblx0XHR9LFxuXG5cdH0pO1xuXG5cdHJldHVybiBzdWJ0eXBlUHJveHk7XG59O1xuXG5cbmNvbnN0IG1uZW1vc3luZVByb3h5SGFuZGxlckdldCA9ICh0YXJnZXQ6IGFueSwgcHJvcDogc3RyaW5nLCByZWNlaXZlcjogYW55KSA9PiB7XG5cblx0Ly8gTm9kZS5qcyAyMiBSZWZsZWN0LmdldCBCZWhhdmlvdXIgQ2hhbmdlZCBoZXJlXG5cdC8vIGNhdXNlIHNvbWV0aGluZyBnb25lIHdyb25nIHdpdGggcHJvcCBhc3NpZ25tZW50XG5cdC8vIHNvIG5vdyBpZiB3ZSBuZWVkIC5zdGFjaywgd2Ugc2hvdWxkIGF2b2lkIHJlY2VpdmVyIGhlcmVcblx0Ly8gbmF2ZSBub3QgeWV0IGNoZWNrZWQgb3RoZXIgc3RhdGljUHJvcHMsXG5cdC8vIGp1c3QgZml4ZWQgdGhpcyBiZWxvd1xuXHQvLyB3aGlsZSB1c2luZyBjb25kaXRpb25hbCBmb3Igc3RhdGljUHJvcHNcblx0Y29uc3QgcmVzdWx0ID0gUmVmbGVjdC5nZXQodGFyZ2V0LCBwcm9wLCByZWNlaXZlcik7XG5cblx0aWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkKSB7XG5cdFx0cmV0dXJuIHJlc3VsdDtcblx0fVxuXG5cdGlmICh0eXBlb2YgcHJvcCA9PT0gJ3N5bWJvbCcpIHtcblx0XHRyZXR1cm4gcmVzdWx0O1xuXHR9XG5cblx0aWYgKHN0YXRpY1Byb3BzWyBwcm9wIF0pIHtcblx0XHQvKlxuXHRcdGNvbnN0IG1heUJlUmVzdWx0ID0gUmVmbGVjdC5nZXQodGFyZ2V0LCBwcm9wKTtcblx0XHRpZiAobWF5QmVSZXN1bHQgIT09IHVuZGVmaW5lZCkge1xuXHRcdFx0cmV0dXJuIG1heUJlUmVzdWx0O1xuXHRcdH1cblx0XHQqL1xuXHRcdHJldHVybiByZXN1bHQ7XG5cdH1cblxuXHQvLyBwcm90b3R5cGUgb2YgcHJveHlcblx0Y29uc3QgaW5zdGFuY2U6IGFueSA9IFJlZmxlY3QuZ2V0UHJvdG90eXBlT2YocmVjZWl2ZXIpO1xuXG5cdGNvbnN0IHByb3BzID0gX2dldFByb3BzKGluc3RhbmNlKSBhcyBQcm9wcztcblx0Y29uc3Qge1xuXHRcdF9fdHlwZV9fOiB7XG5cdFx0XHRjb25maWc6IHtcblx0XHRcdFx0c3RyaWN0Q2hhaW5cblx0XHRcdH0sXG5cdFx0XHRzdWJ0eXBlc1xuXHRcdH0sXG5cdH0gPSBwcm9wcztcblxuXG5cdGNvbnN0IHN1YnR5cGUgPSBzdWJ0eXBlcy5oYXMocHJvcCkgP1xuXHRcdHN1YnR5cGVzLmdldChwcm9wKSA6XG5cdFx0c3RyaWN0Q2hhaW4gP1xuXHRcdFx0dW5kZWZpbmVkIDpcblx0XHRcdGZpbmRTdWJUeXBlRnJvbVBhcmVudChpbnN0YW5jZSwgcHJvcCk7XG5cblx0cmV0dXJuIHN1YnR5cGUgPyBtYWtlU3ViVHlwZVByb3h5KHN1YnR5cGUsIHJlY2VpdmVyKSA6IHJlc3VsdDtcbn07XG5cblxuY29uc3QgTW5lbW9zeW5lID0gZnVuY3Rpb24gKGdhaWE6IGFueSkge1xuXG5cdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdGhpcy1hbGlhc1xuXHRjb25zdCBpbnN0YW5jZSA9IHRoaXM7XG5cblx0Y29uc3QgTW5lbW9uaWNhOiBhbnkgPSBmdW5jdGlvbiAodGhpczogYW55KSB7XG5cdFx0b2RwKHRoaXMsIFN5bWJvbENvbnN0cnVjdG9yTmFtZSwge1xuXHRcdFx0Z2V0ICgpIHtcblx0XHRcdFx0cmV0dXJuIE1ORU1PTklDQTtcblx0XHRcdH1cblx0XHR9KTtcblx0fTtcblxuXHRjb25zdCBtbmVtb25pY2EgPSBSZWZsZWN0LmdldFByb3RvdHlwZU9mKGdhaWEpO1xuXG5cdFJlZmxlY3Quc2V0UHJvdG90eXBlT2YoTW5lbW9uaWNhLnByb3RvdHlwZSwgbW5lbW9uaWNhKTtcblxuXHRPYmplY3QuZW50cmllcyhNbmVtb25pY2FQcm90b1Byb3BzKS5mb3JFYWNoKChbIG5hbWUsIG1ldGhvZCBdOiBbc3RyaW5nLCBhbnldKSA9PiB7XG5cdFx0b2RwKE1uZW1vbmljYS5wcm90b3R5cGUsIG5hbWUsIHtcblx0XHRcdGdldCAodGhpczogYW55KSB7XG5cdFx0XHRcdHJldHVybiBtZXRob2QuY2FsbCh0aGlzKTtcblx0XHRcdH1cblx0XHR9KTtcblx0fSk7XG5cblx0T2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhNbmVtb25pY2FQcm90b1Byb3BzKS5mb3JFYWNoKChzeW1ib2w6IHN5bWJvbCkgPT4ge1xuXHRcdG9kcChNbmVtb25pY2EucHJvdG90eXBlLCBzeW1ib2wsIHtcblx0XHRcdGdldCAoKSB7XG5cdFx0XHRcdGNvbnN0IHN5bWJvbE1ldGhvZCA9IFJlZmxlY3QuZ2V0KE1uZW1vbmljYVByb3RvUHJvcHMsIHN5bWJvbCk7XG5cdFx0XHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvYmFuLXRzLWNvbW1lbnRcblx0XHRcdFx0Ly8gQHRzLWlnbm9yZVxuXHRcdFx0XHRyZXR1cm4gc3ltYm9sTWV0aG9kLmNhbGwodGhpcyk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdH0pO1xuXG5cdC8vIGluc3RhbmNlIG9mIHNlbGYgQ29uc3RydWN0b3IgdHlwZVxuXHRvZHAoTW5lbW9uaWNhLnByb3RvdHlwZSwgU3ltYm9sLmhhc0luc3RhbmNlLCB7XG5cdFx0Z2V0ICgpIHtcblx0XHRcdHJldHVybiBnZXRUeXBlQ2hlY2tlcih0aGlzLmNvbnN0cnVjdG9yLm5hbWUpO1xuXHRcdH1cblx0fSk7XG5cblx0b2RwKE1uZW1vbmljYS5wcm90b3R5cGUsIFN5bWJvbEdhaWEsIHtcblx0XHRnZXQgKCkge1xuXHRcdFx0cmV0dXJuIGdhaWE7XG5cdFx0fVxuXHR9KTtcblxuXHRjb25zdCBwcm90byA9IG5ldyBNbmVtb25pY2EoKTtcblxuXHRSZWZsZWN0LnNldFByb3RvdHlwZU9mKGluc3RhbmNlLCBwcm90byk7XG5cblx0SW5zdGFuY2VSb290cy5zZXQoaW5zdGFuY2UsIHByb3RvKTtcblxufSBhcyBDb25zdHJ1Y3RvckZ1bmN0aW9uPHR5cGVvZiBNbmVtb25pY2FQcm90b1Byb3BzPjtcblxuY29uc3QgY3JlYXRlTW5lbW9zeW5lID0gZnVuY3Rpb24gKFVyYW51czogdW5rbm93bikge1xuXHQvLyBjb25zdHJ1Y3RzIG5ldyBHYWlhIC0+IG5ldyBNbmVtb3N5bmVcblx0Ly8gdG8gYnVpbGQgdGhlIGZpcnN0IGluc3RhbmNlIGluIGNoYWluXG5cdGNvbnN0IHVyYW51cyA9IHJlZmxlY3RQcmltaXRpdmVXcmFwcGVycyhVcmFudXMpO1xuXHRjb25zdCBtbmVtb3N5bmUgPSBuZXcgTW5lbW9zeW5lKG5ldyBHYWlhKHVyYW51cykpO1xuXHRjb25zdCBtbmVtb3N5bmVQcm94eSA9IG5ldyBQcm94eShtbmVtb3N5bmUsIHtcblx0XHRnZXQgOiBtbmVtb3N5bmVQcm94eUhhbmRsZXJHZXRcblx0fSk7XG5cblx0cmV0dXJuIG1uZW1vc3luZVByb3h5O1xufTtcblxuZXhwb3J0IGRlZmF1bHQge1xuXHRHYWlhLFxuXHRnZXQgY3JlYXRlTW5lbW9zeW5lICgpIHtcblx0XHRyZXR1cm4gY3JlYXRlTW5lbW9zeW5lO1xuXHR9LFxuXHQvLyBnZXQgTW5lbW9zeW5lUHJvdG90eXBlS2V5cyAoKSB7XG5cdC8vIFx0cmV0dXJuIE1uZW1vc3luZVByb3RvdHlwZUtleXM7XG5cdC8vIH0sXG5cdC8vIGdldCBJbnN0YW5jZVJvb3RzICgpIHtcblx0Ly8gXHRyZXR1cm4gSW5zdGFuY2VSb290cztcblx0Ly8gfVxufTtcbiJdfQ==