'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
const constants_1 = require("../../constants");
const { odp, SymbolConstructorName, MNEMONICA, } = constants_1.constants;
const utils_1 = require("../utils");
const { getTypeChecker, findSubTypeFromParent, reflectPrimitiveWrappers } = utils_1.default;
const extract_1 = require("../../utils/extract");
const parent_1 = require("../../utils/parent");
const pick_1 = require("../../utils/pick");
const exceptionConstructor_1 = require("../errors/exceptionConstructor");
const InstanceCreator_1 = require("./InstanceCreator");
const Props_1 = require("./Props");
const MnemonicaProtoProps = {
    extract() {
        return function () {
            return (0, extract_1.extract)(this);
        };
    },
    pick() {
        return function (...args) {
            return (0, pick_1.pick)(this, ...args);
        };
    },
    parent() {
        return function (constructorLookupPath) {
            return (0, parent_1.parent)(this, constructorLookupPath);
        };
    },
    clone() {
        return this.fork();
    },
    fork() {
        const props = (0, Props_1._getProps)(this);
        const { __type__: type, __collection__: collection, __parent__: existentInstance, __args__, __self__, } = props;
        const { isSubType, TypeName } = type;
        return function (...forkArgs) {
            let forked;
            const Constructor = isSubType ?
                existentInstance :
                collection;
            const args = forkArgs.length ? forkArgs : __args__;
            if (this === __self__) {
                forked = new (Constructor[TypeName])(...args);
            }
            else {
                forked = new InstanceCreator_1.InstanceCreator(type, reflectPrimitiveWrappers(this), args);
            }
            return forked;
        };
    },
    [SymbolConstructorName]() {
        return MNEMONICA;
    },
    exception() {
        const self = this;
        return function (error, ...args) {
            const target = new.target;
            return exceptionConstructor_1.default.call(self, target, error, ...args);
        };
    },
    sibling() {
        const siblings = (SiblingTypeName) => {
            const props = (0, Props_1._getProps)(this);
            const { __collection__: collection, } = props;
            const sibling = collection[SiblingTypeName];
            return sibling;
        };
        return new Proxy(siblings, {
            get(_, prop) {
                return siblings(prop);
            },
            apply(_, __, args) {
                return siblings(args[0]);
            }
        });
    }
};
const staticProps = [
    'constructor',
    'prototype',
    'then',
    'stack',
    'message',
    'domain',
    'on',
    'once',
    'off',
    'inspect',
    'showDiff',
]
    .concat(Object.keys(MnemonicaProtoProps))
    .concat(Object.getOwnPropertyNames(Object.prototype))
    .concat(Object.getOwnPropertyNames(Function.prototype))
    .reduce((obj, key) => {
    obj[key] = true;
    return obj;
}, Object.create(null));
const makeSubTypeProxy = function (subtype, inheritedInstance) {
    const subtypeProxy = new Proxy(InstanceCreator_1.InstanceCreator, {
        get(Target, _prop) {
            if (_prop === Symbol.hasInstance) {
                return getTypeChecker(subtype.TypeName);
            }
            return Reflect.get(Target, _prop);
        },
        construct(Target, _args) {
            return new Target(subtype, inheritedInstance, _args);
        },
        apply(Target, thisArg, _args) {
            if (thisArg === undefined) {
                thisArg = inheritedInstance;
            }
            const existentInstance = reflectPrimitiveWrappers(thisArg);
            const entity = new Target(subtype, existentInstance, _args);
            return entity;
        },
    });
    return subtypeProxy;
};
const prepareSubtypeForConstruction = function (subtypeName, inheritedInstance) {
    const propInstance = Reflect.getPrototypeOf(inheritedInstance);
    const props = (0, Props_1._getProps)(propInstance);
    const { __type__: { config: { strictChain }, subtypes }, } = props;
    const subtype = subtypes.has(subtypeName) ?
        subtypes.get(subtypeName) :
        strictChain ?
            undefined :
            findSubTypeFromParent(inheritedInstance, subtypeName);
    return subtype ? makeSubTypeProxy(subtype, inheritedInstance) : undefined;
};
const mnemosyneProxyHandlerGet = (target, prop, receiver) => {
    const result = Reflect.get(target, prop, receiver);
    if (result !== undefined) {
        return result;
    }
    if (typeof prop === 'symbol') {
        return result;
    }
    if (staticProps[prop]) {
        return result;
    }
    const subtype = prepareSubtypeForConstruction(prop, receiver);
    return subtype || result;
};
const Mnemosyne = function (mnemonica) {
    const instance = this;
    const Mnemonica = function () {
        odp(this, SymbolConstructorName, {
            get() {
                return MNEMONICA;
            }
        });
    };
    Reflect.setPrototypeOf(Mnemonica.prototype, mnemonica);
    Object.entries(MnemonicaProtoProps).forEach(([name, method]) => {
        odp(Mnemonica.prototype, name, {
            get() {
                return method.call(this);
            }
        });
    });
    Object.getOwnPropertySymbols(MnemonicaProtoProps).forEach((symbol) => {
        odp(Mnemonica.prototype, symbol, {
            get() {
                const symbolMethod = Reflect.get(MnemonicaProtoProps, symbol);
                return symbolMethod.call(this);
            }
        });
    });
    odp(Mnemonica.prototype, Symbol.hasInstance, {
        get() {
            return getTypeChecker(this.constructor.name);
        }
    });
    const proto = new Mnemonica();
    Reflect.setPrototypeOf(instance, proto);
};
const createMnemosyne = function (Uranus) {
    const uranus = reflectPrimitiveWrappers(Uranus);
    const mnemosyne = new Mnemosyne(uranus);
    const mnemosyneProxy = new Proxy(mnemosyne, {
        get: mnemosyneProxyHandlerGet
    });
    return mnemosyneProxy;
};
exports.default = {
    get createMnemosyne() {
        return createMnemosyne;
    },
    get prepareSubtypeForConstruction() {
        return prepareSubtypeForConstruction;
    },
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTW5lbW9zeW5lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2FwaS90eXBlcy9NbmVtb3N5bmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOztBQUdiLCtDQUE0QztBQUM1QyxNQUFNLEVBQ0wsR0FBRyxFQUNILHFCQUFxQixFQUVyQixTQUFTLEdBRVQsR0FBRyxxQkFBUyxDQUFDO0FBRWQsb0NBQWtDO0FBQ2xDLE1BQU0sRUFDTCxjQUFjLEVBQ2QscUJBQXFCLEVBQ3JCLHdCQUF3QixFQUN4QixHQUFHLGVBQVUsQ0FBQztBQUVmLGlEQUE4QztBQUM5QywrQ0FBNEM7QUFDNUMsMkNBQXdDO0FBRXhDLHlFQUFrRTtBQUVsRSx1REFBb0Q7QUFFcEQsbUNBQTJDO0FBSTNDLE1BQU0sbUJBQW1CLEdBQUc7SUFFM0IsT0FBTztRQUNOLE9BQU87WUFDTixPQUFPLElBQUEsaUJBQU8sRUFBQyxJQUFJLENBQUMsQ0FBQztRQUN0QixDQUFDLENBQUM7SUFDSCxDQUFDO0lBRUQsSUFBSTtRQUNILE9BQU8sVUFBcUIsR0FBRyxJQUFXO1lBQ3pDLE9BQU8sSUFBQSxXQUFJLEVBQUMsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFDNUIsQ0FBQyxDQUFDO0lBQ0gsQ0FBQztJQUVELE1BQU07UUFDTCxPQUFPLFVBQXFCLHFCQUE2QjtZQUN4RCxPQUFPLElBQUEsZUFBTSxFQUFDLElBQUksRUFBRSxxQkFBcUIsQ0FBQyxDQUFDO1FBQzVDLENBQUMsQ0FBQztJQUNILENBQUM7SUFFRCxLQUFLO1FBQ0osT0FBTyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDcEIsQ0FBQztJQUVELElBQUk7UUFFSCxNQUFNLEtBQUssR0FBRyxJQUFBLGlCQUFTLEVBQUMsSUFBSSxDQUFVLENBQUM7UUFFdkMsTUFBTSxFQUNMLFFBQVEsRUFBRSxJQUFJLEVBQ2QsY0FBYyxFQUFFLFVBQVUsRUFDMUIsVUFBVSxFQUFFLGdC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RSxDQUFDO0lBRTlCLE9BQU8sQ0FBQyxjQUFjLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQyxDQUFDO0FBSXpDLENBQW9ELENBQUM7QUFFckQsTUFBTSxlQUFlLEdBQUcsVUFBVSxNQUFlO0lBQ2hELE1BQU0sTUFBTSxHQUFHLHdCQUF3QixDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ2hELE1BQU0sU0FBUyxHQUFHLElBQUksU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3hDLE1BQU0sY0FBYyxHQUFHLElBQUksS0FBSyxDQUFDLFNBQVMsRUFBRTtRQUMzQyxHQUFHLEVBQUcsd0JBQXdCO0tBQzlCLENBQUMsQ0FBQztJQUVILE9BQU8sY0FBYyxDQUFDO0FBQ3ZCLENBQUMsQ0FBQztBQUVGLGtCQUFlO0lBQ2QsSUFBSSxlQUFlO1FBQ2xCLE9BQU8sZUFBZSxDQUFDO0lBQ3hCLENBQUM7SUFDRCxJQUFJLDZCQUE2QjtRQUNoQyxPQUFPLDZCQUE2QixDQUFDO0lBQ3RDLENBQUM7Q0FPRCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5pbXBvcnQgeyBDb25zdHJ1Y3RvckZ1bmN0aW9uIH0gZnJvbSAnLi4vLi4vdHlwZXMnO1xuaW1wb3J0IHsgY29uc3RhbnRzIH0gZnJvbSAnLi4vLi4vY29uc3RhbnRzJztcbmNvbnN0IHtcblx0b2RwLFxuXHRTeW1ib2xDb25zdHJ1Y3Rvck5hbWUsXG5cblx0TU5FTU9OSUNBLFxuXG59ID0gY29uc3RhbnRzO1xuXG5pbXBvcnQgVHlwZXNVdGlscyBmcm9tICcuLi91dGlscyc7XG5jb25zdCB7XG5cdGdldFR5cGVDaGVja2VyLFxuXHRmaW5kU3ViVHlwZUZyb21QYXJlbnQsXG5cdHJlZmxlY3RQcmltaXRpdmVXcmFwcGVyc1xufSA9IFR5cGVzVXRpbHM7XG5cbmltcG9ydCB7IGV4dHJhY3QgfSBmcm9tICcuLi8uLi91dGlscy9leHRyYWN0JztcbmltcG9ydCB7IHBhcmVudCB9IGZyb20gJy4uLy4uL3V0aWxzL3BhcmVudCc7XG5pbXBvcnQgeyBwaWNrIH0gZnJvbSAnLi4vLi4vdXRpbHMvcGljayc7XG5cbmltcG9ydCBleGNlcHRpb25Db25zdHJ1Y3RvciBmcm9tICcuLi9lcnJvcnMvZXhjZXB0aW9uQ29uc3RydWN0b3InO1xuXG5pbXBvcnQgeyBJbnN0YW5jZUNyZWF0b3IgfSBmcm9tICcuL0luc3RhbmNlQ3JlYXRvcic7XG5cbmltcG9ydCB7IF9nZXRQcm9wcywgUHJvcHMgfSBmcm9tICcuL1Byb3BzJztcblxuLy8gY29uc3QgSW5zdGFuY2VSb290cyA9IG5ldyBXZWFrTWFwO1xuXG5jb25zdCBNbmVtb25pY2FQcm90b1Byb3BzID0ge1xuXG5cdGV4dHJhY3QgKCkge1xuXHRcdHJldHVybiBmdW5jdGlvbiAodGhpczogYW55KSB7XG5cdFx0XHRyZXR1cm4gZXh0cmFjdCh0aGlzKTtcblx0XHR9O1xuXHR9LFxuXG5cdHBpY2sgKCkge1xuXHRcdHJldHVybiBmdW5jdGlvbiAodGhpczogYW55LCAuLi5hcmdzOiBhbnlbXSkge1xuXHRcdFx0cmV0dXJuIHBpY2sodGhpcywgLi4uYXJncyk7XG5cdFx0fTtcblx0fSxcblxuXHRwYXJlbnQgKCkge1xuXHRcdHJldHVybiBmdW5jdGlvbiAodGhpczogYW55LCBjb25zdHJ1Y3Rvckxvb2t1cFBhdGg6IHN0cmluZykge1xuXHRcdFx0cmV0dXJuIHBhcmVudCh0aGlzLCBjb25zdHJ1Y3Rvckxvb2t1cFBhdGgpO1xuXHRcdH07XG5cdH0sXG5cblx0Y2xvbmUgKHRoaXM6IGFueSkge1xuXHRcdHJldHVybiB0aGlzLmZvcmsoKTtcblx0fSxcblxuXHRmb3JrICh0aGlzOiBhbnkpIHtcblxuXHRcdGNvbnN0IHByb3BzID0gX2dldFByb3BzKHRoaXMpIGFzIFByb3BzO1xuXG5cdFx0Y29uc3Qge1xuXHRcdFx0X190eXBlX186IHR5cGUsXG5cdFx0XHRfX2NvbGxlY3Rpb25fXzogY29sbGVjdGlvbixcblx0XHRcdF9fcGFyZW50X186IGV4aXN0ZW50SW5zdGFuY2UsXG5cdFx0XHRfX2FyZ3NfXyxcblx0XHRcdF9fc2VsZl9fLFxuXHRcdH0gPSBwcm9wcztcblxuXHRcdGNvbnN0IHtcblx0XHRcdGlzU3ViVHlwZSxcblx0XHRcdFR5cGVOYW1lXG5cdFx0fSA9IHR5cGU7XG5cblx0XHQvLyAnZnVuY3Rpb24nLCBjYXVzZSBtaWdodCBiZSBjYWxsZWQgd2l0aCAnbmV3J1xuXHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1zaGFkb3csIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcblx0XHRyZXR1cm4gZnVuY3Rpb24gKHRoaXM6IGFueSwgLi4uZm9ya0FyZ3M6IGFueVtdKSB7XG5cblx0XHRcdGxldCBmb3JrZWQ7XG5cdFx0XHRjb25zdCBDb25zdHJ1Y3RvciA9IGlzU3ViVHlwZSA/XG5cdFx0XHRcdGV4aXN0ZW50SW5zdGFuY2UgOlxuXHRcdFx0XHRjb2xsZWN0aW9uO1xuXG5cdFx0XHRjb25zdCBhcmdzID0gZm9ya0FyZ3MubGVuZ3RoID8gZm9ya0FyZ3MgOiBfX2FyZ3NfXztcblxuXG5cdFx0XHRpZiAodGhpcyA9PT0gX19zZWxmX18pIHtcblx0XHRcdFx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9iYW4tdHMtY29tbWVudFxuXHRcdFx0XHQvLyBAdHMtZXhwZWN0LWVycm9yIFxuXHRcdFx0XHRmb3JrZWQgPSBuZXcgKENvbnN0cnVjdG9yWyBUeXBlTmFtZSBdKSguLi5hcmdzKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdC8vIGZvcmsuY2FsbCA/IGxldCdzIGRvIGl0ICFcblx0XHRcdFx0Zm9ya2VkID0gbmV3IEluc3RhbmNlQ3JlYXRvcih0eXBlLCByZWZsZWN0UHJpbWl0aXZlV3JhcHBlcnModGhpcyksIGFyZ3MpO1xuXHRcdFx0fVxuXG5cdFx0XHRyZXR1cm4gZm9ya2VkO1xuXG5cdFx0fTtcblx0fSxcblxuXHRbIFN5bWJvbENvbnN0cnVjdG9yTmFtZSBdICgpIHtcblx0XHRyZXR1cm4gTU5FTU9OSUNBO1xuXHR9LFxuXG5cdGV4Y2VwdGlvbiAoKSB7XG5cdFx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby10aGlzLWFsaWFzXG5cdFx0Y29uc3Qgc2VsZiA9IHRoaXM7XG5cdFx0cmV0dXJuIGZ1bmN0aW9uIChlcnJvcjogRXJyb3IsIC4uLmFyZ3M6IGFueVtdKSB7XG5cdFx0XHRjb25zdCB0YXJnZXQgPSBuZXcudGFyZ2V0O1xuXHRcdFx0cmV0dXJuIGV4Y2VwdGlvbkNvbnN0cnVjdG9yLmNhbGwoc2VsZiwgdGFyZ2V0LCBlcnJvciwgLi4uYXJncyk7XG5cdFx0fTtcblx0fSxcblxuXHRzaWJsaW5nICgpIHtcblx0XHQvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXRoaXMtYWxpYXMsIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcblx0XHRjb25zdCBzaWJsaW5ncyA9IChTaWJsaW5nVHlwZU5hbWU6IHN0cmluZykgPT4ge1xuXG5cdFx0XHRjb25zdCBwcm9wcyA9IF9nZXRQcm9wcyh0aGlzKSBhcyBQcm9wcztcblx0XHRcdGNvbnN0IHtcblx0XHRcdFx0X19jb2xsZWN0aW9uX186IGNvbGxlY3Rpb24sXG5cdFx0XHR9ID0gcHJvcHM7XG5cdFx0XHRjb25zdCBzaWJsaW5nOiBhbnkgPSBjb2xsZWN0aW9uWyBTaWJsaW5nVHlwZU5hbWUgXTtcblx0XHRcdHJldHVybiBzaWJsaW5nO1xuXHRcdH07XG5cblx0XHRyZXR1cm4gbmV3IFByb3h5KHNpYmxpbmdzLCB7XG5cdFx0XHRnZXQgKF8sIHByb3A6IHN0cmluZykge1xuXHRcdFx0XHRyZXR1cm4gc2libGluZ3MocHJvcCk7XG5cdFx0XHR9LFxuXHRcdFx0YXBwbHkgKF8sIF9fLCBhcmdzLCkge1xuXHRcdFx0XHRyZXR1cm4gc2libGluZ3MoYXJnc1sgMCBdKTtcblx0XHRcdH1cblx0XHR9KTtcblx0fVxuXG59O1xuXG5jb25zdCBzdGF0aWNQcm9wcyA9IFtcblxuXHQvLyBidWlsdGluczogZnVuY3Rpb25zICsgUHJvbWlzZXNcblx0J2NvbnN0cnVjdG9yJyxcblx0J3Byb3RvdHlwZScsXG5cdCd0aGVuJyxcblxuXHQvLyBidWlsdGluczogZXJyb3JzXG5cdCdzdGFjaycsXG5cdCdtZXNzYWdlJyxcblx0J2RvbWFpbicsXG5cblx0Ly8gYnVpbHRpbnM6IEV2ZW50RW1pdHRlclxuXHQnb24nLFxuXHQnb25jZScsXG5cdCdvZmYnLFxuXG5cdC8vIG1vY2hhICsgY2hhaSA9PiBidWc6IC4vdXRpbHMuanMgLmZpbmRTdWJUeXBlRnJvbVBhcmVudCAnaW5zcGVjdCdcblx0J2luc3BlY3QnLFxuXHQnc2hvd0RpZmYnLFxuXG5dXG5cdC5jb25jYXQoT2JqZWN0LmtleXMoTW5lbW9uaWNhUHJvdG9Qcm9wcykpXG5cdC5jb25jYXQoT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMoT2JqZWN0LnByb3RvdHlwZSkpXG5cdC5jb25jYXQoT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMoRnVuY3Rpb24ucHJvdG90eXBlKSlcblx0LnJlZHVjZSgob2JqLCBrZXkpID0+IHtcblx0XHRvYmpbIGtleSBdID0gdHJ1ZTtcblx0XHRyZXR1cm4gb2JqO1xuXHR9LCBPYmplY3QuY3JlYXRlKG51bGwpKTtcblxuLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBvbmx5LWFycm93LWZ1bmN0aW9uc1xuY29uc3QgbWFrZVN1YlR5cGVQcm94eSA9IGZ1bmN0aW9uIChzdWJ0eXBlOiBhbnksIGluaGVyaXRlZEluc3RhbmNlOiBhbnkpIHtcblxuXHRjb25zdCBzdWJ0eXBlUHJveHkgPSBuZXcgUHJveHkoSW5zdGFuY2VDcmVhdG9yLCB7XG5cblx0XHRnZXQgKFRhcmdldCwgX3Byb3ApIHtcblxuXHRcdFx0aWYgKF9wcm9wID09PSBTeW1ib2wuaGFzSW5zdGFuY2UpIHtcblx0XHRcdFx0cmV0dXJuIGdldFR5cGVDaGVja2VyKHN1YnR5cGUuVHlwZU5hbWUpO1xuXHRcdFx0fVxuXG5cdFx0XHRyZXR1cm4gUmVmbGVjdC5nZXQoVGFyZ2V0LCBfcHJvcCk7XG5cblx0XHR9LFxuXG5cdFx0Y29uc3RydWN0IChUYXJnZXQsIF9hcmdzKSB7XG5cdFx0XHRyZXR1cm4gbmV3IFRhcmdldChzdWJ0eXBlLCBpbmhlcml0ZWRJbnN0YW5jZSwgX2FyZ3MpO1xuXHRcdH0sXG5cblx0XHRhcHBseSAoVGFyZ2V0LCB0aGlzQXJnLCBfYXJncykge1xuXG5cdFx0XHRpZiAodGhpc0FyZyA9PT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRcdHRoaXNBcmcgPSBpbmhlcml0ZWRJbnN0YW5jZTtcblx0XHRcdH1cblxuXHRcdFx0Y29uc3QgZXhpc3RlbnRJbnN0YW5jZSA9IHJlZmxlY3RQcmltaXRpdmVXcmFwcGVycyh0aGlzQXJnKTtcblxuXHRcdFx0Y29uc3QgZW50aXR5ID0gbmV3IFRhcmdldChzdWJ0eXBlLCBleGlzdGVudEluc3RhbmNlLCBfYXJncyk7XG5cdFx0XHRyZXR1cm4gZW50aXR5O1xuXHRcdH0sXG5cblx0fSk7XG5cblx0cmV0dXJuIHN1YnR5cGVQcm94eTtcbn07XG5cbmNvbnN0IHByZXBhcmVTdWJ0eXBlRm9yQ29uc3RydWN0aW9uID0gZnVuY3Rpb24gKHN1YnR5cGVOYW1lOiBzdHJpbmcsIGluaGVyaXRlZEluc3RhbmNlOiBhbnkpIHtcblx0Ly8gcHJvdG90eXBlIG9mIHByb3h5XG5cdGNvbnN0IHByb3BJbnN0YW5jZTogYW55ID0gUmVmbGVjdC5nZXRQcm90b3R5cGVPZihpbmhlcml0ZWRJbnN0YW5jZSk7XG5cblx0Y29uc3QgcHJvcHMgPSBfZ2V0UHJvcHMocHJvcEluc3RhbmNlKSBhcyBQcm9wcztcblx0Y29uc3Qge1xuXHRcdF9fdHlwZV9fOiB7XG5cdFx0XHRjb25maWc6IHtcblx0XHRcdFx0c3RyaWN0Q2hhaW5cblx0XHRcdH0sXG5cdFx0XHRzdWJ0eXBlc1xuXHRcdH0sXG5cdH0gPSBwcm9wcztcblxuXG5cdGNvbnN0IHN1YnR5cGUgPSBzdWJ0eXBlcy5oYXMoc3VidHlwZU5hbWUpID9cblx0XHRzdWJ0eXBlcy5nZXQoc3VidHlwZU5hbWUpIDpcblx0XHRzdHJpY3RDaGFpbiA/XG5cdFx0XHR1bmRlZmluZWQgOlxuXHRcdFx0ZmluZFN1YlR5cGVGcm9tUGFyZW50KGluaGVyaXRlZEluc3RhbmNlLCBzdWJ0eXBlTmFtZSk7XG5cblx0cmV0dXJuIHN1YnR5cGUgPyBtYWtlU3ViVHlwZVByb3h5KHN1YnR5cGUsIGluaGVyaXRlZEluc3RhbmNlKSA6IHVuZGVmaW5lZDtcbn07XG5cbmNvbnN0IG1uZW1vc3luZVByb3h5SGFuZGxlckdldCA9ICh0YXJnZXQ6IGFueSwgcHJvcDogc3RyaW5nLCByZWNlaXZlcjogYW55KSA9PiB7XG5cblx0Ly8gTm9kZS5qcyAyMiBSZWZsZWN0LmdldCBCZWhhdmlvdXIgQ2hhbmdlZCBoZXJlXG5cdC8vIGNhdXNlIHNvbWV0aGluZyBnb25lIHdyb25nIHdpdGggcHJvcCBhc3NpZ25tZW50XG5cdC8vIHNvIG5vdyBpZiB3ZSBuZWVkIC5zdGFjaywgd2Ugc2hvdWxkIGF2b2lkIHJlY2VpdmVyIGhlcmVcblx0Ly8gbmF2ZSBub3QgeWV0IGNoZWNrZWQgb3RoZXIgc3RhdGljUHJvcHMsXG5cdC8vIGp1c3QgZml4ZWQgdGhpcyBiZWxvd1xuXHQvLyB3aGlsZSB1c2luZyBjb25kaXRpb25hbCBmb3Igc3RhdGljUHJvcHNcblx0Y29uc3QgcmVzdWx0ID0gUmVmbGVjdC5nZXQodGFyZ2V0LCBwcm9wLCByZWNlaXZlcik7XG5cblx0aWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkKSB7XG5cdFx0cmV0dXJuIHJlc3VsdDtcblx0fVxuXG5cdGlmICh0eXBlb2YgcHJvcCA9PT0gJ3N5bWJvbCcpIHtcblx0XHRyZXR1cm4gcmVzdWx0O1xuXHR9XG5cblx0aWYgKHN0YXRpY1Byb3BzWyBwcm9wIF0pIHtcblx0XHQvKlxuXHRcdGNvbnN0IG1heUJlUmVzdWx0ID0gUmVmbGVjdC5nZXQodGFyZ2V0LCBwcm9wKTtcblx0XHRpZiAobWF5QmVSZXN1bHQgIT09IHVuZGVmaW5lZCkge1xuXHRcdFx0cmV0dXJuIG1heUJlUmVzdWx0O1xuXHRcdH1cblx0XHQqL1xuXHRcdHJldHVybiByZXN1bHQ7XG5cdH1cblxuXHRjb25zdCBzdWJ0eXBlID0gcHJlcGFyZVN1YnR5cGVGb3JDb25zdHJ1Y3Rpb24ocHJvcCwgcmVjZWl2ZXIpO1xuXHRyZXR1cm4gc3VidHlwZSB8fCByZXN1bHQ7XG59O1xuXG5jb25zdCBNbmVtb3N5bmUgPSBmdW5jdGlvbiAobW5lbW9uaWNhOiBvYmplY3QgfCBudWxsKSB7XG5cblx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby10aGlzLWFsaWFzXG5cdGNvbnN0IGluc3RhbmNlID0gdGhpcztcblxuXHRjb25zdCBNbmVtb25pY2E6IGFueSA9IGZ1bmN0aW9uICh0aGlzOiBhbnkpIHtcblx0XHRvZHAodGhpcywgU3ltYm9sQ29uc3RydWN0b3JOYW1lLCB7XG5cdFx0XHRnZXQgKCkge1xuXHRcdFx0XHRyZXR1cm4gTU5FTU9OSUNBO1xuXHRcdFx0fVxuXHRcdH0pO1xuXHR9O1xuXG5cdFJlZmxlY3Quc2V0UHJvdG90eXBlT2YoTW5lbW9uaWNhLnByb3RvdHlwZSwgbW5lbW9uaWNhKTtcblxuXHRPYmplY3QuZW50cmllcyhNbmVtb25pY2FQcm90b1Byb3BzKS5mb3JFYWNoKChbIG5hbWUsIG1ldGhvZCBdOiBbc3RyaW5nLCBhbnldKSA9PiB7XG5cdFx0b2RwKE1uZW1vbmljYS5wcm90b3R5cGUsIG5hbWUsIHtcblx0XHRcdGdldCAodGhpczogYW55KSB7XG5cdFx0XHRcdHJldHVybiBtZXRob2QuY2FsbCh0aGlzKTtcblx0XHRcdH1cblx0XHR9KTtcblx0fSk7XG5cblx0T2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhNbmVtb25pY2FQcm90b1Byb3BzKS5mb3JFYWNoKChzeW1ib2w6IHN5bWJvbCkgPT4ge1xuXHRcdG9kcChNbmVtb25pY2EucHJvdG90eXBlLCBzeW1ib2wsIHtcblx0XHRcdGdldCAoKSB7XG5cdFx0XHRcdGNvbnN0IHN5bWJvbE1ldGhvZCA9IFJlZmxlY3QuZ2V0KE1uZW1vbmljYVByb3RvUHJvcHMsIHN5bWJvbCk7XG5cdFx0XHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvYmFuLXRzLWNvbW1lbnRcblx0XHRcdFx0Ly8gQHRzLWlnbm9yZVxuXHRcdFx0XHRyZXR1cm4gc3ltYm9sTWV0aG9kLmNhbGwodGhpcyk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdH0pO1xuXG5cdC8vIGluc3RhbmNlIG9mIHNlbGYgQ29uc3RydWN0b3IgdHlwZVxuXHRvZHAoTW5lbW9uaWNhLnByb3RvdHlwZSwgU3ltYm9sLmhhc0luc3RhbmNlLCB7XG5cdFx0Z2V0ICgpIHtcblx0XHRcdHJldHVybiBnZXRUeXBlQ2hlY2tlcih0aGlzLmNvbnN0cnVjdG9yLm5hbWUpO1xuXHRcdH1cblx0fSk7XG5cblx0Y29uc3QgcHJvdG8gPSBuZXcgTW5lbW9uaWNhKCk7XG5cblx0UmVmbGVjdC5zZXRQcm90b3R5cGVPZihpbnN0YW5jZSwgcHJvdG8pO1xuXG5cdC8vIEluc3RhbmNlUm9vdHMuc2V0KGluc3RhbmNlLCBwcm90byk7XG5cbn0gYXMgQ29uc3RydWN0b3JGdW5jdGlvbjx0eXBlb2YgTW5lbW9uaWNhUHJvdG9Qcm9wcz47XG5cbmNvbnN0IGNyZWF0ZU1uZW1vc3luZSA9IGZ1bmN0aW9uIChVcmFudXM6IHVua25vd24pIHtcblx0Y29uc3QgdXJhbnVzID0gcmVmbGVjdFByaW1pdGl2ZVdyYXBwZXJzKFVyYW51cyk7XG5cdGNvbnN0IG1uZW1vc3luZSA9IG5ldyBNbmVtb3N5bmUodXJhbnVzKTtcblx0Y29uc3QgbW5lbW9zeW5lUHJveHkgPSBuZXcgUHJveHkobW5lbW9zeW5lLCB7XG5cdFx0Z2V0IDogbW5lbW9zeW5lUHJveHlIYW5kbGVyR2V0XG5cdH0pO1xuXG5cdHJldHVybiBtbmVtb3N5bmVQcm94eTtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IHtcblx0Z2V0IGNyZWF0ZU1uZW1vc3luZSAoKSB7XG5cdFx0cmV0dXJuIGNyZWF0ZU1uZW1vc3luZTtcblx0fSxcblx0Z2V0IHByZXBhcmVTdWJ0eXBlRm9yQ29uc3RydWN0aW9uICgpIHtcblx0XHRyZXR1cm4gcHJlcGFyZVN1YnR5cGVGb3JDb25zdHJ1Y3Rpb247XG5cdH0sXG5cdC8vIGdldCBNbmVtb3N5bmVQcm90b3R5cGVLZXlzICgpIHtcblx0Ly8gXHRyZXR1cm4gTW5lbW9zeW5lUHJvdG90eXBlS2V5cztcblx0Ly8gfSxcblx0Ly8gZ2V0IEluc3RhbmNlUm9vdHMgKCkge1xuXHQvLyBcdHJldHVybiBJbnN0YW5jZVJvb3RzO1xuXHQvLyB9XG59O1xuIl19