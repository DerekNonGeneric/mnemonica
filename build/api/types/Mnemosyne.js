'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
const constants_1 = require("../../constants");
const { odp, SymbolConstructorName, SymbolGaia, SymbolReplaceUranus, MNEMONICA, GAIA, URANUS } = constants_1.constants;
const utils_1 = require("../utils");
const { getTypeChecker, findSubTypeFromParent, reflectPrimitiveWrappers } = utils_1.default;
const extract_1 = require("../../utils/extract");
const parent_1 = require("../../utils/parent");
const pick_1 = require("../../utils/pick");
const exceptionConstructor_1 = require("../errors/exceptionConstructor");
const InstanceCreator_1 = require("./InstanceCreator");
const TypesRoots = new WeakMap;
const Gaia = function (Uranus) {
    const gaiaProto = Uranus ? Uranus : this;
    const GaiaConstructor = function () { };
    Reflect.setPrototypeOf(GaiaConstructor.prototype, Object.create(gaiaProto));
    const gaia = new GaiaConstructor;
    odp(gaia, MNEMONICA, {
        get() {
            return !Uranus ? GAIA : URANUS;
        }
    });
    return gaia;
};
const MnemonicaProtoProps = {
    extract() {
        return function () {
            return (0, extract_1.extract)(this);
        };
    },
    pick() {
        return function (...args) {
            return (0, pick_1.pick)(this, ...args);
        };
    },
    parent() {
        return function (constructorLookupPath) {
            return (0, parent_1.parent)(this, constructorLookupPath);
        };
    },
    clone() {
        return this.fork();
    },
    fork() {
        const { __type__: type, __collection__: collection, __parent__: existentInstance, __args__, __self__ } = this;
        const { isSubType, TypeName } = type;
        return function (...forkArgs) {
            let forked;
            const Constructor = isSubType ?
                existentInstance :
                collection;
            const args = forkArgs.length ? forkArgs : __args__;
            if (this === __self__) {
                forked = new (Constructor[TypeName])(...args);
            }
            else {
                forked = new InstanceCreator_1.InstanceCreator(type, reflectPrimitiveWrappers(this), args);
            }
            return forked;
        };
    },
    [SymbolReplaceUranus]() {
        return function (uranus) {
            Reflect.setPrototypeOf(Reflect.getPrototypeOf(this[SymbolGaia]), uranus);
        };
    },
    [SymbolConstructorName]() {
        return MNEMONICA;
    },
    exception() {
        const self = this;
        return function (error, ...args) {
            const target = new.target;
            return exceptionConstructor_1.default.call(self, target, error, ...args);
        };
    },
    sibling() {
        const self = this;
        const siblings = (SiblingTypeName) => {
            const { __collection__: collection, } = self;
            const sibling = collection[SiblingTypeName];
            return sibling;
        };
        return new Proxy(siblings, {
            get(_, prop) {
                return siblings(prop);
            },
            apply(_, __, args) {
                return siblings(args[0]);
            }
        });
    }
};
const MnemosynePrototypeKeys = Object.keys(MnemonicaProtoProps);
const MnemonicaInstanceProps = [
    '__proto_proto__',
    '__type__',
    '__self__',
    '__args__',
    '__parent__',
    '__subtypes__',
    '__stack__',
    '__collection__',
    '__timestamp__',
    '__creator__'
].concat(MnemosynePrototypeKeys);
const staticProps = [
    'constructor',
    'prototype',
    'then',
    'stack',
    'message',
    'domain',
    'on',
    'once',
    'off',
    'inspect',
    'showDiff',
]
    .concat(MnemonicaInstanceProps)
    .concat(Object.getOwnPropertyNames(Object.prototype))
    .concat(Object.getOwnPropertyNames(Function.prototype))
    .reduce((obj, key) => {
    obj[key] = true;
    return obj;
}, Object.create(null));
const makeSubTypeProxy = function (subtype, inheritedInstance) {
    const subtypeProxy = new Proxy(InstanceCreator_1.InstanceCreator, {
        get(Target, _prop) {
            if (_prop === Symbol.hasInstance) {
                return getTypeChecker(subtype.TypeName);
            }
            return Reflect.get(Target, _prop);
        },
        construct(Target, _args) {
            return new Target(subtype, inheritedInstance, _args);
        },
        apply(Target, thisArg, _args) {
            if (thisArg === undefined) {
                thisArg = inheritedInstance;
            }
            let existentInstance = reflectPrimitiveWrappers(thisArg);
            if (!existentInstance[SymbolGaia]) {
                const mnemosyne = new Mnemosyne(new Gaia(existentInstance));
                existentInstance = new Proxy(mnemosyne, {
                    get: mnemosyneProxyHandlerGet
                });
            }
            const entity = new Target(subtype, existentInstance, _args);
            return entity;
        },
    });
    return subtypeProxy;
};
const mnemosyneProxyHandlerGet = (target, prop, receiver) => {
    const result = Reflect.get(target, prop, receiver);
    if (result !== undefined) {
        return result;
    }
    if (typeof prop === 'symbol') {
        return result;
    }
    if (staticProps[prop]) {
        return result;
    }
    const instance = Reflect.getPrototypeOf(receiver);
    const { __type__: { config: { strictChain }, subtypes }, } = instance;
    const subtype = subtypes.has(prop) ?
        subtypes.get(prop) :
        strictChain ?
            undefined :
            findSubTypeFromParent(instance, prop);
    return subtype ? makeSubTypeProxy(subtype, receiver) : result;
};
const Mnemosyne = function (gaia) {
    const instance = this;
    const Mnemonica = function () {
        odp(this, SymbolConstructorName, {
            get() {
                return MNEMONICA;
            }
        });
    };
    const mnemonica = Reflect.getPrototypeOf(gaia);
    Reflect.setPrototypeOf(Mnemonica.prototype, mnemonica);
    Object.entries(MnemonicaProtoProps).forEach(([name, method]) => {
        odp(Mnemonica.prototype, name, {
            get() {
                return method.call(this);
            }
        });
    });
    Object.getOwnPropertySymbols(MnemonicaProtoProps).forEach((symbol) => {
        odp(Mnemonica.prototype, symbol, {
            get() {
                const symbolMethod = Reflect.get(MnemonicaProtoProps, symbol);
                return symbolMethod.call(this);
            }
        });
    });
    odp(Mnemonica.prototype, Symbol.hasInstance, {
        get() {
            return getTypeChecker(this.constructor.name);
        }
    });
    odp(Mnemonica.prototype, SymbolGaia, {
        get() {
            return gaia;
        }
    });
    const proto = new Mnemonica();
    Reflect.setPrototypeOf(instance, proto);
    TypesRoots.set(instance, proto);
};
const createMnemosyne = function (Uranus) {
    const uranus = reflectPrimitiveWrappers(Uranus);
    const mnemosyne = new Mnemosyne(new Gaia(uranus));
    const mnemosyneProxy = new Proxy(mnemosyne, {
        get: mnemosyneProxyHandlerGet
    });
    return mnemosyneProxy;
};
exports.default = {
    Gaia,
    get createMnemosyne() {
        return createMnemosyne;
    },
    get MnemosynePrototypeKeys() {
        return MnemosynePrototypeKeys;
    },
    get TypesRoots() {
        return TypesRoots;
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTW5lbW9zeW5lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2FwaS90eXBlcy9NbmVtb3N5bmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOztBQUdiLCtDQUE0QztBQUM1QyxNQUFNLEVBQ0wsR0FBRyxFQUNILHFCQUFxQixFQUNyQixVQUFVLEVBQ1YsbUJBQW1CLEVBRW5CLFNBQVMsRUFDVCxJQUFJLEVBQ0osTUFBTSxFQUVOLEdBQUcscUJBQVMsQ0FBQztBQUVkLG9DQUFrQztBQUNsQyxNQUFNLEVBQ0wsY0FBYyxFQUNkLHFCQUFxQixFQUNyQix3QkFBd0IsRUFDeEIsR0FBRyxlQUFVLENBQUM7QUFFZixpREFBOEM7QUFDOUMsK0NBQTRDO0FBQzVDLDJDQUF3QztBQUV4Qyx5RUFBa0U7QUFFbEUsdURBQW9EO0FBR3BELE1BQU0sVUFBVSxHQUFHLElBQUksT0FBTyxDQUFDO0FBSS9CLE1BQU0sSUFBSSxHQUFHLFVBQVUsTUFBVztJQUVqQyxNQUFNLFNBQVMsR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO0lBRXpDLE1BQU0sZUFBZSxHQUFHLGNBQWMsQ0FBZ0MsQ0FBQztJQUN2RSxPQUFPLENBQUMsY0FBYyxDQUFDLGVBQWUsQ0FBQyxTQUFTLEVBQUUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO0lBRTVFLE1BQU0sSUFBSSxHQUFHLElBQUksZUFBZSxDQUFDO0lBRWpDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsU0FBUyxFQUFFO1FBQ3BCLEdBQUc7WUFDRixPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQztRQUNoQyxDQUFDO0tBQ0QsQ0FBQyxDQUFDO0lBRUgsT0FBTyxJQUFJLENBQUM7QUFDYixDQUFnQyxDQUFDO0FBR2pDLE1BQU0sbUJBQW1CLEdBQUc7SUFF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YixDQUFDO0tBQ0QsQ0FBQyxDQUFDO0lBRUgsTUFBTSxLQUFLLEdBQUcsSUFBSSxTQUFTLEVBQUUsQ0FBQztJQUU5QixPQUFPLENBQUMsY0FBYyxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUV4QyxVQUFVLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQztBQUVqQyxDQUFvRCxDQUFDO0FBRXJELE1BQU0sZUFBZSxHQUFHLFVBQVUsTUFBZTtJQUdoRCxNQUFNLE1BQU0sR0FBRyx3QkFBd0IsQ0FBRSxNQUFNLENBQUUsQ0FBQztJQUNsRCxNQUFNLFNBQVMsR0FBRyxJQUFJLFNBQVMsQ0FBRSxJQUFJLElBQUksQ0FBRSxNQUFNLENBQUUsQ0FBRSxDQUFDO0lBQ3RELE1BQU0sY0FBYyxHQUFHLElBQUksS0FBSyxDQUFFLFNBQVMsRUFBRTtRQUM1QyxHQUFHLEVBQUcsd0JBQXdCO0tBQzlCLENBQUUsQ0FBQztJQUVKLE9BQU8sY0FBYyxDQUFDO0FBQ3ZCLENBQUMsQ0FBQztBQUVGLGtCQUFlO0lBQ2QsSUFBSTtJQUNKLElBQUksZUFBZTtRQUNsQixPQUFPLGVBQWUsQ0FBQztJQUN4QixDQUFDO0lBQ0QsSUFBSSxzQkFBc0I7UUFDekIsT0FBTyxzQkFBc0IsQ0FBQztJQUMvQixDQUFDO0lBQ0QsSUFBSSxVQUFVO1FBQ2IsT0FBTyxVQUFVLENBQUM7SUFDbkIsQ0FBQztDQUNELENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmltcG9ydCB7IENvbnN0cnVjdG9yRnVuY3Rpb24gfSBmcm9tICcuLi8uLi90eXBlcyc7XG5pbXBvcnQgeyBjb25zdGFudHMgfSBmcm9tICcuLi8uLi9jb25zdGFudHMnO1xuY29uc3Qge1xuXHRvZHAsXG5cdFN5bWJvbENvbnN0cnVjdG9yTmFtZSxcblx0U3ltYm9sR2FpYSxcblx0U3ltYm9sUmVwbGFjZVVyYW51cyxcblxuXHRNTkVNT05JQ0EsXG5cdEdBSUEsXG5cdFVSQU5VU1xuXG59ID0gY29uc3RhbnRzO1xuXG5pbXBvcnQgVHlwZXNVdGlscyBmcm9tICcuLi91dGlscyc7XG5jb25zdCB7XG5cdGdldFR5cGVDaGVja2VyLFxuXHRmaW5kU3ViVHlwZUZyb21QYXJlbnQsXG5cdHJlZmxlY3RQcmltaXRpdmVXcmFwcGVyc1xufSA9IFR5cGVzVXRpbHM7XG5cbmltcG9ydCB7IGV4dHJhY3QgfSBmcm9tICcuLi8uLi91dGlscy9leHRyYWN0JztcbmltcG9ydCB7IHBhcmVudCB9IGZyb20gJy4uLy4uL3V0aWxzL3BhcmVudCc7XG5pbXBvcnQgeyBwaWNrIH0gZnJvbSAnLi4vLi4vdXRpbHMvcGljayc7XG5cbmltcG9ydCBleGNlcHRpb25Db25zdHJ1Y3RvciBmcm9tICcuLi9lcnJvcnMvZXhjZXB0aW9uQ29uc3RydWN0b3InO1xuXG5pbXBvcnQgeyBJbnN0YW5jZUNyZWF0b3IgfSBmcm9tICcuL0luc3RhbmNlQ3JlYXRvcic7XG5cblxuY29uc3QgVHlwZXNSb290cyA9IG5ldyBXZWFrTWFwO1xuXG5cblxuY29uc3QgR2FpYSA9IGZ1bmN0aW9uIChVcmFudXM6IGFueSkge1xuXG5cdGNvbnN0IGdhaWFQcm90byA9IFVyYW51cyA/IFVyYW51cyA6IHRoaXM7XG5cblx0Y29uc3QgR2FpYUNvbnN0cnVjdG9yID0gZnVuY3Rpb24gKCkgeyB9IGFzIENvbnN0cnVjdG9yRnVuY3Rpb248b2JqZWN0Pjtcblx0UmVmbGVjdC5zZXRQcm90b3R5cGVPZihHYWlhQ29uc3RydWN0b3IucHJvdG90eXBlLCBPYmplY3QuY3JlYXRlKGdhaWFQcm90bykpO1xuXG5cdGNvbnN0IGdhaWEgPSBuZXcgR2FpYUNvbnN0cnVjdG9yO1xuXG5cdG9kcChnYWlhLCBNTkVNT05JQ0EsIHtcblx0XHRnZXQgKCkge1xuXHRcdFx0cmV0dXJuICFVcmFudXMgPyBHQUlBIDogVVJBTlVTO1xuXHRcdH1cblx0fSk7XG5cblx0cmV0dXJuIGdhaWE7XG59IGFzIENvbnN0cnVjdG9yRnVuY3Rpb248b2JqZWN0PjtcblxuXG5jb25zdCBNbmVtb25pY2FQcm90b1Byb3BzID0ge1xuXG5cdGV4dHJhY3QgKCkge1xuXHRcdHJldHVybiBmdW5jdGlvbiAodGhpczogYW55KSB7XG5cdFx0XHRyZXR1cm4gZXh0cmFjdCh0aGlzKTtcblx0XHR9O1xuXHR9LFxuXG5cdHBpY2sgKCkge1xuXHRcdHJldHVybiBmdW5jdGlvbiAodGhpczogYW55LCAuLi5hcmdzOiBhbnlbXSkge1xuXHRcdFx0cmV0dXJuIHBpY2sodGhpcywgLi4uYXJncyk7XG5cdFx0fTtcblx0fSxcblxuXHRwYXJlbnQgKCkge1xuXHRcdHJldHVybiBmdW5jdGlvbiAodGhpczogYW55LCBjb25zdHJ1Y3Rvckxvb2t1cFBhdGg6IHN0cmluZykge1xuXHRcdFx0cmV0dXJuIHBhcmVudCh0aGlzLCBjb25zdHJ1Y3Rvckxvb2t1cFBhdGgpO1xuXHRcdH07XG5cdH0sXG5cblx0Y2xvbmUgKHRoaXM6IGFueSkge1xuXHRcdHJldHVybiB0aGlzLmZvcmsoKTtcblx0fSxcblxuXHRmb3JrICh0aGlzOiBhbnkpIHtcblxuXHRcdGNvbnN0IHtcblx0XHRcdF9fdHlwZV9fOiB0eXBlLFxuXHRcdFx0X19jb2xsZWN0aW9uX186IGNvbGxlY3Rpb24sXG5cdFx0XHRfX3BhcmVudF9fOiBleGlzdGVudEluc3RhbmNlLFxuXHRcdFx0X19hcmdzX18sXG5cdFx0XHRfX3NlbGZfX1xuXHRcdH0gPSB0aGlzO1xuXG5cdFx0Y29uc3Qge1xuXHRcdFx0aXNTdWJUeXBlLFxuXHRcdFx0VHlwZU5hbWVcblx0XHR9ID0gdHlwZTtcblxuXHRcdC8vICdmdW5jdGlvbicsIGNhdXNlIG1pZ2h0IGJlIGNhbGxlZCB3aXRoICduZXcnXG5cdFx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXNoYWRvdywgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuXHRcdHJldHVybiBmdW5jdGlvbiAodGhpczogYW55LCAuLi5mb3JrQXJnczogYW55W10pIHtcblxuXHRcdFx0bGV0IGZvcmtlZDtcblx0XHRcdGNvbnN0IENvbnN0cnVjdG9yID0gaXNTdWJUeXBlID9cblx0XHRcdFx0ZXhpc3RlbnRJbnN0YW5jZSA6XG5cdFx0XHRcdGNvbGxlY3Rpb247XG5cblx0XHRcdGNvbnN0IGFyZ3MgPSBmb3JrQXJncy5sZW5ndGggPyBmb3JrQXJncyA6IF9fYXJnc19fO1xuXG5cblx0XHRcdGlmICh0aGlzID09PSBfX3NlbGZfXykge1xuXHRcdFx0XHRmb3JrZWQgPSBuZXcgKENvbnN0cnVjdG9yWyBUeXBlTmFtZSBdKSguLi5hcmdzKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdC8vIGZvcmsuY2FsbCA/IGxldCdzIGRvIGl0ICFcblx0XHRcdFx0Zm9ya2VkID0gbmV3IEluc3RhbmNlQ3JlYXRvcih0eXBlLCByZWZsZWN0UHJpbWl0aXZlV3JhcHBlcnModGhpcyksIGFyZ3MpO1xuXHRcdFx0fVxuXG5cdFx0XHRyZXR1cm4gZm9ya2VkO1xuXG5cdFx0fTtcblx0fSxcblxuXHRbIFN5bWJvbFJlcGxhY2VVcmFudXMgXSAoKSB7XG5cdFx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcblx0XHRyZXR1cm4gZnVuY3Rpb24gKHRoaXM6IGFueSwgdXJhbnVzOiBhbnkpIHtcblx0XHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvYmFuLXRzLWNvbW1lbnRcblx0XHRcdC8vIEB0cy1pZ25vcmVcblx0XHRcdFJlZmxlY3Quc2V0UHJvdG90eXBlT2YoUmVmbGVjdC5nZXRQcm90b3R5cGVPZih0aGlzWyBTeW1ib2xHYWlhIF0pLCB1cmFudXMpO1xuXHRcdH07XG5cdH0sXG5cblx0WyBTeW1ib2xDb25zdHJ1Y3Rvck5hbWUgXSAoKSB7XG5cdFx0cmV0dXJuIE1ORU1PTklDQTtcblx0fSxcblxuXHRleGNlcHRpb24gKCkge1xuXHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdGhpcy1hbGlhc1xuXHRcdGNvbnN0IHNlbGYgPSB0aGlzO1xuXHRcdHJldHVybiBmdW5jdGlvbiAoZXJyb3I6IEVycm9yLCAuLi5hcmdzOiBhbnlbXSkge1xuXHRcdFx0Y29uc3QgdGFyZ2V0ID0gbmV3LnRhcmdldDtcblx0XHRcdHJldHVybiBleGNlcHRpb25Db25zdHJ1Y3Rvci5jYWxsKHNlbGYsIHRhcmdldCwgZXJyb3IsIC4uLmFyZ3MpO1xuXHRcdH07XG5cdH0sXG5cblx0c2libGluZyAoKSB7XG5cdFx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby10aGlzLWFsaWFzLCBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG5cdFx0Y29uc3Qgc2VsZjogYW55ID0gdGhpcztcblx0XHRjb25zdCBzaWJsaW5ncyA9IChTaWJsaW5nVHlwZU5hbWU6IHN0cmluZykgPT4ge1xuXHRcdFx0Y29uc3Qge1xuXHRcdFx0XHRfX2NvbGxlY3Rpb25fXzogY29sbGVjdGlvbixcblx0XHRcdH0gPSBzZWxmO1xuXHRcdFx0Y29uc3Qgc2libGluZzogYW55ID0gY29sbGVjdGlvblsgU2libGluZ1R5cGVOYW1lIF07XG5cdFx0XHRyZXR1cm4gc2libGluZztcblx0XHR9O1xuXG5cdFx0cmV0dXJuIG5ldyBQcm94eShzaWJsaW5ncywge1xuXHRcdFx0Z2V0IChfLCBwcm9wOiBzdHJpbmcpIHtcblx0XHRcdFx0cmV0dXJuIHNpYmxpbmdzKHByb3ApO1xuXHRcdFx0fSxcblx0XHRcdGFwcGx5IChfLCBfXywgYXJncywpIHtcblx0XHRcdFx0cmV0dXJuIHNpYmxpbmdzKGFyZ3NbIDAgXSk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdH1cblxufTtcblxuY29uc3QgTW5lbW9zeW5lUHJvdG90eXBlS2V5cyA9IE9iamVjdC5rZXlzKE1uZW1vbmljYVByb3RvUHJvcHMpO1xuXG5jb25zdCBNbmVtb25pY2FJbnN0YW5jZVByb3BzID0gW1xuXHQnX19wcm90b19wcm90b19fJyxcblxuXHQnX190eXBlX18nLFxuXHQnX19zZWxmX18nLFxuXG5cdCdfX2FyZ3NfXycsXG5cblx0J19fcGFyZW50X18nLFxuXHQnX19zdWJ0eXBlc19fJyxcblxuXHQnX19zdGFja19fJyxcblxuXHQnX19jb2xsZWN0aW9uX18nLFxuXHQnX190aW1lc3RhbXBfXycsXG5cblx0J19fY3JlYXRvcl9fJ1xuXG5dLmNvbmNhdChNbmVtb3N5bmVQcm90b3R5cGVLZXlzKTtcblxuY29uc3Qgc3RhdGljUHJvcHMgPSBbXG5cblx0Ly8gYnVpbHRpbnM6IGZ1bmN0aW9ucyArIFByb21pc2VzXG5cdCdjb25zdHJ1Y3RvcicsXG5cdCdwcm90b3R5cGUnLFxuXHQndGhlbicsXG5cblx0Ly8gYnVpbHRpbnM6IGVycm9yc1xuXHQnc3RhY2snLFxuXHQnbWVzc2FnZScsXG5cdCdkb21haW4nLFxuXG5cdC8vIGJ1aWx0aW5zOiBFdmVudEVtaXR0ZXJcblx0J29uJyxcblx0J29uY2UnLFxuXHQnb2ZmJyxcblxuXHQvLyBtb2NoYSArIGNoYWkgPT4gYnVnOiAuL3V0aWxzLmpzIC5maW5kU3ViVHlwZUZyb21QYXJlbnQgJ2luc3BlY3QnXG5cdCdpbnNwZWN0Jyxcblx0J3Nob3dEaWZmJyxcblxuXVxuXHQuY29uY2F0KE1uZW1vbmljYUluc3RhbmNlUHJvcHMpXG5cdC5jb25jYXQoT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMoT2JqZWN0LnByb3RvdHlwZSkpXG5cdC5jb25jYXQoT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMoRnVuY3Rpb24ucHJvdG90eXBlKSlcblx0LnJlZHVjZSgob2JqLCBrZXkpID0+IHtcblx0XHRvYmpbIGtleSBdID0gdHJ1ZTtcblx0XHRyZXR1cm4gb2JqO1xuXHR9LCBPYmplY3QuY3JlYXRlKG51bGwpKTtcblxuLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBvbmx5LWFycm93LWZ1bmN0aW9uc1xuY29uc3QgbWFrZVN1YlR5cGVQcm94eSA9IGZ1bmN0aW9uIChzdWJ0eXBlOiBhbnksIGluaGVyaXRlZEluc3RhbmNlOiBhbnkpIHtcblxuXHRjb25zdCBzdWJ0eXBlUHJveHkgPSBuZXcgUHJveHkoSW5zdGFuY2VDcmVhdG9yLCB7XG5cblx0XHRnZXQgKFRhcmdldCwgX3Byb3ApIHtcblxuXHRcdFx0aWYgKF9wcm9wID09PSBTeW1ib2wuaGFzSW5zdGFuY2UpIHtcblx0XHRcdFx0cmV0dXJuIGdldFR5cGVDaGVja2VyKHN1YnR5cGUuVHlwZU5hbWUpO1xuXHRcdFx0fVxuXG5cdFx0XHRyZXR1cm4gUmVmbGVjdC5nZXQoVGFyZ2V0LCBfcHJvcCk7XG5cblx0XHR9LFxuXG5cdFx0Y29uc3RydWN0IChUYXJnZXQsIF9hcmdzKSB7XG5cdFx0XHRyZXR1cm4gbmV3IFRhcmdldChzdWJ0eXBlLCBpbmhlcml0ZWRJbnN0YW5jZSwgX2FyZ3MpO1xuXHRcdH0sXG5cblx0XHRhcHBseSAoVGFyZ2V0LCB0aGlzQXJnLCBfYXJncykge1xuXG5cdFx0XHRpZiAodGhpc0FyZyA9PT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRcdHRoaXNBcmcgPSBpbmhlcml0ZWRJbnN0YW5jZTtcblx0XHRcdH1cblxuXHRcdFx0Ly8gVE9ETzogaWYgd2Ugd291bGQgbWFrZSBuZXcga2V5d29yZCBvYmxpZ2F0b3J5XG5cdFx0XHQvLyB0aGVuIHdlIHNob3VsZCBhdm9pZCBpdCBoZXJlLCB3aXRoIHRocm93IEVycm9yXG5cblx0XHRcdGxldCBleGlzdGVudEluc3RhbmNlID0gcmVmbGVjdFByaW1pdGl2ZVdyYXBwZXJzKHRoaXNBcmcpO1xuXG5cdFx0XHQvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L2Jhbi10cy1jb21tZW50XG5cdFx0XHQvLyBAdHMtaWdub3JlXG5cdFx0XHRpZiAoIWV4aXN0ZW50SW5zdGFuY2VbIFN5bWJvbEdhaWEgXSkge1xuXHRcdFx0XHRjb25zdCBtbmVtb3N5bmUgPSBuZXcgTW5lbW9zeW5lKG5ldyBHYWlhKGV4aXN0ZW50SW5zdGFuY2UpKTtcblx0XHRcdFx0ZXhpc3RlbnRJbnN0YW5jZSA9IG5ldyBQcm94eShtbmVtb3N5bmUsIHtcblx0XHRcdFx0XHRnZXQgOiBtbmVtb3N5bmVQcm94eUhhbmRsZXJHZXRcblx0XHRcdFx0fSk7XG5cdFx0XHR9XG5cdFx0XHQvLyBlbHNlIGlzIHRoZSBvcmRpbmFyeSB3YXkgZm9yIGFsbCBlbnRpdGllc1xuXG5cdFx0XHRjb25zdCBlbnRpdHkgPSBuZXcgVGFyZ2V0KHN1YnR5cGUsIGV4aXN0ZW50SW5zdGFuY2UsIF9hcmdzKTtcblx0XHRcdHJldHVybiBlbnRpdHk7XG5cdFx0fSxcblxuXHR9KTtcblxuXHRyZXR1cm4gc3VidHlwZVByb3h5O1xufTtcblxuXG5jb25zdCBtbmVtb3N5bmVQcm94eUhhbmRsZXJHZXQgPSAodGFyZ2V0OiBhbnksIHByb3A6IHN0cmluZywgcmVjZWl2ZXI6IGFueSkgPT4ge1xuXG5cdC8vIE5vZGUuanMgMjIgUmVmbGVjdC5nZXQgQmVoYXZpb3VyIENoYW5nZWQgaGVyZVxuXHQvLyBjYXVzZSBzb21ldGhpbmcgZ29uZSB3cm9uZyB3aXRoIHByb3AgYXNzaWdubWVudFxuXHQvLyBzbyBub3cgaWYgd2UgbmVlZCAuc3RhY2ssIHdlIHNob3VsZCBhdm9pZCByZWNlaXZlciBoZXJlXG5cdC8vIG5hdmUgbm90IHlldCBjaGVja2VkIG90aGVyIHN0YXRpY1Byb3BzLFxuXHQvLyBqdXN0IGZpeGVkIHRoaXMgYmVsb3dcblx0Ly8gd2hpbGUgdXNpbmcgY29uZGl0aW9uYWwgZm9yIHN0YXRpY1Byb3BzXG5cdGNvbnN0IHJlc3VsdCA9IFJlZmxlY3QuZ2V0KHRhcmdldCwgcHJvcCwgcmVjZWl2ZXIpO1xuXG5cdGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkge1xuXHRcdHJldHVybiByZXN1bHQ7XG5cdH1cblxuXHRpZiAodHlwZW9mIHByb3AgPT09ICdzeW1ib2wnKSB7XG5cdFx0cmV0dXJuIHJlc3VsdDtcblx0fVxuXG5cdGlmIChzdGF0aWNQcm9wc1sgcHJvcCBdKSB7XG5cdFx0Lypcblx0XHRjb25zdCBtYXlCZVJlc3VsdCA9IFJlZmxlY3QuZ2V0KHRhcmdldCwgcHJvcCk7XG5cdFx0aWYgKG1heUJlUmVzdWx0ICE9PSB1bmRlZmluZWQpIHtcblx0XHRcdHJldHVybiBtYXlCZVJlc3VsdDtcblx0XHR9XG5cdFx0Ki9cblx0XHRyZXR1cm4gcmVzdWx0O1xuXHR9XG5cblx0Ly8gcHJvdG90eXBlIG9mIHByb3h5XG5cdGNvbnN0IGluc3RhbmNlOiBhbnkgPSBSZWZsZWN0LmdldFByb3RvdHlwZU9mKHJlY2VpdmVyKTtcblxuXHRjb25zdCB7XG5cdFx0X190eXBlX186IHtcblx0XHRcdGNvbmZpZzoge1xuXHRcdFx0XHRzdHJpY3RDaGFpblxuXHRcdFx0fSxcblx0XHRcdHN1YnR5cGVzXG5cdFx0fSxcblx0fSA9IGluc3RhbmNlO1xuXG5cdGNvbnN0IHN1YnR5cGUgPSBzdWJ0eXBlcy5oYXMocHJvcCkgP1xuXHRcdHN1YnR5cGVzLmdldChwcm9wKSA6XG5cdFx0c3RyaWN0Q2hhaW4gP1xuXHRcdFx0dW5kZWZpbmVkIDpcblx0XHRcdGZpbmRTdWJUeXBlRnJvbVBhcmVudChpbnN0YW5jZSwgcHJvcCk7XG5cblx0cmV0dXJuIHN1YnR5cGUgPyBtYWtlU3ViVHlwZVByb3h5KHN1YnR5cGUsIHJlY2VpdmVyKSA6IHJlc3VsdDtcbn07XG5cblxuY29uc3QgTW5lbW9zeW5lID0gZnVuY3Rpb24gKGdhaWE6IGFueSkge1xuXG5cdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdGhpcy1hbGlhc1xuXHRjb25zdCBpbnN0YW5jZSA9IHRoaXM7XG5cblx0Y29uc3QgTW5lbW9uaWNhOiBhbnkgPSBmdW5jdGlvbiAodGhpczogYW55KSB7XG5cdFx0b2RwKHRoaXMsIFN5bWJvbENvbnN0cnVjdG9yTmFtZSwge1xuXHRcdFx0Z2V0ICgpIHtcblx0XHRcdFx0cmV0dXJuIE1ORU1PTklDQTtcblx0XHRcdH1cblx0XHR9KTtcblx0fTtcblxuXHRjb25zdCBtbmVtb25pY2EgPSBSZWZsZWN0LmdldFByb3RvdHlwZU9mKGdhaWEpO1xuXG5cdFJlZmxlY3Quc2V0UHJvdG90eXBlT2YoTW5lbW9uaWNhLnByb3RvdHlwZSwgbW5lbW9uaWNhKTtcblxuXHRPYmplY3QuZW50cmllcyhNbmVtb25pY2FQcm90b1Byb3BzKS5mb3JFYWNoKChbIG5hbWUsIG1ldGhvZCBdOiBbc3RyaW5nLCBhbnldKSA9PiB7XG5cdFx0b2RwKE1uZW1vbmljYS5wcm90b3R5cGUsIG5hbWUsIHtcblx0XHRcdGdldCAodGhpczogYW55KSB7XG5cdFx0XHRcdHJldHVybiBtZXRob2QuY2FsbCh0aGlzKTtcblx0XHRcdH1cblx0XHR9KTtcblx0fSk7XG5cblx0T2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhNbmVtb25pY2FQcm90b1Byb3BzKS5mb3JFYWNoKChzeW1ib2w6IHN5bWJvbCkgPT4ge1xuXHRcdG9kcChNbmVtb25pY2EucHJvdG90eXBlLCBzeW1ib2wsIHtcblx0XHRcdGdldCAoKSB7XG5cdFx0XHRcdGNvbnN0IHN5bWJvbE1ldGhvZCA9IFJlZmxlY3QuZ2V0KE1uZW1vbmljYVByb3RvUHJvcHMsIHN5bWJvbCk7XG5cdFx0XHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvYmFuLXRzLWNvbW1lbnRcblx0XHRcdFx0Ly8gQHRzLWlnbm9yZVxuXHRcdFx0XHRyZXR1cm4gc3ltYm9sTWV0aG9kLmNhbGwodGhpcyk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdH0pO1xuXG5cdC8vIGluc3RhbmNlIG9mIHNlbGYgQ29uc3RydWN0b3IgdHlwZVxuXHRvZHAoTW5lbW9uaWNhLnByb3RvdHlwZSwgU3ltYm9sLmhhc0luc3RhbmNlLCB7XG5cdFx0Z2V0ICgpIHtcblx0XHRcdHJldHVybiBnZXRUeXBlQ2hlY2tlcih0aGlzLmNvbnN0cnVjdG9yLm5hbWUpO1xuXHRcdH1cblx0fSk7XG5cblx0b2RwKE1uZW1vbmljYS5wcm90b3R5cGUsIFN5bWJvbEdhaWEsIHtcblx0XHRnZXQgKCkge1xuXHRcdFx0cmV0dXJuIGdhaWE7XG5cdFx0fVxuXHR9KTtcblxuXHRjb25zdCBwcm90byA9IG5ldyBNbmVtb25pY2EoKTtcblxuXHRSZWZsZWN0LnNldFByb3RvdHlwZU9mKGluc3RhbmNlLCBwcm90byk7XG5cblx0VHlwZXNSb290cy5zZXQoaW5zdGFuY2UsIHByb3RvKTtcblxufSBhcyBDb25zdHJ1Y3RvckZ1bmN0aW9uPHR5cGVvZiBNbmVtb25pY2FQcm90b1Byb3BzPjtcblxuY29uc3QgY3JlYXRlTW5lbW9zeW5lID0gZnVuY3Rpb24gKFVyYW51czogdW5rbm93bikge1xuXHQvLyBjb25zdHJ1Y3RzIG5ldyBHYWlhIC0+IG5ldyBNbmVtb3N5bmVcblx0Ly8gdG8gYnVpbGQgdGhlIGZpcnN0IGluc3RhbmNlIGluIGNoYWluXG5cdGNvbnN0IHVyYW51cyA9IHJlZmxlY3RQcmltaXRpdmVXcmFwcGVycyggVXJhbnVzICk7XG5cdGNvbnN0IG1uZW1vc3luZSA9IG5ldyBNbmVtb3N5bmUoIG5ldyBHYWlhKCB1cmFudXMgKSApO1xuXHRjb25zdCBtbmVtb3N5bmVQcm94eSA9IG5ldyBQcm94eSggbW5lbW9zeW5lLCB7XG5cdFx0Z2V0IDogbW5lbW9zeW5lUHJveHlIYW5kbGVyR2V0XG5cdH0gKTtcblxuXHRyZXR1cm4gbW5lbW9zeW5lUHJveHk7XG59O1xuXG5leHBvcnQgZGVmYXVsdCB7XG5cdEdhaWEsXG5cdGdldCBjcmVhdGVNbmVtb3N5bmUgKCkge1xuXHRcdHJldHVybiBjcmVhdGVNbmVtb3N5bmU7XG5cdH0sXG5cdGdldCBNbmVtb3N5bmVQcm90b3R5cGVLZXlzICgpIHtcblx0XHRyZXR1cm4gTW5lbW9zeW5lUHJvdG90eXBlS2V5cztcblx0fSxcblx0Z2V0IFR5cGVzUm9vdHMgKCkge1xuXHRcdHJldHVybiBUeXBlc1Jvb3RzO1xuXHR9XG59O1xuIl19