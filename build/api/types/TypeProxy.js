'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.TypeProxy = void 0;
const utils_1 = require("../utils");
const { checkProto, } = utils_1.default;
const hop_1 = require("../../utils/hop");
const errors_1 = require("../../descriptors/errors");
const { WRONG_TYPE_DEFINITION, } = errors_1.ErrorsTypes;
const Mnemosyne_1 = require("./Mnemosyne");
const { createMnemosyne } = Mnemosyne_1.default;
const InstanceCreator_1 = require("./InstanceCreator");
exports.TypeProxy = function (__type__, Uranus) {
    Object.assign(this, {
        __type__,
        Uranus
    });
    const typeProxy = new Proxy(InstanceCreator_1.InstanceCreator, this);
    return typeProxy;
};
exports.TypeProxy.prototype.get = function (target, prop) {
    const { __type__: type } = this;
    if (prop === 'prototype') {
        return type.proto;
    }
    const propDeclaration = type[prop];
    if (propDeclaration) {
        return propDeclaration;
    }
    if ((0, hop_1.hop)(type, prop)) {
        return propDeclaration;
    }
    if (type.subtypes.has(prop)) {
        return type.subtypes.get(prop);
    }
    return Reflect.get(target, prop);
};
exports.TypeProxy.prototype.set = function (__, name, value) {
    const { __type__: type } = this;
    if (name === 'prototype') {
        checkProto(value);
        Object.assign(type.proto, value);
        return true;
    }
    if (typeof name !== 'string' || !name.length) {
        throw new WRONG_TYPE_DEFINITION('should use non empty string as TypeName');
    }
    if (typeof value !== 'function') {
        throw new WRONG_TYPE_DEFINITION('should use function for type definition');
    }
    const TypeName = name;
    const Constructor = value;
    type.define(TypeName, Constructor);
    return true;
};
exports.TypeProxy.prototype.apply = function (__, Uranus, args) {
    const type = this.__type__;
    let instance = null;
    if (Uranus) {
        const InstanceCreatorProxy = new exports.TypeProxy(type, Uranus);
        instance = new InstanceCreatorProxy(...args);
    }
    else {
        instance = this.construct(null, args);
    }
    return instance;
};
exports.TypeProxy.prototype.construct = function (__, args) {
    const { __type__: type, Uranus } = this;
    const mnemosyneProxy = createMnemosyne(Uranus);
    const instance = new InstanceCreator_1.InstanceCreator(type, mnemosyneProxy, args);
    return instance;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVHlwZVByb3h5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2FwaS90eXBlcy9UeXBlUHJveHkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsWUFBWSxDQUFDOzs7QUFLYixvQ0FBa0M7QUFDbEMsTUFBTSxFQUNMLFVBQVUsR0FDVixHQUFHLGVBQVUsQ0FBQztBQUVmLHlDQUFzQztBQUV0QyxxREFBdUQ7QUFDdkQsTUFBTSxFQUNMLHFCQUFxQixHQUNyQixHQUFHLG9CQUFXLENBQUM7QUFFaEIsMkNBQXFDO0FBQ3JDLE1BQU0sRUFBRSxlQUFlLEVBQUUsR0FBRyxtQkFBVSxDQUFDO0FBRXZDLHVEQUFvRDtBQUl2QyxRQUFBLFNBQVMsR0FBRyxVQUFVLFFBQWEsRUFBRSxNQUFlO0lBQ2hFLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFO1FBQ25CLFFBQVE7UUFDUixNQUFNO0tBQ04sQ0FBQyxDQUFDO0lBQ0gsTUFBTSxTQUFTLEdBQUcsSUFBSSxLQUFLLENBQUMsaUNBQWUsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUNuRCxPQUFPLFNBQVMsQ0FBQztBQUNsQixDQUE2QixDQUFDO0FBRTlCLGlCQUFTLENBQUMsU0FBUyxDQUFDLEdBQUcsR0FBRyxVQUFVLE1BQVcsRUFBRSxJQUFtQjtJQUluRSxNQUFNLEVBQ0wsUUFBUSxFQUFFLElBQUksRUFDZCxHQUFHLElBQUksQ0FBQztJQUtULElBQUksSUFBSSxLQUFLLFdBQVcsRUFBRSxDQUFDO1FBQzFCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQztJQUNuQixDQUFDO0lBRUQsTUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFFLElBQUksQ0FBRSxDQUFDO0lBQ3JDLElBQUksZUFBZSxFQUFFLENBQUM7UUFDckIsT0FBTyxlQUFlLENBQUM7SUFDeEIsQ0FBQztJQUlELElBQUksSUFBQSxTQUFHLEVBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUM7UUFDckIsT0FBTyxlQUFlLENBQUM7SUFDeEIsQ0FBQztJQUdELElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztRQUM3QixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2hDLENBQUM7SUFFRCxPQUFPLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO0FBRWxDLENBQUMsQ0FBQztBQUVGLGlCQUFTLENBQUMsU0FBUyxDQUFDLEdBQUcsR0FBRyxVQUFVLEVBQU8sRUFBRSxJQUFZLEVBQUUsS0FBVTtJQUVwRSxNQUFNLEVBQ0wsUUFBUSxFQUFFLElBQUksRUFDZCxHQUFHLElBQUksQ0FBQztJQUdULElBQUksSUFBSSxLQUFLLFdBQVcsRUFBRSxDQUFDO1FBQzFCLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNsQixNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDakMsT0FBTyxJQUFJLENBQUM7SUFDYixDQUFDO0lBRUQsSUFBSSxPQUFPLElBQUksS0FBSyxRQUFRLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDOUMsTUFBTSxJQUFJLHFCQUFxQixDQUFDLHlDQUF5QyxDQUFDLENBQUM7SUFDNUUsQ0FBQztJQUVELElBQUksT0FBTyxLQUFLLEtBQUssVUFBVSxFQUFFLENBQUM7UUFDakMsTUFBTSxJQUFJLHFCQUFxQixDQUFDLHlDQUF5QyxDQUFDLENBQUM7SUFDNUUsQ0FBQztJQUVELE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQztJQUN0QixNQUFNLFdBQVcsR0FBRyxLQUFLLENBQUM7SUFFMUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDbkMsT0FBTyxJQUFJLENBQUM7QUFFYixDQUFDLENBQUM7QUFHRixpQkFBUyxDQUFDLFNBQVMsQ0FBQyxLQUFLLEdBQUcsVUFBVSxFQUFXLEVBQUUsTUFBZSxFQUFFLElBQWU7SUFDbEYsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQztJQUMzQixJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUM7SUFDcEIsSUFBSSxNQUFNLEVBQUUsQ0FBQztRQUNaLE1BQU0sb0JBQW9CLEdBQUcsSUFBSSxpQkFBUyxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQztRQUN6RCxRQUFRLEdBQUcsSUFBSSxvQkFBb0IsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDO0lBQzlDLENBQUM7U0FBTSxDQUFDO1FBQ1AsUUFBUSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ3ZDLENBQUM7SUFDRCxPQUFPLFFBQVEsQ0FBQztBQUNqQixDQUFDLENBQUM7QUFLRixpQkFBUyxDQUFDLFNBQVMsQ0FBQyxTQUFTLEdBQUcsVUFBVSxFQUFXLEVBQUUsSUFBZTtJQUlyRSxNQUFNLEVBQ0wsUUFBUSxFQUFFLElBQUksRUFDZCxNQUFNLEVBQ04sR0FBRyxJQUFJLENBQUM7SUFFVCxNQUFNLGNBQWMsR0FBRyxlQUFlLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDL0MsTUFBTSxRQUFRLEdBQUcsSUFBSSxpQ0FBZSxDQUFFLElBQUksRUFBRSxjQUFjLEVBQUUsSUFBSSxDQUFFLENBQUM7SUFHbkUsT0FBTyxRQUFRLENBQUM7QUFFakIsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueSAqL1xuJ3VzZSBzdHJpY3QnO1xuXG5pbXBvcnQgeyBDb25zdHJ1Y3RvckZ1bmN0aW9uIH0gZnJvbSAnLi4vLi4vdHlwZXMnO1xuXG5cbmltcG9ydCBUeXBlc1V0aWxzIGZyb20gJy4uL3V0aWxzJztcbmNvbnN0IHtcblx0Y2hlY2tQcm90byxcbn0gPSBUeXBlc1V0aWxzO1xuXG5pbXBvcnQgeyBob3AgfSBmcm9tICcuLi8uLi91dGlscy9ob3AnO1xuXG5pbXBvcnQgeyBFcnJvcnNUeXBlcyB9IGZyb20gJy4uLy4uL2Rlc2NyaXB0b3JzL2Vycm9ycyc7XG5jb25zdCB7XG5cdFdST05HX1RZUEVfREVGSU5JVElPTixcbn0gPSBFcnJvcnNUeXBlcztcblxuaW1wb3J0IG1uZW1vc3luZXMgZnJvbSAnLi9NbmVtb3N5bmUnO1xuY29uc3QgeyBjcmVhdGVNbmVtb3N5bmUgfSA9IG1uZW1vc3luZXM7XG5cbmltcG9ydCB7IEluc3RhbmNlQ3JlYXRvciB9IGZyb20gJy4vSW5zdGFuY2VDcmVhdG9yJztcblxuaW1wb3J0IHsgLyogX2dldFByb3BzLCBQcm9wcywgKi8gVHlwZURlZiB9IGZyb20gJy4vUHJvcHMnO1xuXG5leHBvcnQgY29uc3QgVHlwZVByb3h5ID0gZnVuY3Rpb24gKF9fdHlwZV9fOiBhbnksIFVyYW51czogdW5rbm93bikge1xuXHRPYmplY3QuYXNzaWduKHRoaXMsIHtcblx0XHRfX3R5cGVfXyxcblx0XHRVcmFudXNcblx0fSk7XG5cdGNvbnN0IHR5cGVQcm94eSA9IG5ldyBQcm94eShJbnN0YW5jZUNyZWF0b3IsIHRoaXMpO1xuXHRyZXR1cm4gdHlwZVByb3h5O1xufSBhcyBDb25zdHJ1Y3RvckZ1bmN0aW9uPGFueT47XG5cblR5cGVQcm94eS5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gKHRhcmdldDogYW55LCBwcm9wOiBrZXlvZiBUeXBlRGVmKSB7XG5cblx0Ly8gY29uc3QgcHJvcHMgPSBfZ2V0UHJvcHModGhpcykgYXMgUHJvcHM7XG5cblx0Y29uc3Qge1xuXHRcdF9fdHlwZV9fOiB0eXBlXG5cdH0gPSB0aGlzO1xuXG5cdC8vIHByb3RvdHlwZSBvZiBwcm94eVxuXHQvLyBjb25zdCBpbnN0YW5jZSA9IFJlZmxlY3QuZ2V0UHJvdG90eXBlT2YocmVjZWl2ZXIpO1xuXG5cdGlmIChwcm9wID09PSAncHJvdG90eXBlJykge1xuXHRcdHJldHVybiB0eXBlLnByb3RvO1xuXHR9XG5cblx0Y29uc3QgcHJvcERlY2xhcmF0aW9uID0gdHlwZVsgcHJvcCBdO1xuXHRpZiAocHJvcERlY2xhcmF0aW9uKSB7XG5cdFx0cmV0dXJuIHByb3BEZWNsYXJhdGlvbjtcblx0fVxuXG5cdC8vIHVzZWQgZm9yIGV4aXN0ZW50IHByb3BzIHdpdGggdmFsdWVcblx0Ly8gdW5kZWZpbmVkIHx8IG51bGwgfHwgZmFsc2Vcblx0aWYgKGhvcCh0eXBlLCBwcm9wKSkge1xuXHRcdHJldHVybiBwcm9wRGVjbGFyYXRpb247XG5cdH1cblxuXHQvLyBTb21lVHlwZS5Tb21lU3ViVHlwZVxuXHRpZiAodHlwZS5zdWJ0eXBlcy5oYXMocHJvcCkpIHtcblx0XHRyZXR1cm4gdHlwZS5zdWJ0eXBlcy5nZXQocHJvcCk7XG5cdH1cblxuXHRyZXR1cm4gUmVmbGVjdC5nZXQodGFyZ2V0LCBwcm9wKTtcblxufTtcblxuVHlwZVByb3h5LnByb3RvdHlwZS5zZXQgPSBmdW5jdGlvbiAoX186IGFueSwgbmFtZTogc3RyaW5nLCB2YWx1ZTogYW55KSB7XG5cblx0Y29uc3Qge1xuXHRcdF9fdHlwZV9fOiB0eXBlXG5cdH0gPSB0aGlzO1xuXG5cdC8vIGlzIGFib3V0IHNldHRpbmcgYSBwcm90b3R5cGUgdG8gVHlwZVxuXHRpZiAobmFtZSA9PT0gJ3Byb3RvdHlwZScpIHtcblx0XHRjaGVja1Byb3RvKHZhbHVlKTtcblx0XHRPYmplY3QuYXNzaWduKHR5cGUucHJvdG8sIHZhbHVlKTtcblx0XHRyZXR1cm4gdHJ1ZTtcblx0fVxuXG5cdGlmICh0eXBlb2YgbmFtZSAhPT0gJ3N0cmluZycgfHwgIW5hbWUubGVuZ3RoKSB7XG5cdFx0dGhyb3cgbmV3IFdST05HX1RZUEVfREVGSU5JVElPTignc2hvdWxkIHVzZSBub24gZW1wdHkgc3RyaW5nIGFzIFR5cGVOYW1lJyk7XG5cdH1cblxuXHRpZiAodHlwZW9mIHZhbHVlICE9PSAnZnVuY3Rpb24nKSB7XG5cdFx0dGhyb3cgbmV3IFdST05HX1RZUEVfREVGSU5JVElPTignc2hvdWxkIHVzZSBmdW5jdGlvbiBmb3IgdHlwZSBkZWZpbml0aW9uJyk7XG5cdH1cblxuXHRjb25zdCBUeXBlTmFtZSA9IG5hbWU7XG5cdGNvbnN0IENvbnN0cnVjdG9yID0gdmFsdWU7XG5cblx0dHlwZS5kZWZpbmUoVHlwZU5hbWUsIENvbnN0cnVjdG9yKTtcblx0cmV0dXJuIHRydWU7XG5cbn07XG5cblxuVHlwZVByb3h5LnByb3RvdHlwZS5hcHBseSA9IGZ1bmN0aW9uIChfXzogdW5rbm93biwgVXJhbnVzOiB1bmtub3duLCBhcmdzOiB1bmtub3duW10pIHtcblx0Y29uc3QgdHlwZSA9IHRoaXMuX190eXBlX187XG5cdGxldCBpbnN0YW5jZSA9IG51bGw7XG5cdGlmIChVcmFudXMpIHtcblx0XHRjb25zdCBJbnN0YW5jZUNyZWF0b3JQcm94eSA9IG5ldyBUeXBlUHJveHkodHlwZSwgVXJhbnVzKTtcblx0XHRpbnN0YW5jZSA9IG5ldyBJbnN0YW5jZUNyZWF0b3JQcm94eSguLi5hcmdzKTtcblx0fSBlbHNlIHtcblx0XHRpbnN0YW5jZSA9IHRoaXMuY29uc3RydWN0KG51bGwsIGFyZ3MpO1xuXHR9XG5cdHJldHVybiBpbnN0YW5jZTtcbn07XG5cblxuXG5cblR5cGVQcm94eS5wcm90b3R5cGUuY29uc3RydWN0ID0gZnVuY3Rpb24gKF9fOiB1bmtub3duLCBhcmdzOiB1bmtub3duW10pIHtcblxuXHQvLyBuZXcudGFyZ2V0IGlkIGVxdWFsIHdpdGggdGFyZ2V0IGhlcmVcblxuXHRjb25zdCB7XG5cdFx0X190eXBlX186IHR5cGUsXG5cdFx0VXJhbnVzXG5cdH0gPSB0aGlzO1xuXG5cdGNvbnN0IG1uZW1vc3luZVByb3h5ID0gY3JlYXRlTW5lbW9zeW5lKFVyYW51cyk7XG5cdGNvbnN0IGluc3RhbmNlID0gbmV3IEluc3RhbmNlQ3JlYXRvciggdHlwZSwgbW5lbW9zeW5lUHJveHksIGFyZ3MgKTtcblxuXHQvLyBjb25zdCBpbnN0YW5jZSA9IG5ldyBJbnN0YW5jZUNyZWF0b3IodHlwZSwgbnVsbCwgYXJncyk7XG5cdHJldHVybiBpbnN0YW5jZTtcblxufTtcbiJdfQ==