'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.setProps = exports.getProps = exports._setSelf = exports._getProps = exports._addProps = void 0;
const constants_1 = require("../../constants");
const { odp, } = constants_1.constants;
const __props__ = new WeakMap();
const nativeProps = new Set([
    '__proto_proto__',
    '__args__',
    '__collection__',
    '__subtypes__',
    '__type__',
    '__parent__',
    '__stack__',
    '__creator__',
    '__timestamp__',
    '__self__',
]);
const _addProps = function () {
    const self = this;
    const { type, existentInstance, args, config: { submitStack }, __proto_proto__: proto } = self;
    const { collection, subtypes, } = type;
    const value = Object.create(null);
    odp(value, '__proto_proto__', {
        get() {
            return proto;
        }
    });
    odp(value, '__args__', {
        get() {
            return args;
        }
    });
    odp(value, '__collection__', {
        get() {
            return collection;
        }
    });
    odp(value, '__subtypes__', {
        get() {
            return subtypes;
        }
    });
    odp(value, '__type__', {
        get() {
            return type;
        }
    });
    odp(value, '__parent__', {
        get() {
            return existentInstance;
        }
    });
    if (submitStack) {
        const { stack } = this;
        odp(value, '__stack__', {
            get() {
                return stack.join('\n');
            }
        });
    }
    odp(value, '__creator__', {
        get() {
            return self;
        }
    });
    const timestamp = Date.now();
    odp(value, '__timestamp__', {
        get() {
            return timestamp;
        }
    });
    __props__.set(proto, value);
};
exports._addProps = _addProps;
const isObjectNature = (instance) => {
    if (instance instanceof Object)
        return true;
    if (typeof instance === 'object' && instance != null)
        return true;
    return false;
};
const _getProps = (instance, base) => {
    if (!isObjectNature(instance))
        return undefined;
    const proto = Reflect.getPrototypeOf(instance);
    if (base !== undefined && isObjectNature(base) && isObjectNature(proto) && (base.constructor !== proto.constructor)) {
        return undefined;
    }
    const result = __props__.get(proto);
    if (result === undefined) {
        if (base === undefined) {
            base = instance;
        }
        return (0, exports._getProps)(proto, base);
    }
    return result;
};
exports._getProps = _getProps;
const _setSelf = (instance) => {
    const props = (0, exports._getProps)(instance);
    Object.defineProperty(props, '__self__', {
        get() {
            return instance;
        }
    });
    __props__.set(instance, props);
};
exports._setSelf = _setSelf;
const getProps = (instance) => {
    const props = (0, exports._getProps)(instance);
    if (props) {
        const _additions = __props__.get(props);
        if (_additions instanceof Object) {
            const descriptors = Object.getOwnPropertyDescriptors(props);
            const additions = Object.getOwnPropertyDescriptors(_additions);
            const answer = {};
            Object.defineProperties(answer, additions);
            Object.defineProperties(answer, descriptors);
            return answer;
        }
        else {
            return props;
        }
    }
    return undefined;
};
exports.getProps = getProps;
const setProps = (instance, _values) => {
    const props = (0, exports._getProps)(instance);
    if (props) {
        const values = Object.getOwnPropertyDescriptors(_values);
        const written = [];
        const allowed = {};
        Object.entries(values).forEach(([name, value]) => {
            if (!nativeProps.has(name)) {
                written.push(name);
                Object.defineProperty(allowed, name, value);
            }
        });
        __props__.set(props, allowed);
        return written;
    }
    return false;
};
exports.setProps = setProps;
module.exports = {
    _addProps: exports._addProps,
    _getProps: exports._getProps,
    _setSelf: exports._setSelf,
    getProps: exports.getProps,
    setProps: exports.setProps
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUHJvcHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvYXBpL3R5cGVzL1Byb3BzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQzs7O0FBRWIsK0NBQTRDO0FBRTVDLE1BQU0sRUFDTCxHQUFHLEdBQ0gsR0FBRyxxQkFBUyxDQUFDO0FBRWQsTUFBTSxTQUFTLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztBQUVoQyxNQUFNLFdBQVcsR0FBRyxJQUFJLEdBQUcsQ0FBQztJQUMzQixpQkFBaUI7SUFDakIsVUFBVTtJQUNWLGdCQUFnQjtJQUNoQixjQUFjO0lBQ2QsVUFBVTtJQUNWLFlBQVk7SUFDWixXQUFXO0lBQ1gsYUFBYTtJQUNiLGVBQWU7SUFDZixVQUFVO0NBQ1YsQ0FBQyxDQUFDO0FBRUksTUFBTSxTQUFTLEdBQUc7SUFHeEIsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDO0lBRWxCLE1BQU0sRUFDTCxJQUFJLEVBQ0osZ0JBQWdCLEVBQ2hCLElBQUksRUFDSixNQUFNLEVBQUUsRUFDUCxXQUFXLEVBQ1gsRUFDRCxlQUFlLEVBQUUsS0FBSyxFQUN0QixHQUFHLElBQUksQ0FBQztJQUVULE1BQU0sRUFDTCxVQUFVLEVBQ1YsUUFBUSxHQUNSLEdBQUcsSUFBSSxDQUFDO0lBRVQsTUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUVsQyxHQUFHLENBQUMsS0FBSyxFQUFFLGlCQUFpQixFQUFFO1FBQzdCLEdBQUc7WUFDRixPQUFPLEtBQUssQ0FBQztRQUNkLENBQUM7S0FDRCxDQUFDLENBQUM7SUFFSCxHQUFHLENBQUMsS0FBSyxFQUFFLFVBQVUsRUFBRTtRQUN0QixHQUFHO1lBQ0YsT0FBTyxJQUFJLENBQUM7UUFDYixDQUFDO0tBQ0QsQ0FBQyxDQUFDO0lBRUgsR0FBRyxDQUFDLEtBQUssRUFBRSxnQkFBZ0IsRUFBRTtRQUM1QixHQUFHO1lBQ0YsT0FBTyxV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LENBQUMsQ0FBQztRQUN6RCxNQUFNLE9BQU8sR0FBYSxFQUFFLENBQUM7UUFDN0IsTUFBTSxPQUFPLEdBQUcsRUFBRSxDQUFDO1FBQ25CLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBRSxJQUFJLEVBQUUsS0FBSyxDQUFFLEVBQUUsRUFBRTtZQUNsRCxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO2dCQUM1QixPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNuQixNQUFNLENBQUMsY0FBYyxDQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDN0MsQ0FBQztRQUNGLENBQUMsQ0FBQyxDQUFDO1FBQ0gsU0FBUyxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDOUIsT0FBTyxPQUFPLENBQUM7SUFDaEIsQ0FBQztJQUNELE9BQU8sS0FBSyxDQUFDO0FBQ2QsQ0FBQyxDQUFDO0FBaEJXLFFBQUEsUUFBUSxZQWdCbkI7QUFFRixNQUFNLENBQUMsT0FBTyxHQUFHO0lBQ2hCLFNBQVMsRUFBVCxpQkFBUztJQUNULFNBQVMsRUFBVCxpQkFBUztJQUNULFFBQVEsRUFBUixnQkFBUTtJQUNSLFFBQVEsRUFBUixnQkFBUTtJQUNSLFFBQVEsRUFBUixnQkFBUTtDQUNSLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmltcG9ydCB7IGNvbnN0YW50cyB9IGZyb20gJy4uLy4uL2NvbnN0YW50cyc7XG5cbmNvbnN0IHtcblx0b2RwLFxufSA9IGNvbnN0YW50cztcblxuY29uc3QgX19wcm9wc19fID0gbmV3IFdlYWtNYXAoKTtcblxuY29uc3QgbmF0aXZlUHJvcHMgPSBuZXcgU2V0KFtcblx0J19fcHJvdG9fcHJvdG9fXycsXG5cdCdfX2FyZ3NfXycsXG5cdCdfX2NvbGxlY3Rpb25fXycsXG5cdCdfX3N1YnR5cGVzX18nLFxuXHQnX190eXBlX18nLFxuXHQnX19wYXJlbnRfXycsXG5cdCdfX3N0YWNrX18nLFxuXHQnX19jcmVhdG9yX18nLFxuXHQnX190aW1lc3RhbXBfXycsXG5cdCdfX3NlbGZfXycsXG5dKTtcblxuZXhwb3J0IGNvbnN0IF9hZGRQcm9wcyA9IGZ1bmN0aW9uICh0aGlzOiBhbnkpOiBhbnkge1xuXG5cdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdGhpcy1hbGlhc1xuXHRjb25zdCBzZWxmID0gdGhpcztcblxuXHRjb25zdCB7XG5cdFx0dHlwZSxcblx0XHRleGlzdGVudEluc3RhbmNlLFxuXHRcdGFyZ3MsXG5cdFx0Y29uZmlnOiB7XG5cdFx0XHRzdWJtaXRTdGFja1xuXHRcdH0sXG5cdFx0X19wcm90b19wcm90b19fOiBwcm90b1xuXHR9ID0gc2VsZjtcblxuXHRjb25zdCB7XG5cdFx0Y29sbGVjdGlvbixcblx0XHRzdWJ0eXBlcyxcblx0fSA9IHR5cGU7XG5cblx0Y29uc3QgdmFsdWUgPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuXG5cdG9kcCh2YWx1ZSwgJ19fcHJvdG9fcHJvdG9fXycsIHtcblx0XHRnZXQgKCkge1xuXHRcdFx0cmV0dXJuIHByb3RvO1xuXHRcdH1cblx0fSk7XG5cblx0b2RwKHZhbHVlLCAnX19hcmdzX18nLCB7XG5cdFx0Z2V0ICgpIHtcblx0XHRcdHJldHVybiBhcmdzO1xuXHRcdH1cblx0fSk7XG5cblx0b2RwKHZhbHVlLCAnX19jb2xsZWN0aW9uX18nLCB7XG5cdFx0Z2V0ICgpIHtcblx0XHRcdHJldHVybiBjb2xsZWN0aW9uO1xuXHRcdH1cblx0fSk7XG5cblx0b2RwKHZhbHVlLCAnX19zdWJ0eXBlc19fJywge1xuXHRcdGdldCAoKSB7XG5cdFx0XHRyZXR1cm4gc3VidHlwZXM7XG5cdFx0fVxuXHR9KTtcblxuXHRvZHAodmFsdWUsICdfX3R5cGVfXycsIHtcblx0XHRnZXQgKCkge1xuXHRcdFx0cmV0dXJuIHR5cGU7XG5cdFx0fVxuXHR9KTtcblxuXHRvZHAodmFsdWUsICdfX3BhcmVudF9fJywge1xuXHRcdGdldCAoKSB7XG5cdFx0XHRyZXR1cm4gZXhpc3RlbnRJbnN0YW5jZTtcblx0XHR9XG5cdH0pO1xuXG5cdGlmIChzdWJtaXRTdGFjaykge1xuXHRcdGNvbnN0IHsgc3RhY2sgfSA9IHRoaXM7XG5cdFx0b2RwKHZhbHVlLCAnX19zdGFja19fJywge1xuXHRcdFx0Z2V0ICgpIHtcblx0XHRcdFx0cmV0dXJuIHN0YWNrLmpvaW4oJ1xcbicpO1xuXHRcdFx0fVxuXHRcdH0pO1xuXHR9XG5cblx0b2RwKHZhbHVlLCAnX19jcmVhdG9yX18nLCB7XG5cdFx0Z2V0ICgpIHtcblx0XHRcdHJldHVybiBzZWxmO1xuXHRcdH1cblx0fSk7XG5cblx0Y29uc3QgdGltZXN0YW1wID0gRGF0ZS5ub3coKTtcblx0b2RwKHZhbHVlLCAnX190aW1lc3RhbXBfXycsIHtcblx0XHRnZXQgKCkge1xuXHRcdFx0cmV0dXJuIHRpbWVzdGFtcDtcblx0XHR9XG5cdH0pO1xuXG5cdC8vIF9fcHJvcHNfXy5zZXQoc2VsZiwgdmFsdWUpO1xuXHRfX3Byb3BzX18uc2V0KHByb3RvLCB2YWx1ZSk7XG5cbn07XG5cbmV4cG9ydCB0eXBlIENvbGxlY3Rpb25EZWYgPSB7XG5cdGRlZmluZTogQ2FsbGFibGVGdW5jdGlvblxuXHRsb29rdXA6IENhbGxhYmxlRnVuY3Rpb25cblx0aW52b2tlSG9vazogQ2FsbGFibGVGdW5jdGlvblxuXHRyZWdpc3Rlckhvb2s6IENhbGxhYmxlRnVuY3Rpb25cblx0cmVnaXN0ZXJGbG93Q2hlY2tlcjogQ2FsbGFibGVGdW5jdGlvblxuXHRzdWJ0eXBlczogb2JqZWN0XG5cdGhvb2tzOiBvYmplY3Rcblx0W2tleTogc3RyaW5nXTogdW5rbm93blxufVxuLy8gfCBNYXA8c3RyaW5nLCBvYmplY3Q+XG5cbmV4cG9ydCB0eXBlIFR5cGVEZWYgPSB7XG5cdHByb3RvOiBvYmplY3Q7XG5cdGNvbGxlY3Rpb246IENvbGxlY3Rpb25EZWZcblx0aW52b2tlSG9vazogQ2FsbGFibGVGdW5jdGlvblxuXHRjb25maWc6IHtcblx0XHRzdHJpY3RDaGFpbjogYm9vbGVhblxuXHR9XG5cdHN1YnR5cGVzOiBNYXA8c3RyaW5nLCBQcm9wcz5cblx0aXNTdWJUeXBlOiBib29sZWFuXG5cdFR5cGVOYW1lOiBzdHJpbmdcblx0cHJvdG90eXBlOiB1bmtub3duXG5cdHN0YWNrPzogc3RyaW5nXG59O1xuXG5leHBvcnQgdHlwZSBQcm9wcyA9IHtcblx0X19wcm90b19wcm90b19fOiBvYmplY3QsXG5cdF9fYXJnc19fOiB1bmtub3duW10sXG5cdF9fY29sbGVjdGlvbl9fOiBDb2xsZWN0aW9uRGVmLFxuXHRfX3N1YnR5cGVzX186IE1hcDxzdHJpbmcsIG9iamVjdD4sXG5cdF9fdHlwZV9fOiBUeXBlRGVmLFxuXHRfX3BhcmVudF9fOiBQcm9wcyxcblx0X19zdGFja19fPzogc3RyaW5nLFxuXHRfX2NyZWF0b3JfXzogVHlwZURlZixcblx0X190aW1lc3RhbXBfXzogbnVtYmVyLFxuXHRfX3NlbGZfXz86IHtcblx0XHRleHRyYWN0OiBDYWxsYWJsZUZ1bmN0aW9uXG5cdFx0W2tleTogc3RyaW5nXTogdW5rbm93blxuXHR9XG59XG5cbmNvbnN0IGlzT2JqZWN0TmF0dXJlID0gKGluc3RhbmNlOiB1bmtub3duKSA9PiB7XG5cdGlmIChpbnN0YW5jZSBpbnN0YW5jZW9mIE9iamVjdCkgcmV0dXJuIHRydWU7XG5cdGlmICh0eXBlb2YgaW5zdGFuY2UgPT09ICdvYmplY3QnICYmIGluc3RhbmNlICE9IG51bGwpIHJldHVybiB0cnVlO1xuXHRyZXR1cm4gZmFsc2U7XG59O1xuXG5leHBvcnQgY29uc3QgX2dldFByb3BzID0gKGluc3RhbmNlOiBvYmplY3QsIGJhc2U/OiBvYmplY3QpOiBQcm9wcyB8IHVuZGVmaW5lZCA9PiB7XG5cdGlmICghaXNPYmplY3ROYXR1cmUoaW5zdGFuY2UpKSByZXR1cm4gdW5kZWZpbmVkO1xuXHRjb25zdCBwcm90byA9IFJlZmxlY3QuZ2V0UHJvdG90eXBlT2YoaW5zdGFuY2UpIGFzIG9iamVjdDtcblx0aWYgKGJhc2UgIT09IHVuZGVmaW5lZCAmJiBpc09iamVjdE5hdHVyZShiYXNlKSAmJiBpc09iamVjdE5hdHVyZShwcm90bykgJiYgKGJhc2UuY29uc3RydWN0b3IgIT09IHByb3RvLmNvbnN0cnVjdG9yKSkge1xuXHRcdC8vIGhlcmUgd2UgZ290IHJpZCBvZiB1bm5lY2Vzc2FyeSBjaGFpbiBkaXZlXG5cdFx0cmV0dXJuIHVuZGVmaW5lZDtcblx0fVxuXHRjb25zdCByZXN1bHQgPSBfX3Byb3BzX18uZ2V0KHByb3RvKTtcblx0aWYgKHJlc3VsdCA9PT0gdW5kZWZpbmVkKSB7XG5cdFx0Ly8gc28gd2UganVtcGluZyBkZWVwZXIgaGVyZVxuXHRcdGlmIChiYXNlID09PSB1bmRlZmluZWQpIHtcblx0XHRcdGJhc2UgPSBpbnN0YW5jZTtcblx0XHR9XG5cdFx0cmV0dXJuIF9nZXRQcm9wcyhwcm90bywgYmFzZSk7XG5cdH1cblx0cmV0dXJuIHJlc3VsdDtcbn07XG5cbmV4cG9ydCBjb25zdCBfc2V0U2VsZiA9IChpbnN0YW5jZTogb2JqZWN0KTogdm9pZCA9PiB7XG5cdC8vIGNvbnN0IHByb3BzID0gX19wcm9wc19fLmdldChpbnN0YW5jZSk7XG5cdGNvbnN0IHByb3BzID0gX2dldFByb3BzKGluc3RhbmNlKTtcblx0T2JqZWN0LmRlZmluZVByb3BlcnR5KHByb3BzLCAnX19zZWxmX18nLCB7XG5cdFx0Z2V0ICgpIHtcblx0XHRcdHJldHVybiBpbnN0YW5jZTtcblx0XHR9XG5cdH0pO1xuXHRfX3Byb3BzX18uc2V0KGluc3RhbmNlLCBwcm9wcyk7XG59O1xuXG5leHBvcnQgY29uc3QgZ2V0UHJvcHMgPSAoaW5zdGFuY2U6IG9iamVjdCk6IFByb3BzIHwgdW5kZWZpbmVkID0+IHtcblx0Y29uc3QgcHJvcHMgPSBfZ2V0UHJvcHMoaW5zdGFuY2UpO1xuXHRpZiAocHJvcHMpIHtcblx0XHRjb25zdCBfYWRkaXRpb25zID0gX19wcm9wc19fLmdldChwcm9wcyk7XG5cdFx0aWYgKF9hZGRpdGlvbnMgaW5zdGFuY2VvZiBPYmplY3QpIHtcblx0XHRcdGNvbnN0IGRlc2NyaXB0b3JzID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMocHJvcHMpO1xuXHRcdFx0Y29uc3QgYWRkaXRpb25zID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMoX2FkZGl0aW9ucyk7XG5cdFx0XHRjb25zdCBhbnN3ZXIgPSB7fTtcblx0XHRcdE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGFuc3dlciwgYWRkaXRpb25zKTtcblx0XHRcdE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGFuc3dlciwgZGVzY3JpcHRvcnMpO1xuXHRcdFx0cmV0dXJuIGFuc3dlciBhcyBQcm9wcztcblx0XHR9IGVsc2Uge1xuXHRcdFx0cmV0dXJuIHByb3BzO1xuXHRcdH1cblx0fVxuXHRyZXR1cm4gdW5kZWZpbmVkO1xufTtcblxuZXhwb3J0IGNvbnN0IHNldFByb3BzID0gKGluc3RhbmNlOiBvYmplY3QsIF92YWx1ZXM6IG9iamVjdCk6IHN0cmluZ1tdIHwgZmFsc2UgPT4ge1xuXHRjb25zdCBwcm9wcyA9IF9nZXRQcm9wcyhpbnN0YW5jZSk7XG5cdGlmIChwcm9wcykge1xuXHRcdGNvbnN0IHZhbHVlcyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKF92YWx1ZXMpO1xuXHRcdGNvbnN0IHdyaXR0ZW46IHN0cmluZ1tdID0gW107XG5cdFx0Y29uc3QgYWxsb3dlZCA9IHt9O1xuXHRcdE9iamVjdC5lbnRyaWVzKHZhbHVlcykuZm9yRWFjaCgoWyBuYW1lLCB2YWx1ZSBdKSA9PiB7XG5cdFx0XHRpZiAoIW5hdGl2ZVByb3BzLmhhcyhuYW1lKSkge1xuXHRcdFx0XHR3cml0dGVuLnB1c2gobmFtZSk7XG5cdFx0XHRcdE9iamVjdC5kZWZpbmVQcm9wZXJ0eShhbGxvd2VkLCBuYW1lLCB2YWx1ZSk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdFx0X19wcm9wc19fLnNldChwcm9wcywgYWxsb3dlZCk7XG5cdFx0cmV0dXJuIHdyaXR0ZW47XG5cdH1cblx0cmV0dXJuIGZhbHNlO1xufTtcblxubW9kdWxlLmV4cG9ydHMgPSB7XG5cdF9hZGRQcm9wcyxcblx0X2dldFByb3BzLFxuXHRfc2V0U2VsZixcblx0Z2V0UHJvcHMsXG5cdHNldFByb3BzXG59O1xuIl19