'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
const constants_1 = require("../../constants");
const errors_1 = require("../../descriptors/errors");
const utils_1 = require("../../utils");
const { odp, SymbolConstructorName, MNEMONICA, MNEMOSYNE, GAIA, URANUS } = constants_1.constants;
const { WRONG_TYPE_DEFINITION, } = errors_1.ErrorsTypes;
const { collectConstructors } = utils_1.utils;
const Props_1 = require("../types/Props");
const CreationHandler = function (constructionAnswer) {
    if (constructionAnswer instanceof Object) {
        return constructionAnswer;
    }
    return this;
};
const compileNewModificatorFunctionBody_1 = require("../types/compileNewModificatorFunctionBody");
const checkProto = (proto) => {
    if (!(proto instanceof Object)) {
        throw new WRONG_TYPE_DEFINITION('expect prototype to be an object');
    }
};
const getTypeChecker = (TypeName) => {
    const seeker = (instance) => {
        if (typeof instance !== 'object') {
            return false;
        }
        if (!instance.constructor) {
            return false;
        }
        if (Reflect.getPrototypeOf(instance).constructor.name === 'Promise') {
            return instance[SymbolConstructorName] === TypeName;
        }
        const constructors = collectConstructors(instance);
        return constructors[TypeName] || false;
    };
    return seeker;
};
const getTypeSplitPath = (path) => {
    const split = path
        .replace(/\n|\t| /g, '')
        .replace(/\[(\w+)\]/g, '.$1')
        .replace(/^\./, '')
        .split(/\.|\/|:/);
    return split;
};
const getExistentAsyncStack = (existentInstance) => {
    const stack = [];
    let proto = existentInstance;
    while (proto) {
        const props = (0, Props_1._getProps)(proto);
        if (!props.__stack__) {
            break;
        }
        const pstack = props
            .__stack__
            .split('\n')
            .reduce((arr, line) => {
            if (line.length) {
                arr.push(line);
            }
            return arr;
        }, []);
        proto = proto.parent();
        const protoProps = (0, Props_1._getProps)(proto);
        if (proto && protoProps && protoProps.__type__) {
            if (protoProps.__type__.isSubType) {
                stack.push(...pstack.slice(0, 1));
            }
            else {
                stack.push(...pstack);
            }
        }
        else {
            stack.push(...pstack);
            break;
        }
    }
    return stack;
};
const forbiddenNames = [MNEMONICA, MNEMOSYNE, GAIA, URANUS];
const checkTypeName = (name) => {
    if (!name.length) {
        throw new WRONG_TYPE_DEFINITION('TypeName must not be empty');
    }
    if (name[0] !== name[0].toUpperCase()) {
        throw new WRONG_TYPE_DEFINITION('TypeName should start with Uppercase Letter');
    }
    if (forbiddenNames.includes(name)) {
        throw new WRONG_TYPE_DEFINITION('TypeName of reserved keyword');
    }
};
const findSubTypeFromParent = (instance, subType) => {
    let subtype = null;
    const props = (0, Props_1._getProps)(instance);
    if (props.__type__.subtypes.has(subType)) {
        subtype = props.__type__.subtypes.get(subType);
        return subtype;
    }
    return findSubTypeFromParent(props.__parent__, subType);
};
const isClass = (fn) => {
    if (!(fn.prototype instanceof Object)) {
        return false;
    }
    if (fn.prototype.constructor !== fn) {
        return false;
    }
    return Reflect.getOwnPropertyDescriptor(fn, 'prototype').writable === false;
};
const makeFakeModificatorType = (TypeName, fakeModificator = function () { }) => {
    const modificatorBody = (0, compileNewModificatorFunctionBody_1.default)(TypeName);
    const modificatorType = modificatorBody(fakeModificator, CreationHandler, SymbolConstructorName);
    return modificatorType();
};
const reflectPrimitiveWrappers = (_thisArg) => {
    let thisArg = _thisArg;
    if (_thisArg === null) {
        thisArg = Object.create(null);
        odp(thisArg, Symbol.toPrimitive, {
            get() {
                return () => {
                    return _thisArg;
                };
            }
        });
    }
    if (_thisArg instanceof Number ||
        _thisArg instanceof Boolean ||
        _thisArg instanceof String) {
        odp(thisArg, Symbol.toPrimitive, {
            get() {
                return () => {
                    return _thisArg.valueOf();
                };
            }
        });
    }
    return thisArg;
};
const TypesUtils = {
    isClass,
    CreationHandler,
    checkProto,
    getTypeChecker,
    getTypeSplitPath,
    getExistentAsyncStack,
    checkTypeName,
    findSubTypeFromParent,
    makeFakeModificatorType,
    reflectPrimitiveWrappers
};
exports.default = TypesUtils;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvYXBpL3V0aWxzL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQzs7QUFFYiwrQ0FBNEM7QUFDNUMscURBQXVEO0FBQ3ZELHVDQUFvQztBQUVwQyxNQUFNLEVBQ0wsR0FBRyxFQUNILHFCQUFxQixFQUNyQixTQUFTLEVBQ1QsU0FBUyxFQUNULElBQUksRUFDSixNQUFNLEVBQ04sR0FBRyxxQkFBUyxDQUFDO0FBRWQsTUFBTSxFQUNMLHFCQUFxQixHQUNyQixHQUFHLG9CQUFXLENBQUM7QUFFaEIsTUFBTSxFQUNMLG1CQUFtQixFQUNuQixHQUFHLGFBQUssQ0FBQztBQUVWLDBDQUFrRDtBQUdsRCxNQUFNLGVBQWUsR0FBRyxVQUEwQixrQkFBMkI7SUFTNUUsSUFBSyxrQkFBa0IsWUFBWSxNQUFNLEVBQUcsQ0FBQztRQUM1QyxPQUFPLGtCQUFrQixDQUFDO0lBQzNCLENBQUM7SUFDRCxPQUFPLElBQUksQ0FBQztBQUNiLENBQUMsQ0FBQztBQUVGLGtHQUEyRjtBQUUzRixNQUFNLFVBQVUsR0FBRyxDQUFFLEtBQWMsRUFBRyxFQUFFO0lBQ3ZDLElBQUssQ0FBQyxDQUFFLEtBQUssWUFBWSxNQUFNLENBQUUsRUFBRyxDQUFDO1FBQ3BDLE1BQU0sSUFBSSxxQkFBcUIsQ0FBRSxrQ0FBa0MsQ0FBRSxDQUFDO0lBQ3ZFLENBQUM7QUFDRixDQUFDLENBQUM7QUFFRixNQUFNLGNBQWMsR0FBRyxDQUFFLFFBQWdCLEVBQUcsRUFBRTtJQUM3QyxNQUFNLE1BQU0sR0FBWSxDQUFFLFFBQWdCLEVBQUcsRUFBRTtRQUU5QyxJQUFLLE9BQU8sUUFBUSxLQUFLLFFBQVEsRUFBRyxDQUFDO1lBQ3BDLE9BQU8sS0FBSyxDQUFDO1FBQ2QsQ0FBQztRQUdELElBQUssQ0FBQyxRQUFTLENBQUMsV0FBVyxFQUFHLENBQUM7WUFDOUIsT0FBTyxLQUFLLENBQUM7UUFD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cUJBQXFCO0lBQ3JCLHVCQUF1QjtJQUN2Qix3QkFBd0I7Q0FDeEIsQ0FBQztBQUVGLGtCQUFlLFVBQVUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuaW1wb3J0IHsgY29uc3RhbnRzIH0gZnJvbSAnLi4vLi4vY29uc3RhbnRzJztcbmltcG9ydCB7IEVycm9yc1R5cGVzIH0gZnJvbSAnLi4vLi4vZGVzY3JpcHRvcnMvZXJyb3JzJztcbmltcG9ydCB7IHV0aWxzIH0gZnJvbSAnLi4vLi4vdXRpbHMnO1xuXG5jb25zdCB7XG5cdG9kcCxcblx0U3ltYm9sQ29uc3RydWN0b3JOYW1lLFxuXHRNTkVNT05JQ0EsXG5cdE1ORU1PU1lORSxcblx0R0FJQSxcblx0VVJBTlVTXG59ID0gY29uc3RhbnRzO1xuXG5jb25zdCB7XG5cdFdST05HX1RZUEVfREVGSU5JVElPTixcbn0gPSBFcnJvcnNUeXBlcztcblxuY29uc3Qge1xuXHRjb2xsZWN0Q29uc3RydWN0b3JzXG59ID0gdXRpbHM7XG5cbmltcG9ydCB7IF9nZXRQcm9wcywgUHJvcHMgfSBmcm9tICcuLi90eXBlcy9Qcm9wcyc7XG5cblxuY29uc3QgQ3JlYXRpb25IYW5kbGVyID0gZnVuY3Rpb24gKCB0aGlzOiB1bmtub3duLCBjb25zdHJ1Y3Rpb25BbnN3ZXI6IHVua25vd24gKSB7XG5cdC8vIHN0YW5kYXJkIHNheXMgOlxuXHQvLyBpZiBjb25zdHJ1Y3RvciByZXR1cm5zIHNvbWV0aGluZ1xuXHQvLyB0aGVuIHRoaXMgaXMgYSB0b3lcblx0Ly8gd2UgaGF2ZSB0byBwbGF5IHdpdGhcblx0Ly8gcmVzcGVjdGl2ZWx5XG5cdC8vIHNvIHdlIHdpbGwgbm90IGZvbGxvdyB0aGUgcnVsZVxuXHQvLyBpZiAoY29uc3RydWN0aW9uQW5zd2VyIGluc3RhbmNlb2YgdHlwZXNbVHlwZU5hbWVdKSB7XG5cdC8vIGFuZCBpbnN0ZWFkIGZvbGxvdyB0aGUgbGluZSBiZWxvd1xuXHRpZiAoIGNvbnN0cnVjdGlvbkFuc3dlciBpbnN0YW5jZW9mIE9iamVjdCApIHtcblx0XHRyZXR1cm4gY29uc3RydWN0aW9uQW5zd2VyO1xuXHR9XG5cdHJldHVybiB0aGlzO1xufTtcblxuaW1wb3J0IGNvbXBpbGVOZXdNb2RpZmljYXRvckZ1bmN0aW9uQm9keSBmcm9tICcuLi90eXBlcy9jb21waWxlTmV3TW9kaWZpY2F0b3JGdW5jdGlvbkJvZHknO1xuXG5jb25zdCBjaGVja1Byb3RvID0gKCBwcm90bzogdW5rbm93biApID0+IHtcblx0aWYgKCAhKCBwcm90byBpbnN0YW5jZW9mIE9iamVjdCApICkge1xuXHRcdHRocm93IG5ldyBXUk9OR19UWVBFX0RFRklOSVRJT04oICdleHBlY3QgcHJvdG90eXBlIHRvIGJlIGFuIG9iamVjdCcgKTtcblx0fVxufTtcblxuY29uc3QgZ2V0VHlwZUNoZWNrZXIgPSAoIFR5cGVOYW1lOiBzdHJpbmcgKSA9PiB7XG5cdGNvbnN0IHNlZWtlcjogdW5rbm93biA9ICggaW5zdGFuY2U6IG9iamVjdCApID0+IHtcblxuXHRcdGlmICggdHlwZW9mIGluc3RhbmNlICE9PSAnb2JqZWN0JyApIHtcblx0XHRcdHJldHVybiBmYWxzZTtcblx0XHR9XG5cblx0XHQvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLW5vbi1udWxsLWFzc2VydGlvblxuXHRcdGlmICggIWluc3RhbmNlIS5jb25zdHJ1Y3RvciApIHtcblx0XHRcdHJldHVybiBmYWxzZTtcblx0XHR9XG5cdFx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9iYW4tdHMtY29tbWVudFxuXHRcdC8vIEB0cy1pZ25vcmVcblx0XHRpZiAoIFJlZmxlY3QuZ2V0UHJvdG90eXBlT2YoIGluc3RhbmNlICkuY29uc3RydWN0b3IubmFtZSA9PT0gJ1Byb21pc2UnICkge1xuXHRcdFx0Ly8gaWYgKCBpbnN0YW5jZSBpbnN0YW5jZW9mIFByb21pc2UgKSB7XG5cdFx0XHQvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L2Jhbi10cy1jb21tZW50XG5cdFx0XHQvLyBAdHMtaWdub3JlXG5cdFx0XHRyZXR1cm4gaW5zdGFuY2VbIFN5bWJvbENvbnN0cnVjdG9yTmFtZSBdID09PSBUeXBlTmFtZTtcblx0XHR9XG5cblx0XHRjb25zdCBjb25zdHJ1Y3RvcnM6IHtcblx0XHRcdHN0cmluZzogbmV3ICgpID0+IHVua25vd25cblx0XHR9ID0gY29sbGVjdENvbnN0cnVjdG9ycyggaW5zdGFuY2UgKTtcblx0XHQvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L2Jhbi10cy1jb21tZW50XG5cdFx0Ly8gQHRzLWlnbm9yZVxuXHRcdHJldHVybiBjb25zdHJ1Y3RvcnNbIFR5cGVOYW1lIF0gfHwgZmFsc2U7XG5cblx0fTtcblx0cmV0dXJuIHNlZWtlcjtcbn07XG5cbmNvbnN0IGdldFR5cGVTcGxpdFBhdGggPSAoIHBhdGg6IHN0cmluZyApID0+IHtcblx0Y29uc3Qgc3BsaXQgPSBwYXRoXG5cdFx0Ly8gYmVhdXRpZnVsbCBuYW1lc1xuXHRcdC5yZXBsYWNlKCAvXFxufFxcdHwgL2csICcnIClcblx0XHQucmVwbGFjZSggL1xcWyhcXHcrKVxcXS9nLCAnLiQxJyApXG5cdFx0LnJlcGxhY2UoIC9eXFwuLywgJycgKVxuXHRcdC5zcGxpdCggL1xcLnxcXC98Oi8gKTtcblx0cmV0dXJuIHNwbGl0O1xufTtcblxuZXhwb3J0IHR5cGUgYXN5bmNTdGFjayA9IHtcblx0X19zdGFja19fPzogc3RyaW5nXG5cdF9fdHlwZV9fOiB7XG5cdFx0aXNTdWJUeXBlOiBib29sZWFuXG5cdH1cblx0cGFyZW50OiAoKSA9PiBhc3luY1N0YWNrXG59XG5cbmNvbnN0IGdldEV4aXN0ZW50QXN5bmNTdGFjayA9ICggZXhpc3RlbnRJbnN0YW5jZTogYXN5bmNTdGFjayApOiB1bmtub3duID0+IHtcblxuXHRjb25zdCBzdGFjayA9IFtdO1xuXHRsZXQgcHJvdG8gPSBleGlzdGVudEluc3RhbmNlO1xuXG5cdHdoaWxlICggcHJvdG8gKSB7XG5cblx0XHRjb25zdCBwcm9wcyA9IF9nZXRQcm9wcyhwcm90bykgYXMgUHJvcHM7XG5cblx0XHRpZiAoICFwcm9wcy5fX3N0YWNrX18gKSB7XG5cdFx0XHRicmVhaztcblx0XHR9XG5cblx0XHRjb25zdCBwc3RhY2sgPSBwcm9wc1xuXHRcdFx0Ll9fc3RhY2tfX1xuXHRcdFx0LnNwbGl0KCAnXFxuJyApXG5cdFx0XHQucmVkdWNlKCAoIGFycjogc3RyaW5nW10sIGxpbmU6IHN0cmluZyApID0+IHtcblx0XHRcdFx0aWYgKCBsaW5lLmxlbmd0aCApIHtcblx0XHRcdFx0XHRhcnIucHVzaCggbGluZSApO1xuXHRcdFx0XHR9XG5cdFx0XHRcdHJldHVybiBhcnI7XG5cdFx0XHR9LCBbXSApO1xuXG5cdFx0cHJvdG8gPSBwcm90by5wYXJlbnQoKTtcblxuXHRcdGNvbnN0IHByb3RvUHJvcHMgPSBfZ2V0UHJvcHMocHJvdG8pIGFzIFByb3BzO1xuXG5cdFx0aWYgKCBwcm90byAmJiBwcm90b1Byb3BzICYmIHByb3RvUHJvcHMuX190eXBlX18gKSB7XG5cblx0XHRcdGlmICggcHJvdG9Qcm9wcy5fX3R5cGVfXy5pc1N1YlR5cGUgKSB7XG5cdFx0XHRcdHN0YWNrLnB1c2goIC4uLnBzdGFjay5zbGljZSggMCwgMSApICk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRzdGFjay5wdXNoKCAuLi5wc3RhY2sgKTtcblx0XHRcdH1cblxuXHRcdH0gZWxzZSB7XG5cdFx0XHRzdGFjay5wdXNoKCAuLi5wc3RhY2sgKTtcblx0XHRcdGJyZWFrO1xuXHRcdH1cblx0fVxuXG5cdHJldHVybiBzdGFjaztcblxufTtcblxuY29uc3QgZm9yYmlkZGVuTmFtZXMgPSBbIE1ORU1PTklDQSwgTU5FTU9TWU5FLCBHQUlBLCBVUkFOVVMgXTtcblxuY29uc3QgY2hlY2tUeXBlTmFtZSA9ICggbmFtZTogc3RyaW5nICkgPT4ge1xuXG5cdGlmICggIW5hbWUubGVuZ3RoICkge1xuXHRcdHRocm93IG5ldyBXUk9OR19UWVBFX0RFRklOSVRJT04oICdUeXBlTmFtZSBtdXN0IG5vdCBiZSBlbXB0eScgKTtcblx0fVxuXG5cdGlmICggbmFtZVsgMCBdICE9PSBuYW1lWyAwIF0udG9VcHBlckNhc2UoKSApIHtcblx0XHR0aHJvdyBuZXcgV1JPTkdfVFlQRV9ERUZJTklUSU9OKCAnVHlwZU5hbWUgc2hvdWxkIHN0YXJ0IHdpdGggVXBwZXJjYXNlIExldHRlcicgKTtcblx0fVxuXG5cdGlmICggZm9yYmlkZGVuTmFtZXMuaW5jbHVkZXMoIG5hbWUgKSApIHtcblx0XHR0aHJvdyBuZXcgV1JPTkdfVFlQRV9ERUZJTklUSU9OKCAnVHlwZU5hbWUgb2YgcmVzZXJ2ZWQga2V5d29yZCcgKTtcblx0fVxuXG59O1xuXG50eXBlIHBhcmVudFN1YiA9IHtcblx0X190eXBlX186IHtcblx0XHRzdWJ0eXBlczogTWFwPHN0cmluZywgcGFyZW50U3ViPlxuXHR9XG5cdF9fcGFyZW50X186IHBhcmVudFN1YlxufVxuXG5jb25zdCBmaW5kU3ViVHlwZUZyb21QYXJlbnQgPSAoIGluc3RhbmNlOiBwYXJlbnRTdWIsIHN1YlR5cGU6IHN0cmluZyApOiBwYXJlbnRTdWIgfCB1bmRlZmluZWQgPT4ge1xuXHRsZXQgc3VidHlwZSA9IG51bGw7XG5cblx0Ly8gaWYgKCFpbnN0YW5jZS5fX3N1YnR5cGVzX18pIHtcblxuXHQvLyBpZiAoICFpbnN0YW5jZS5fX3R5cGVfXyApIHtcblxuXHQvLyBcdC8vIG1vY2hhICsgY2hhaSBtYWtlcyAuaW5zcGVjdCA0IFNoYXBlciBjbGFzc1xuXHQvLyBcdC8vIG9yIC5zaG93RGlmZiBpZiBzb21ldGhpbmcgd3Jvbmcgd2l0aCBjb25zdHJ1Y3RvclxuXHQvLyBcdC8vIGRlYnVnZ2VyO1xuXHQvLyBcdHJldHVybiBudWxsO1xuXHQvLyB9XG5cblx0Y29uc3QgcHJvcHMgPSBfZ2V0UHJvcHMoaW5zdGFuY2UpIGFzIFByb3BzO1xuXG5cdGlmICggcHJvcHMuX190eXBlX18uc3VidHlwZXMuaGFzKCBzdWJUeXBlICkgKSB7XG5cdFx0c3VidHlwZSA9IHByb3BzLl9fdHlwZV9fLnN1YnR5cGVzLmdldCggc3ViVHlwZSApO1xuXHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvYmFuLXRzLWNvbW1lbnRcblx0XHQvLyBAdHMtaWdub3JlXG5cdFx0cmV0dXJuIHN1YnR5cGU7XG5cdH1cblx0cmV0dXJuIGZpbmRTdWJUeXBlRnJvbVBhcmVudCggcHJvcHMuX19wYXJlbnRfXywgc3ViVHlwZSApO1xufTtcblxuLy8gY29uc3QgaXNDbGFzcyA9ICggZnVuY3Rpb25Qb2ludGVyOiBDYWxsYWJsZUZ1bmN0aW9uICkgPT4ge1xuLy8gXHRjb25zdCB2YWx1ZSA9IEZ1bmN0aW9uLnByb3RvdHlwZS50b1N0cmluZy5jYWxsKCBmdW5jdGlvblBvaW50ZXIgKTtcbi8vIFx0cmV0dXJuIC9eXFxzKmNsYXNzXFxzKy8udGVzdCggdmFsdWUudHJpbSgpICk7XG4vLyB9O1xuXG4vLyBhY2NvcmRpbmdseSB0byB0aGUgZ2lzdCBmcm9tIGhlcmU6XG4vLyBodHRwczovL2dpc3QuZ2l0aHViLmNvbS93ZW50b3V0L2VhM2FmZTljODIyYTZiNmVmMzJmOWU0ZjNlOThiMWJhXG5jb25zdCBpc0NsYXNzID0gKCBmbjogQ2FsbGFibGVGdW5jdGlvbiApID0+IHtcblx0Ly8gbm90IG5lY2Vzc2FyeSB0byBjaGVjayBmbiBmb3IgdHlwZW9mXG5cdC8vIGJlY2F1c2Ugb2Ygb3RoZXIgY2hlY2tzIG1hZGUgYmVmb3JlXG5cdC8vIGlmICh0eXBlb2YgZm4gIT09ICdmdW5jdGlvbicpIHtcblx0Ly8gXHRyZXR1cm4gZmFsc2U7XG5cdC8vIH1cblx0aWYgKCAhKGZuLnByb3RvdHlwZSBpbnN0YW5jZW9mIE9iamVjdCkgKSB7XG5cdFx0cmV0dXJuIGZhbHNlO1xuXHR9XG5cdGlmICggZm4ucHJvdG90eXBlLmNvbnN0cnVjdG9yICE9PSBmbiApIHtcblx0XHRyZXR1cm4gZmFsc2U7XG5cdH1cblx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1ub24tbnVsbC1hc3NlcnRpb25cblx0cmV0dXJuIFJlZmxlY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKCBmbiwgJ3Byb3RvdHlwZScgKSEud3JpdGFibGUgPT09IGZhbHNlO1xufTtcblxuY29uc3QgbWFrZUZha2VNb2RpZmljYXRvclR5cGUgPSAoXG5cdFR5cGVOYW1lOiBzdHJpbmcsXG5cdGZha2VNb2RpZmljYXRvciA9IGZ1bmN0aW9uICgpIHsgfVxuKSA9PiB7XG5cblx0Y29uc3QgbW9kaWZpY2F0b3JCb2R5ID0gY29tcGlsZU5ld01vZGlmaWNhdG9yRnVuY3Rpb25Cb2R5KCBUeXBlTmFtZSApO1xuXG5cdGNvbnN0IG1vZGlmaWNhdG9yVHlwZSA9IG1vZGlmaWNhdG9yQm9keShcblx0XHRmYWtlTW9kaWZpY2F0b3IsXG5cdFx0Q3JlYXRpb25IYW5kbGVyLFxuXHRcdFN5bWJvbENvbnN0cnVjdG9yTmFtZVxuXHQpO1xuXG5cdHJldHVybiBtb2RpZmljYXRvclR5cGUoKTtcblxufTtcblxuY29uc3QgcmVmbGVjdFByaW1pdGl2ZVdyYXBwZXJzID0gKCBfdGhpc0FyZzogdW5rbm93biApID0+IHtcblx0bGV0IHRoaXNBcmcgPSBfdGhpc0FyZztcblxuXHRpZiAoIF90aGlzQXJnID09PSBudWxsICkge1xuXHRcdHRoaXNBcmcgPSBPYmplY3QuY3JlYXRlKCBudWxsICk7XG5cdFx0b2RwKCB0aGlzQXJnLCBTeW1ib2wudG9QcmltaXRpdmUsIHtcblx0XHRcdGdldCAoKSB7XG5cdFx0XHRcdHJldHVybiAoKSA9PiB7XG5cdFx0XHRcdFx0cmV0dXJuIF90aGlzQXJnO1xuXHRcdFx0XHR9O1xuXHRcdFx0fVxuXHRcdH0gKTtcblx0fVxuXG5cdGlmIChcblx0XHRfdGhpc0FyZyBpbnN0YW5jZW9mIE51bWJlciB8fFxuXHRcdF90aGlzQXJnIGluc3RhbmNlb2YgQm9vbGVhbiB8fFxuXHRcdF90aGlzQXJnIGluc3RhbmNlb2YgU3RyaW5nXG5cdCkge1xuXHRcdG9kcCggdGhpc0FyZywgU3ltYm9sLnRvUHJpbWl0aXZlLCB7XG5cdFx0XHRnZXQgKCkge1xuXHRcdFx0XHRyZXR1cm4gKCkgPT4ge1xuXHRcdFx0XHRcdHJldHVybiBfdGhpc0FyZy52YWx1ZU9mKCk7XG5cdFx0XHRcdH07XG5cdFx0XHR9XG5cdFx0fSApO1xuXHR9XG5cblx0cmV0dXJuIHRoaXNBcmc7XG59O1xuXG5jb25zdCBUeXBlc1V0aWxzID0ge1xuXHRpc0NsYXNzLFxuXHRDcmVhdGlvbkhhbmRsZXIsXG5cdGNoZWNrUHJvdG8sXG5cdGdldFR5cGVDaGVja2VyLFxuXHRnZXRUeXBlU3BsaXRQYXRoLFxuXHRnZXRFeGlzdGVudEFzeW5jU3RhY2ssXG5cdGNoZWNrVHlwZU5hbWUsXG5cdGZpbmRTdWJUeXBlRnJvbVBhcmVudCxcblx0bWFrZUZha2VNb2RpZmljYXRvclR5cGUsXG5cdHJlZmxlY3RQcmltaXRpdmVXcmFwcGVyc1xufTtcblxuZXhwb3J0IGRlZmF1bHQgVHlwZXNVdGlscztcbiJdfQ==