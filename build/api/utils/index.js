'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
const constants_1 = require("../../constants");
const errors_1 = require("../../descriptors/errors");
const utils_1 = require("../../utils");
const { odp, SymbolConstructorName, MNEMONICA, MNEMOSYNE, GAIA, URANUS } = constants_1.constants;
const { WRONG_TYPE_DEFINITION, } = errors_1.ErrorsTypes;
const { collectConstructors } = utils_1.utils;
const CreationHandler = function (constructionAnswer) {
    if (constructionAnswer instanceof Object) {
        return constructionAnswer;
    }
    return this;
};
const compileNewModificatorFunctionBody_1 = require("../types/compileNewModificatorFunctionBody");
const checkProto = (proto) => {
    if (!(proto instanceof Object)) {
        throw new WRONG_TYPE_DEFINITION('expect prototype to be an object');
    }
};
const getTypeChecker = (TypeName) => {
    const seeker = (instance) => {
        if (typeof instance !== 'object') {
            return false;
        }
        if (!instance.constructor) {
            return false;
        }
        if (Reflect.getPrototypeOf(instance).constructor.name === 'Promise') {
            return instance[SymbolConstructorName] === TypeName;
        }
        const constructors = collectConstructors(instance);
        return constructors[TypeName] || false;
    };
    return seeker;
};
const getTypeSplitPath = (path) => {
    const split = path
        .replace(/\n|\t| /g, '')
        .replace(/\[(\w+)\]/g, '.$1')
        .replace(/^\./, '')
        .split(/\.|\/|:/);
    return split;
};
const getExistentAsyncStack = (existentInstance) => {
    const stack = [];
    let proto = existentInstance;
    while (proto) {
        if (!proto.__stack__) {
            break;
        }
        const pstack = proto
            .__stack__
            .split('\n')
            .reduce((arr, line) => {
            if (line.length) {
                arr.push(line);
            }
            return arr;
        }, []);
        proto = proto.parent();
        if (proto && proto.__type__) {
            if (proto.__type__.isSubType) {
                stack.push(...pstack.slice(0, 1));
            }
            else {
                stack.push(...pstack);
            }
        }
        else {
            stack.push(...pstack);
            break;
        }
    }
    return stack;
};
const forbiddenNames = [MNEMONICA, MNEMOSYNE, GAIA, URANUS];
const checkTypeName = (name) => {
    if (!name.length) {
        throw new WRONG_TYPE_DEFINITION('TypeName must not be empty');
    }
    if (name[0] !== name[0].toUpperCase()) {
        throw new WRONG_TYPE_DEFINITION('TypeName should start with Uppercase Letter');
    }
    if (forbiddenNames.includes(name)) {
        throw new WRONG_TYPE_DEFINITION('TypeName of reserved keyword');
    }
};
const findSubTypeFromParent = (instance, subType) => {
    let subtype = null;
    if (instance.__type__.subtypes.has(subType)) {
        subtype = instance.__type__.subtypes.get(subType);
        return subtype;
    }
    return findSubTypeFromParent(instance.__parent__, subType);
};
const isClass = (fn) => {
    if (typeof fn.prototype !== 'object') {
        return false;
    }
    if (fn.prototype.constructor !== fn) {
        return false;
    }
    return Reflect.getOwnPropertyDescriptor(fn, 'prototype').writable === false;
};
const makeFakeModificatorType = (TypeName, fakeModificator = function () { }) => {
    const modificatorBody = (0, compileNewModificatorFunctionBody_1.default)(TypeName);
    const modificatorType = modificatorBody(fakeModificator, CreationHandler, SymbolConstructorName);
    return modificatorType();
};
const reflectPrimitiveWrappers = (_thisArg) => {
    let thisArg = _thisArg;
    if (_thisArg === null) {
        thisArg = Object.create(null);
        odp(thisArg, Symbol.toPrimitive, {
            get() {
                return () => {
                    return _thisArg;
                };
            }
        });
    }
    if (_thisArg instanceof Number ||
        _thisArg instanceof Boolean ||
        _thisArg instanceof String) {
        odp(thisArg, Symbol.toPrimitive, {
            get() {
                return () => {
                    return _thisArg.valueOf();
                };
            }
        });
    }
    return thisArg;
};
const TypesUtils = {
    isClass,
    CreationHandler,
    checkProto,
    getTypeChecker,
    getTypeSplitPath,
    getExistentAsyncStack,
    checkTypeName,
    findSubTypeFromParent,
    makeFakeModificatorType,
    reflectPrimitiveWrappers
};
exports.default = TypesUtils;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvYXBpL3V0aWxzL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQzs7QUFFYiwrQ0FBNEM7QUFDNUMscURBQXVEO0FBQ3ZELHVDQUFvQztBQUVwQyxNQUFNLEVBQ0wsR0FBRyxFQUNILHFCQUFxQixFQUNyQixTQUFTLEVBQ1QsU0FBUyxFQUNULElBQUksRUFDSixNQUFNLEVBQ04sR0FBRyxxQkFBUyxDQUFDO0FBRWQsTUFBTSxFQUNMLHFCQUFxQixHQUNyQixHQUFHLG9CQUFXLENBQUM7QUFFaEIsTUFBTSxFQUNMLG1CQUFtQixFQUNuQixHQUFHLGFBQUssQ0FBQztBQUdWLE1BQU0sZUFBZSxHQUFHLFVBQTBCLGtCQUEyQjtJQVM1RSxJQUFLLGtCQUFrQixZQUFZLE1BQU0sRUFBRyxDQUFDO1FBQzVDLE9BQU8sa0JBQWtCLENBQUM7SUFDM0IsQ0FBQztJQUNELE9BQU8sSUFBSSxDQUFDO0FBQ2IsQ0FBQyxDQUFDO0FBRUYsa0dBQTJGO0FBRTNGLE1BQU0sVUFBVSxHQUFHLENBQUUsS0FBYyxFQUFHLEVBQUU7SUFDdkMsSUFBSyxDQUFDLENBQUUsS0FBSyxZQUFZLE1BQU0sQ0FBRSxFQUFHLENBQUM7UUFDcEMsTUFBTSxJQUFJLHFCQUFxQixDQUFFLGtDQUFrQyxDQUFFLENBQUM7SUFDdkUsQ0FBQztBQUNGLENBQUMsQ0FBQztBQUVGLE1BQU0sY0FBYyxHQUFHLENBQUUsUUFBZ0IsRUFBRyxFQUFFO0lBQzdDLE1BQU0sTUFBTSxHQUFZLENBQUUsUUFBZ0IsRUFBRyxFQUFFO1FBRTlDLElBQUssT0FBTyxRQUFRLEtBQUssUUFBUSxFQUFHLENBQUM7WUFDcEMsT0FBTyxLQUFLLENBQUM7UUFDZCxDQUFDO1FBR0QsSUFBSyxDQUFDLFFBQVMsQ0FBQyxXQUFXLEVBQUcsQ0FBQztZQUM5QixPQUFPLEtBQUssQ0FBQztRQUNkLENBQUM7UUFHRCxJ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O0FBRTFCLENBQUMsQ0FBQztBQUVGLE1BQU0sd0JBQXdCLEdBQUcsQ0FBRSxRQUFpQixFQUFHLEVBQUU7SUFDeEQsSUFBSSxPQUFPLEdBQUcsUUFBUSxDQUFDO0lBRXZCLElBQUssUUFBUSxLQUFLLElBQUksRUFBRyxDQUFDO1FBQ3pCLE9BQU8sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFFLElBQUksQ0FBRSxDQUFDO1FBQ2hDLEdBQUcsQ0FBRSxPQUFPLEVBQUUsTUFBTSxDQUFDLFdBQVcsRUFBRTtZQUNqQyxHQUFHO2dCQUNGLE9BQU8sR0FBRyxFQUFFO29CQUNYLE9BQU8sUUFBUSxDQUFDO2dCQUNqQixDQUFDLENBQUM7WUFDSCxDQUFDO1NBQ0QsQ0FBRSxDQUFDO0lBQ0wsQ0FBQztJQUVELElBQ0MsUUFBUSxZQUFZLE1BQU07UUFDMUIsUUFBUSxZQUFZLE9BQU87UUFDM0IsUUFBUSxZQUFZLE1BQU0sRUFDekIsQ0FBQztRQUNGLEdBQUcsQ0FBRSxPQUFPLEVBQUUsTUFBTSxDQUFDLFdBQVcsRUFBRTtZQUNqQyxHQUFHO2dCQUNGLE9BQU8sR0FBRyxFQUFFO29CQUNYLE9BQU8sUUFBUSxDQUFDLE9BQU8sRUFBRSxDQUFDO2dCQUMzQixDQUFDLENBQUM7WUFDSCxDQUFDO1NBQ0QsQ0FBRSxDQUFDO0lBQ0wsQ0FBQztJQUVELE9BQU8sT0FBTyxDQUFDO0FBQ2hCLENBQUMsQ0FBQztBQUVGLE1BQU0sVUFBVSxHQUFHO0lBQ2xCLE9BQU87SUFDUCxlQUFlO0lBQ2YsVUFBVTtJQUNWLGNBQWM7SUFDZCxnQkFBZ0I7SUFDaEIscUJBQXFCO0lBQ3JCLGFBQWE7SUFDYixxQkFBcUI7SUFDckIsdUJBQXVCO0lBQ3ZCLHdCQUF3QjtDQUN4QixDQUFDO0FBRUYsa0JBQWUsVUFBVSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5pbXBvcnQgeyBjb25zdGFudHMgfSBmcm9tICcuLi8uLi9jb25zdGFudHMnO1xuaW1wb3J0IHsgRXJyb3JzVHlwZXMgfSBmcm9tICcuLi8uLi9kZXNjcmlwdG9ycy9lcnJvcnMnO1xuaW1wb3J0IHsgdXRpbHMgfSBmcm9tICcuLi8uLi91dGlscyc7XG5cbmNvbnN0IHtcblx0b2RwLFxuXHRTeW1ib2xDb25zdHJ1Y3Rvck5hbWUsXG5cdE1ORU1PTklDQSxcblx0TU5FTU9TWU5FLFxuXHRHQUlBLFxuXHRVUkFOVVNcbn0gPSBjb25zdGFudHM7XG5cbmNvbnN0IHtcblx0V1JPTkdfVFlQRV9ERUZJTklUSU9OLFxufSA9IEVycm9yc1R5cGVzO1xuXG5jb25zdCB7XG5cdGNvbGxlY3RDb25zdHJ1Y3RvcnNcbn0gPSB1dGlscztcblxuXG5jb25zdCBDcmVhdGlvbkhhbmRsZXIgPSBmdW5jdGlvbiAoIHRoaXM6IHVua25vd24sIGNvbnN0cnVjdGlvbkFuc3dlcjogdW5rbm93biApIHtcblx0Ly8gc3RhbmRhcmQgc2F5cyA6XG5cdC8vIGlmIGNvbnN0cnVjdG9yIHJldHVybnMgc29tZXRoaW5nXG5cdC8vIHRoZW4gdGhpcyBpcyBhIHRveVxuXHQvLyB3ZSBoYXZlIHRvIHBsYXkgd2l0aFxuXHQvLyByZXNwZWN0aXZlbHlcblx0Ly8gc28gd2Ugd2lsbCBub3QgZm9sbG93IHRoZSBydWxlXG5cdC8vIGlmIChjb25zdHJ1Y3Rpb25BbnN3ZXIgaW5zdGFuY2VvZiB0eXBlc1tUeXBlTmFtZV0pIHtcblx0Ly8gYW5kIGluc3RlYWQgZm9sbG93IHRoZSBsaW5lIGJlbG93XG5cdGlmICggY29uc3RydWN0aW9uQW5zd2VyIGluc3RhbmNlb2YgT2JqZWN0ICkge1xuXHRcdHJldHVybiBjb25zdHJ1Y3Rpb25BbnN3ZXI7XG5cdH1cblx0cmV0dXJuIHRoaXM7XG59O1xuXG5pbXBvcnQgY29tcGlsZU5ld01vZGlmaWNhdG9yRnVuY3Rpb25Cb2R5IGZyb20gJy4uL3R5cGVzL2NvbXBpbGVOZXdNb2RpZmljYXRvckZ1bmN0aW9uQm9keSc7XG5cbmNvbnN0IGNoZWNrUHJvdG8gPSAoIHByb3RvOiB1bmtub3duICkgPT4ge1xuXHRpZiAoICEoIHByb3RvIGluc3RhbmNlb2YgT2JqZWN0ICkgKSB7XG5cdFx0dGhyb3cgbmV3IFdST05HX1RZUEVfREVGSU5JVElPTiggJ2V4cGVjdCBwcm90b3R5cGUgdG8gYmUgYW4gb2JqZWN0JyApO1xuXHR9XG59O1xuXG5jb25zdCBnZXRUeXBlQ2hlY2tlciA9ICggVHlwZU5hbWU6IHN0cmluZyApID0+IHtcblx0Y29uc3Qgc2Vla2VyOiB1bmtub3duID0gKCBpbnN0YW5jZTogb2JqZWN0ICkgPT4ge1xuXG5cdFx0aWYgKCB0eXBlb2YgaW5zdGFuY2UgIT09ICdvYmplY3QnICkge1xuXHRcdFx0cmV0dXJuIGZhbHNlO1xuXHRcdH1cblxuXHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tbm9uLW51bGwtYXNzZXJ0aW9uXG5cdFx0aWYgKCAhaW5zdGFuY2UhLmNvbnN0cnVjdG9yICkge1xuXHRcdFx0cmV0dXJuIGZhbHNlO1xuXHRcdH1cblx0XHQvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L2Jhbi10cy1jb21tZW50XG5cdFx0Ly8gQHRzLWlnbm9yZVxuXHRcdGlmICggUmVmbGVjdC5nZXRQcm90b3R5cGVPZiggaW5zdGFuY2UgKS5jb25zdHJ1Y3Rvci5uYW1lID09PSAnUHJvbWlzZScgKSB7XG5cdFx0XHQvLyBpZiAoIGluc3RhbmNlIGluc3RhbmNlb2YgUHJvbWlzZSApIHtcblx0XHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvYmFuLXRzLWNvbW1lbnRcblx0XHRcdC8vIEB0cy1pZ25vcmVcblx0XHRcdHJldHVybiBpbnN0YW5jZVsgU3ltYm9sQ29uc3RydWN0b3JOYW1lIF0gPT09IFR5cGVOYW1lO1xuXHRcdH1cblxuXHRcdGNvbnN0IGNvbnN0cnVjdG9yczoge1xuXHRcdFx0c3RyaW5nOiBuZXcgKCkgPT4gdW5rbm93blxuXHRcdH0gPSBjb2xsZWN0Q29uc3RydWN0b3JzKCBpbnN0YW5jZSApO1xuXHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvYmFuLXRzLWNvbW1lbnRcblx0XHQvLyBAdHMtaWdub3JlXG5cdFx0cmV0dXJuIGNvbnN0cnVjdG9yc1sgVHlwZU5hbWUgXSB8fCBmYWxzZTtcblxuXHR9O1xuXHRyZXR1cm4gc2Vla2VyO1xufTtcblxuY29uc3QgZ2V0VHlwZVNwbGl0UGF0aCA9ICggcGF0aDogc3RyaW5nICkgPT4ge1xuXHRjb25zdCBzcGxpdCA9IHBhdGhcblx0XHQvLyBiZWF1dGlmdWxsIG5hbWVzXG5cdFx0LnJlcGxhY2UoIC9cXG58XFx0fCAvZywgJycgKVxuXHRcdC5yZXBsYWNlKCAvXFxbKFxcdyspXFxdL2csICcuJDEnIClcblx0XHQucmVwbGFjZSggL15cXC4vLCAnJyApXG5cdFx0LnNwbGl0KCAvXFwufFxcL3w6LyApO1xuXHRyZXR1cm4gc3BsaXQ7XG59O1xuXG5leHBvcnQgdHlwZSBhc3luY1N0YWNrID0ge1xuXHRfX3N0YWNrX18/OiBzdHJpbmdcblx0X190eXBlX186IHtcblx0XHRpc1N1YlR5cGU6IGJvb2xlYW5cblx0fVxuXHRwYXJlbnQ6ICgpID0+IGFzeW5jU3RhY2tcbn1cblxuY29uc3QgZ2V0RXhpc3RlbnRBc3luY1N0YWNrID0gKCBleGlzdGVudEluc3RhbmNlOiBhc3luY1N0YWNrICk6IHVua25vd24gPT4ge1xuXG5cdGNvbnN0IHN0YWNrID0gW107XG5cdGxldCBwcm90byA9IGV4aXN0ZW50SW5zdGFuY2U7XG5cblx0d2hpbGUgKCBwcm90byApIHtcblxuXHRcdGlmICggIXByb3RvLl9fc3RhY2tfXyApIHtcblx0XHRcdGJyZWFrO1xuXHRcdH1cblxuXHRcdGNvbnN0IHBzdGFjayA9IHByb3RvXG5cdFx0XHQuX19zdGFja19fXG5cdFx0XHQuc3BsaXQoICdcXG4nIClcblx0XHRcdC5yZWR1Y2UoICggYXJyOiBzdHJpbmdbXSwgbGluZTogc3RyaW5nICkgPT4ge1xuXHRcdFx0XHRpZiAoIGxpbmUubGVuZ3RoICkge1xuXHRcdFx0XHRcdGFyci5wdXNoKCBsaW5lICk7XG5cdFx0XHRcdH1cblx0XHRcdFx0cmV0dXJuIGFycjtcblx0XHRcdH0sIFtdICk7XG5cblx0XHRwcm90byA9IHByb3RvLnBhcmVudCgpO1xuXG5cdFx0aWYgKCBwcm90byAmJiBwcm90by5fX3R5cGVfXyApIHtcblxuXHRcdFx0aWYgKCBwcm90by5fX3R5cGVfXy5pc1N1YlR5cGUgKSB7XG5cdFx0XHRcdHN0YWNrLnB1c2goIC4uLnBzdGFjay5zbGljZSggMCwgMSApICk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRzdGFjay5wdXNoKCAuLi5wc3RhY2sgKTtcblx0XHRcdH1cblxuXHRcdH0gZWxzZSB7XG5cdFx0XHRzdGFjay5wdXNoKCAuLi5wc3RhY2sgKTtcblx0XHRcdGJyZWFrO1xuXHRcdH1cblx0fVxuXG5cdHJldHVybiBzdGFjaztcblxufTtcblxuY29uc3QgZm9yYmlkZGVuTmFtZXMgPSBbIE1ORU1PTklDQSwgTU5FTU9TWU5FLCBHQUlBLCBVUkFOVVMgXTtcblxuY29uc3QgY2hlY2tUeXBlTmFtZSA9ICggbmFtZTogc3RyaW5nICkgPT4ge1xuXG5cdGlmICggIW5hbWUubGVuZ3RoICkge1xuXHRcdHRocm93IG5ldyBXUk9OR19UWVBFX0RFRklOSVRJT04oICdUeXBlTmFtZSBtdXN0IG5vdCBiZSBlbXB0eScgKTtcblx0fVxuXG5cdGlmICggbmFtZVsgMCBdICE9PSBuYW1lWyAwIF0udG9VcHBlckNhc2UoKSApIHtcblx0XHR0aHJvdyBuZXcgV1JPTkdfVFlQRV9ERUZJTklUSU9OKCAnVHlwZU5hbWUgc2hvdWxkIHN0YXJ0IHdpdGggVXBwZXJjYXNlIExldHRlcicgKTtcblx0fVxuXG5cdGlmICggZm9yYmlkZGVuTmFtZXMuaW5jbHVkZXMoIG5hbWUgKSApIHtcblx0XHR0aHJvdyBuZXcgV1JPTkdfVFlQRV9ERUZJTklUSU9OKCAnVHlwZU5hbWUgb2YgcmVzZXJ2ZWQga2V5d29yZCcgKTtcblx0fVxuXG59O1xuXG50eXBlIHBhcmVudFN1YiA9IHtcblx0X190eXBlX186IHtcblx0XHRzdWJ0eXBlczogTWFwPHN0cmluZywgcGFyZW50U3ViPlxuXHR9XG5cdF9fcGFyZW50X186IHBhcmVudFN1YlxufVxuXG5jb25zdCBmaW5kU3ViVHlwZUZyb21QYXJlbnQgPSAoIGluc3RhbmNlOiBwYXJlbnRTdWIsIHN1YlR5cGU6IHN0cmluZyApOiBwYXJlbnRTdWIgPT4ge1xuXHRsZXQgc3VidHlwZSA9IG51bGw7XG5cblx0Ly8gaWYgKCFpbnN0YW5jZS5fX3N1YnR5cGVzX18pIHtcblxuXHQvLyBpZiAoICFpbnN0YW5jZS5fX3R5cGVfXyApIHtcblxuXHQvLyBcdC8vIG1vY2hhICsgY2hhaSBtYWtlcyAuaW5zcGVjdCA0IFNoYXBlciBjbGFzc1xuXHQvLyBcdC8vIG9yIC5zaG93RGlmZiBpZiBzb21ldGhpbmcgd3Jvbmcgd2l0aCBjb25zdHJ1Y3RvclxuXHQvLyBcdC8vIGRlYnVnZ2VyO1xuXHQvLyBcdHJldHVybiBudWxsO1xuXHQvLyB9XG5cblx0aWYgKCBpbnN0YW5jZS5fX3R5cGVfXy5zdWJ0eXBlcy5oYXMoIHN1YlR5cGUgKSApIHtcblx0XHRzdWJ0eXBlID0gaW5zdGFuY2UuX190eXBlX18uc3VidHlwZXMuZ2V0KCBzdWJUeXBlICk7XG5cdFx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9iYW4tdHMtY29tbWVudFxuXHRcdC8vIEB0cy1pZ25vcmVcblx0XHRyZXR1cm4gc3VidHlwZTtcblx0fVxuXHRyZXR1cm4gZmluZFN1YlR5cGVGcm9tUGFyZW50KCBpbnN0YW5jZS5fX3BhcmVudF9fLCBzdWJUeXBlICk7XG59O1xuXG4vLyBjb25zdCBpc0NsYXNzID0gKCBmdW5jdGlvblBvaW50ZXI6IENhbGxhYmxlRnVuY3Rpb24gKSA9PiB7XG4vLyBcdGNvbnN0IHZhbHVlID0gRnVuY3Rpb24ucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoIGZ1bmN0aW9uUG9pbnRlciApO1xuLy8gXHRyZXR1cm4gL15cXHMqY2xhc3NcXHMrLy50ZXN0KCB2YWx1ZS50cmltKCkgKTtcbi8vIH07XG5cbi8vIGFjY29yZGluZ2x5IHRvIHRoZSBnaXN0IGZyb20gaGVyZTpcbi8vIGh0dHBzOi8vZ2lzdC5naXRodWIuY29tL3dlbnRvdXQvZWEzYWZlOWM4MjJhNmI2ZWYzMmY5ZTRmM2U5OGIxYmFcbmNvbnN0IGlzQ2xhc3MgPSAoIGZuOiBDYWxsYWJsZUZ1bmN0aW9uICkgPT4ge1xuXHQvLyBub3QgbmVjZXNzYXJ5IHRvIGNoZWNrIGZuIGZvciB0eXBlb2Zcblx0Ly8gYmVjYXVzZSBvZiBvdGhlciBjaGVja3MgbWFkZSBiZWZvcmVcblx0Ly8gaWYgKHR5cGVvZiBmbiAhPT0gJ2Z1bmN0aW9uJykge1xuXHQvLyBcdHJldHVybiBmYWxzZTtcblx0Ly8gfVxuXHRpZiAoIHR5cGVvZiBmbi5wcm90b3R5cGUgIT09ICdvYmplY3QnICkge1xuXHRcdHJldHVybiBmYWxzZTtcblx0fVxuXHRpZiAoIGZuLnByb3RvdHlwZS5jb25zdHJ1Y3RvciAhPT0gZm4gKSB7XG5cdFx0cmV0dXJuIGZhbHNlO1xuXHR9XG5cdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tbm9uLW51bGwtYXNzZXJ0aW9uXG5cdHJldHVybiBSZWZsZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvciggZm4sICdwcm90b3R5cGUnICkhLndyaXRhYmxlID09PSBmYWxzZTtcbn07XG5cbmNvbnN0IG1ha2VGYWtlTW9kaWZpY2F0b3JUeXBlID0gKFxuXHRUeXBlTmFtZTogc3RyaW5nLFxuXHRmYWtlTW9kaWZpY2F0b3IgPSBmdW5jdGlvbiAoKSB7IH1cbikgPT4ge1xuXG5cdGNvbnN0IG1vZGlmaWNhdG9yQm9keSA9IGNvbXBpbGVOZXdNb2RpZmljYXRvckZ1bmN0aW9uQm9keSggVHlwZU5hbWUgKTtcblxuXHRjb25zdCBtb2RpZmljYXRvclR5cGUgPSBtb2RpZmljYXRvckJvZHkoXG5cdFx0ZmFrZU1vZGlmaWNhdG9yLFxuXHRcdENyZWF0aW9uSGFuZGxlcixcblx0XHRTeW1ib2xDb25zdHJ1Y3Rvck5hbWVcblx0KTtcblxuXHRyZXR1cm4gbW9kaWZpY2F0b3JUeXBlKCk7XG5cbn07XG5cbmNvbnN0IHJlZmxlY3RQcmltaXRpdmVXcmFwcGVycyA9ICggX3RoaXNBcmc6IHVua25vd24gKSA9PiB7XG5cdGxldCB0aGlzQXJnID0gX3RoaXNBcmc7XG5cblx0aWYgKCBfdGhpc0FyZyA9PT0gbnVsbCApIHtcblx0XHR0aGlzQXJnID0gT2JqZWN0LmNyZWF0ZSggbnVsbCApO1xuXHRcdG9kcCggdGhpc0FyZywgU3ltYm9sLnRvUHJpbWl0aXZlLCB7XG5cdFx0XHRnZXQgKCkge1xuXHRcdFx0XHRyZXR1cm4gKCkgPT4ge1xuXHRcdFx0XHRcdHJldHVybiBfdGhpc0FyZztcblx0XHRcdFx0fTtcblx0XHRcdH1cblx0XHR9ICk7XG5cdH1cblxuXHRpZiAoXG5cdFx0X3RoaXNBcmcgaW5zdGFuY2VvZiBOdW1iZXIgfHxcblx0XHRfdGhpc0FyZyBpbnN0YW5jZW9mIEJvb2xlYW4gfHxcblx0XHRfdGhpc0FyZyBpbnN0YW5jZW9mIFN0cmluZ1xuXHQpIHtcblx0XHRvZHAoIHRoaXNBcmcsIFN5bWJvbC50b1ByaW1pdGl2ZSwge1xuXHRcdFx0Z2V0ICgpIHtcblx0XHRcdFx0cmV0dXJuICgpID0+IHtcblx0XHRcdFx0XHRyZXR1cm4gX3RoaXNBcmcudmFsdWVPZigpO1xuXHRcdFx0XHR9O1xuXHRcdFx0fVxuXHRcdH0gKTtcblx0fVxuXG5cdHJldHVybiB0aGlzQXJnO1xufTtcblxuY29uc3QgVHlwZXNVdGlscyA9IHtcblx0aXNDbGFzcyxcblx0Q3JlYXRpb25IYW5kbGVyLFxuXHRjaGVja1Byb3RvLFxuXHRnZXRUeXBlQ2hlY2tlcixcblx0Z2V0VHlwZVNwbGl0UGF0aCxcblx0Z2V0RXhpc3RlbnRBc3luY1N0YWNrLFxuXHRjaGVja1R5cGVOYW1lLFxuXHRmaW5kU3ViVHlwZUZyb21QYXJlbnQsXG5cdG1ha2VGYWtlTW9kaWZpY2F0b3JUeXBlLFxuXHRyZWZsZWN0UHJpbWl0aXZlV3JhcHBlcnNcbn07XG5cbmV4cG9ydCBkZWZhdWx0IFR5cGVzVXRpbHM7XG4iXX0=