'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.throwModificationError = void 0;
const constants_1 = require("../../constants");
const { odp, MNEMONICA, } = constants_1.constants;
const errors_1 = require("../../descriptors/errors");
const { BASE_MNEMONICA_ERROR } = errors_1.ErrorsTypes;
const _1 = require("./");
const utils_1 = require("../utils");
const { makeFakeModificatorType } = utils_1.default;
const utils_2 = require("../../utils");
const { parse, parent, extract } = utils_2.utils;
const InstanceModificator_1 = require("../types/InstanceModificator");
const throwModificationError = function (error) {
    const self = this;
    const { TypeName, type: { stack: typeStack }, args } = self;
    const exceptionReason = error.exceptionReason || error;
    if (error.exceptionReason !== undefined) {
        error.reasons.push(error.exceptionReason);
        error.surplus.push(error);
        throw error;
    }
    odp(error, 'exceptionReason', {
        get() {
            return exceptionReason;
        },
        enumerable: true
    });
    const reasons = [exceptionReason];
    odp(error, 'reasons', {
        get() {
            return reasons;
        },
        enumerable: true
    });
    const surplus = [];
    odp(error, 'surplus', {
        get() {
            return surplus;
        },
        enumerable: true
    });
    self.ModificatorType = makeFakeModificatorType(TypeName);
    self.InstanceModificator = (0, InstanceModificator_1.makeInstanceModificator)(self);
    const erroredInstance = new self.InstanceModificator();
    let errorProto = Reflect.getPrototypeOf(erroredInstance);
    let isMnemonicaInstance = false;
    while (errorProto) {
        const testToProto = Reflect.getPrototypeOf(errorProto);
        if (testToProto !== null && testToProto.constructor.name === MNEMONICA &&
            Object.hasOwnProperty.call(testToProto, 'constructor')) {
            isMnemonicaInstance = true;
            break;
        }
        errorProto = testToProto;
    }
    const result = Reflect.setPrototypeOf(errorProto, error);
    const stack = [];
    if (error instanceof BASE_MNEMONICA_ERROR) {
        stack.push(error.stack);
    }
    else {
        const title = `\n<-- creation of [ ${TypeName} ] traced -->`;
        _1.getStack.call(erroredInstance, title, [], exports.throwModificationError);
        stack.push(...erroredInstance.stack);
        const errorStack = error.stack.split('\n');
        stack.push('<-- with the following error -->');
        errorStack.forEach((line) => {
            if (!stack.includes(line)) {
                stack.push(line);
            }
        });
        stack.push('\n<-- of constructor definitions stack -->');
        stack.push(...typeStack);
    }
    const erroredInstanceStack = (0, _1.cleanupStack)(stack).join('\n');
    odp(erroredInstance, 'stack', {
        get() {
            return erroredInstanceStack;
        }
    });
    self.inheritedInstance = erroredInstance;
    if (result) {
        if (isMnemonicaInstance) {
            const results = self.invokePostHooks();
            const { type, collection, } = results;
            if (type.has(true) || collection.has(true)) {
                return;
            }
        }
        odp(erroredInstance, 'args', {
            get() {
                return args;
            }
        });
        odp(erroredInstance, 'originalError', {
            get() {
                return error;
            }
        });
        odp(erroredInstance, 'instance', {
            get() {
                return erroredInstance;
            }
        });
        odp(erroredInstance, 'extract', {
            get() {
                return () => {
                    const _parent = parent(erroredInstance);
                    return extract(_parent);
                };
            }
        });
        odp(erroredInstance, 'parse', {
            get() {
                return () => {
                    return parse(erroredInstance);
                };
            }
        });
    }
    throw erroredInstance;
};
exports.throwModificationError = throwModificationError;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGhyb3dNb2RpZmljYXRpb25FcnJvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9hcGkvZXJyb3JzL3Rocm93TW9kaWZpY2F0aW9uRXJyb3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7QUFFYiwrQ0FBNEM7QUFDNUMsTUFBTSxFQUNMLEdBQUcsRUFDSCxTQUFTLEdBQ1QsR0FBRyxxQkFBUyxDQUFDO0FBR2QscURBQXVEO0FBQ3ZELE1BQU0sRUFDTCxvQkFBb0IsRUFDcEIsR0FBRyxvQkFBVyxDQUFDO0FBRWhCLHlCQUE0QztBQUU1QyxvQ0FBa0M7QUFDbEMsTUFBTSxFQUNMLHVCQUF1QixFQUN2QixHQUFHLGVBQVUsQ0FBQztBQUVmLHVDQUFvQztBQUNwQyxNQUFNLEVBQ0wsS0FBSyxFQUNMLE1BQU0sRUFDTixPQUFPLEVBQ1AsR0FBRyxhQUFLLENBQUM7QUFFVixzRUFBdUU7QUFFaEUsTUFBTSxzQkFBc0IsR0FBRyxVQUFzQixLQUFVO0lBSXJFLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQztJQUVsQixNQUFNLEVBQ0wsUUFBUSxFQUNSLElBQUksRUFBRSxFQUNMLEtBQUssRUFBRSxTQUFTLEVBQ2hCLEVBQ0QsSUFBSSxFQUNKLEdBQUcsSUFBSSxDQUFDO0lBTVQsTUFBTSxlQUFlLEdBQUcsS0FBSyxDQUFDLGVBQWUsSUFBSSxLQUFLLENBQUM7SUFFdkQsSUFBSyxLQUFLLENBQUMsZUFBZSxLQUFLLFNBQVMsRUFBRyxDQUFDO1FBRTNDLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFFLEtBQUssQ0FBQyxlQUFlLENBQUUsQ0FBQztRQUM1QyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBRSxLQUFLLENBQUUsQ0FBQztRQUU1QixNQUFNLEtBQUssQ0FBQztJQUViLENBQUM7SUFFRCxHQUFHLENBQUUsS0FBSyxFQUFFLGlCQUFpQixFQUFFO1FBQzlCLEdBQUc7WUFDRixPQUFPLGVB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LGVBQWUsQ0FBRSxDQUFDO2dCQUNqQyxDQUFDLENBQUM7WUFDSCxDQUFDO1NBQ0QsQ0FBRSxDQUFDO0lBQ0wsQ0FBQztJQUVELE1BQU0sZUFBZSxDQUFDO0FBRXZCLENBQUMsQ0FBQztBQTdMVyxRQUFBLHNCQUFzQiwwQkE2TGpDIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5pbXBvcnQgeyBjb25zdGFudHMgfSBmcm9tICcuLi8uLi9jb25zdGFudHMnO1xuY29uc3Qge1xuXHRvZHAsXG5cdE1ORU1PTklDQSxcbn0gPSBjb25zdGFudHM7XG5cblxuaW1wb3J0IHsgRXJyb3JzVHlwZXMgfSBmcm9tICcuLi8uLi9kZXNjcmlwdG9ycy9lcnJvcnMnO1xuY29uc3Qge1xuXHRCQVNFX01ORU1PTklDQV9FUlJPUlxufSA9IEVycm9yc1R5cGVzO1xuXG5pbXBvcnQgeyBjbGVhbnVwU3RhY2ssIGdldFN0YWNrIH0gZnJvbSAnLi8nO1xuXG5pbXBvcnQgVHlwZXNVdGlscyBmcm9tICcuLi91dGlscyc7XG5jb25zdCB7XG5cdG1ha2VGYWtlTW9kaWZpY2F0b3JUeXBlXG59ID0gVHlwZXNVdGlscztcblxuaW1wb3J0IHsgdXRpbHMgfSBmcm9tICcuLi8uLi91dGlscyc7XG5jb25zdCB7XG5cdHBhcnNlLFxuXHRwYXJlbnQsXG5cdGV4dHJhY3Rcbn0gPSB1dGlscztcblxuaW1wb3J0IHsgbWFrZUluc3RhbmNlTW9kaWZpY2F0b3IgfSBmcm9tICcuLi90eXBlcy9JbnN0YW5jZU1vZGlmaWNhdG9yJztcblxuZXhwb3J0IGNvbnN0IHRocm93TW9kaWZpY2F0aW9uRXJyb3IgPSBmdW5jdGlvbiAoIHRoaXM6IGFueSwgZXJyb3I6IGFueSApIHtcblxuXHQvLyBJbnN0YW5jZUNyZWF0b3Jcblx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby10aGlzLWFsaWFzXG5cdGNvbnN0IHNlbGYgPSB0aGlzO1xuXG5cdGNvbnN0IHtcblx0XHRUeXBlTmFtZSxcblx0XHR0eXBlOiB7XG5cdFx0XHRzdGFjazogdHlwZVN0YWNrXG5cdFx0fSxcblx0XHRhcmdzXG5cdH0gPSBzZWxmO1xuXG5cdC8vIGlmICggZXJyb3JbIFN5bWJvbENvbnN0cnVjdG9yTmFtZSBdICkge1xuXHQvLyBcdGRlYnVnZ2VyO1xuXHQvLyB9XG5cblx0Y29uc3QgZXhjZXB0aW9uUmVhc29uID0gZXJyb3IuZXhjZXB0aW9uUmVhc29uIHx8IGVycm9yO1xuXG5cdGlmICggZXJyb3IuZXhjZXB0aW9uUmVhc29uICE9PSB1bmRlZmluZWQgKSB7XG5cblx0XHRlcnJvci5yZWFzb25zLnB1c2goIGVycm9yLmV4Y2VwdGlvblJlYXNvbiApO1xuXHRcdGVycm9yLnN1cnBsdXMucHVzaCggZXJyb3IgKTtcblxuXHRcdHRocm93IGVycm9yO1xuXG5cdH1cblxuXHRvZHAoIGVycm9yLCAnZXhjZXB0aW9uUmVhc29uJywge1xuXHRcdGdldCAoKSB7XG5cdFx0XHRyZXR1cm4gZXhjZXB0aW9uUmVhc29uO1xuXHRcdH0sXG5cdFx0ZW51bWVyYWJsZSA6IHRydWVcblx0fSApO1xuXG5cdGNvbnN0IHJlYXNvbnM6IGFueVsgdHlwZW9mIGV4Y2VwdGlvblJlYXNvbiBdID0gWyBleGNlcHRpb25SZWFzb24gXTtcblxuXHRvZHAoIGVycm9yLCAncmVhc29ucycsIHtcblx0XHRnZXQgKCkge1xuXHRcdFx0cmV0dXJuIHJlYXNvbnM7XG5cdFx0fSxcblx0XHRlbnVtZXJhYmxlIDogdHJ1ZVxuXHR9ICk7XG5cdGNvbnN0IHN1cnBsdXM6IGFueVsgdHlwZW9mIGV4Y2VwdGlvblJlYXNvbiBdID0gW107XG5cdG9kcCggZXJyb3IsICdzdXJwbHVzJywge1xuXHRcdGdldCAoKSB7XG5cdFx0XHRyZXR1cm4gc3VycGx1cztcblx0XHR9LFxuXHRcdGVudW1lcmFibGUgOiB0cnVlXG5cdH0gKTtcblxuXHRzZWxmLk1vZGlmaWNhdG9yVHlwZSA9IG1ha2VGYWtlTW9kaWZpY2F0b3JUeXBlKCBUeXBlTmFtZSApO1xuXG5cdHNlbGYuSW5zdGFuY2VNb2RpZmljYXRvciA9IG1ha2VJbnN0YW5jZU1vZGlmaWNhdG9yKCBzZWxmICk7XG5cblx0Ly8gbGV0IGVycm9yZWRJbnN0YW5jZSA9IG5ldyBzZWxmLkluc3RhbmNlTW9kaWZpY2F0b3IoKTtcblx0Y29uc3QgZXJyb3JlZEluc3RhbmNlID0gbmV3IHNlbGYuSW5zdGFuY2VNb2RpZmljYXRvcigpO1xuXG5cdGxldCBlcnJvclByb3RvOiBhbnkgPSBSZWZsZWN0LmdldFByb3RvdHlwZU9mKCBlcnJvcmVkSW5zdGFuY2UgKTtcblx0bGV0IGlzTW5lbW9uaWNhSW5zdGFuY2UgPSBmYWxzZTtcblx0d2hpbGUgKCBlcnJvclByb3RvICkge1xuXHRcdGNvbnN0IHRlc3RUb1Byb3RvID0gUmVmbGVjdC5nZXRQcm90b3R5cGVPZiggZXJyb3JQcm90byApO1xuXHRcdC8vIGlmICh0ZXN0VG9Qcm90byA9PT0gbnVsbCkge1xuXHRcdC8vIFx0YnJlYWs7XG5cdFx0Ly8gfVxuXHRcdC8vIGlmICh0ZXN0VG9Qcm90byA9PT0gT2JqZWN0LnByb3RvdHlwZSkge1xuXHRcdC8vIFx0YnJlYWs7XG5cdFx0Ly8gfVxuXHRcdGlmIChcblx0XHRcdHRlc3RUb1Byb3RvICE9PSBudWxsICYmIHRlc3RUb1Byb3RvLmNvbnN0cnVjdG9yLm5hbWUgPT09IE1ORU1PTklDQSAmJlxuXHRcdFx0T2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwodGVzdFRvUHJvdG8sICdjb25zdHJ1Y3RvcicpXG5cdFx0KSB7XG5cdFx0XHRpc01uZW1vbmljYUluc3RhbmNlID0gdHJ1ZTtcblx0XHRcdGJyZWFrO1xuXHRcdH1cblx0XHRlcnJvclByb3RvID0gdGVzdFRvUHJvdG87XG5cdH1cblxuXHQvLyBSZWZsZWN0LnNldFByb3RvdHlwZU9mKCBlcnJvclByb3RvLCBlcnJvcik7XG5cdGNvbnN0IHJlc3VsdCA9IFJlZmxlY3Quc2V0UHJvdG90eXBlT2YoIGVycm9yUHJvdG8sIGVycm9yKTtcblx0Ly8gbGV0IHJlc3VsdCA9IFJlZmxlY3Quc2V0UHJvdG90eXBlT2YoIGVycm9yUHJvdG8sIGVycm9yKTtcblx0Ly8gaWYgKHJlc3VsdCA9PT0gZmFsc2UpIHtcblx0Ly8gXHRPYmplY3Quc2V0UHJvdG90eXBlT2YoZXJyb3JQcm90bywgZXJyb3IpO1xuXHQvLyBcdC8vIHVucmVhY2hhYmxlXG5cdC8vIFx0cmVzdWx0ID0gdHJ1ZTtcblx0Ly8gfVxuXHQvLyBjb25zb2xlLmxvZyhyZXN1bHQpO1xuXG5cdGNvbnN0IHN0YWNrOiBzdHJpbmdbXSA9IFtdO1xuXG5cdGlmICggZXJyb3IgaW5zdGFuY2VvZiBCQVNFX01ORU1PTklDQV9FUlJPUiApIHtcblxuXHRcdHN0YWNrLnB1c2goIGVycm9yLnN0YWNrICk7XG5cblx0fSBlbHNlIHtcblxuXHRcdGNvbnN0IHRpdGxlID0gYFxcbjwtLSBjcmVhdGlvbiBvZiBbICR7VHlwZU5hbWV9IF0gdHJhY2VkIC0tPmA7XG5cblx0XHRnZXRTdGFjay5jYWxsKCBlcnJvcmVkSW5zdGFuY2UsIHRpdGxlLCBbXSwgdGhyb3dNb2RpZmljYXRpb25FcnJvciApO1xuXG5cdFx0c3RhY2sucHVzaCggLi4uZXJyb3JlZEluc3RhbmNlLnN0YWNrICk7XG5cblx0XHRjb25zdCBlcnJvclN0YWNrID0gZXJyb3Iuc3RhY2suc3BsaXQoICdcXG4nICk7XG5cblx0XHRzdGFjay5wdXNoKCAnPC0tIHdpdGggdGhlIGZvbGxvd2luZyBlcnJvciAtLT4nICk7XG5cblx0XHRlcnJvclN0YWNrLmZvckVhY2goICggbGluZTogc3RyaW5nICkgPT4ge1xuXHRcdFx0aWYgKCAhc3RhY2suaW5jbHVkZXMoIGxpbmUgKSApIHtcblx0XHRcdFx0c3RhY2sucHVzaCggbGluZSApO1xuXHRcdFx0fVxuXHRcdH0gKTtcblxuXHRcdHN0YWNrLnB1c2goICdcXG48LS0gb2YgY29uc3RydWN0b3IgZGVmaW5pdGlvbnMgc3RhY2sgLS0+JyApO1xuXHRcdHN0YWNrLnB1c2goIC4uLnR5cGVTdGFjayApO1xuXG5cdH1cblxuXHRjb25zdCBlcnJvcmVkSW5zdGFuY2VTdGFjayA9IGNsZWFudXBTdGFjayggc3RhY2sgKS5qb2luKCAnXFxuJyApO1xuXG5cdC8vIHN0YXJ0aW5nIGZyb20gTm9kZS5qcyB2MjIgd2Ugc2hvdWxkIGRlZmluZSB0aGlzIHByb3BlcnR5IHRocm91Z2ggb2RwXG5cdC8vIHRoYXQgd2FzIHVubmVjZXNzYXJ5IGZvciB2MjAsIHRob3VnaCBzZWVtcyBuZXcgdjggb3B0aW1pemVkIGNvbXBpbGVyXG5cdC8vIGlzIGdhdGhlcmluZyB2YWx1ZSBmcm9tIGRlZXAgY2hhaW4gYW5kIHdoaWxlIGNvbXBhcmluZyBpdCB3aXRoIFxuXHQvLyBhc3NpZ25tZW50IG9wZXJhdG9yLCB0aGVuIGl0IHdpbGwgbm90IGNyZWF0ZSB0aGlzIHByb3BlcnR5IFxuXHQvLyBzbyB3ZSBuZWVkIGRpcmVjdCBwcm9wZXJ0eSBkZWNsYXJhdGlvbiBoZXJlIC4uLlxuXHRvZHAoIGVycm9yZWRJbnN0YW5jZSwgJ3N0YWNrJywge1xuXHRcdGdldCAoKSB7XG5cdFx0XHRyZXR1cm4gZXJyb3JlZEluc3RhbmNlU3RhY2s7XG5cdFx0fVxuXHR9ICk7XG5cblx0c2VsZi5pbmhlcml0ZWRJbnN0YW5jZSA9IGVycm9yZWRJbnN0YW5jZTtcblxuXHRpZiAocmVzdWx0KSB7XG5cdFx0aWYgKGlzTW5lbW9uaWNhSW5zdGFuY2UpIHtcblxuXHRcdFx0Ly8gaWYgaG9va3MgaGFkIHNvbWUgaW50ZXJjZXB0aW9uOiBzdGFydFxuXHRcdFx0Y29uc3QgcmVzdWx0cyA9IHNlbGYuaW52b2tlUG9zdEhvb2tzKCk7XG5cdFx0XHRjb25zdCB7XG5cdFx0XHRcdHR5cGUsXG5cdFx0XHRcdGNvbGxlY3Rpb24sXG5cdFx0XHR9ID0gcmVzdWx0cztcblx0XHRcdGlmICggdHlwZS5oYXMoIHRydWUgKSB8fCBjb2xsZWN0aW9uLmhhcyggdHJ1ZSApICkge1xuXHRcdFx0XHRyZXR1cm47XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0Ly8gfVxuXG5cdFx0Ly8gaWYgaG9va3MgaGFkIHNvbWUgaW50ZXJjZXB0aW9uOiBzdG9wXG5cblx0XHRvZHAoIGVycm9yZWRJbnN0YW5jZSwgJ2FyZ3MnLCB7XG5cdFx0XHRnZXQgKCkge1xuXHRcdFx0XHRyZXR1cm4gYXJncztcblx0XHRcdH1cblx0XHR9ICk7XG5cblx0XHRvZHAoIGVycm9yZWRJbnN0YW5jZSwgJ29yaWdpbmFsRXJyb3InLCB7XG5cdFx0XHRnZXQgKCkge1xuXHRcdFx0XHRyZXR1cm4gZXJyb3I7XG5cdFx0XHR9XG5cdFx0fSApO1xuXG5cdFx0b2RwKCBlcnJvcmVkSW5zdGFuY2UsICdpbnN0YW5jZScsIHtcblx0XHRcdGdldCAoKSB7XG5cdFx0XHRcdHJldHVybiBlcnJvcmVkSW5zdGFuY2U7XG5cdFx0XHR9XG5cdFx0fSApO1xuXG5cdFx0b2RwKCBlcnJvcmVkSW5zdGFuY2UsICdleHRyYWN0Jywge1xuXHRcdFx0Z2V0ICgpIHtcblx0XHRcdFx0cmV0dXJuICgpID0+IHtcblx0XHRcdFx0XHRjb25zdCBfcGFyZW50ID0gcGFyZW50KGVycm9yZWRJbnN0YW5jZSk7XG5cdFx0XHRcdFx0cmV0dXJuIGV4dHJhY3QoX3BhcmVudCk7XG5cdFx0XHRcdH07XG5cdFx0XHR9XG5cdFx0fSApO1xuXG5cdFx0b2RwKCBlcnJvcmVkSW5zdGFuY2UsICdwYXJzZScsIHtcblx0XHRcdGdldCAoKSB7XG5cdFx0XHRcdHJldHVybiAoKSA9PiB7XG5cdFx0XHRcdFx0cmV0dXJuIHBhcnNlKCBlcnJvcmVkSW5zdGFuY2UgKTtcblx0XHRcdFx0fTtcblx0XHRcdH1cblx0XHR9ICk7XG5cdH1cblxuXHR0aHJvdyBlcnJvcmVkSW5zdGFuY2U7XG5cbn07XG4iXX0=