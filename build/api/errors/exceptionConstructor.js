'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
const constants_1 = require("../../constants");
const { odp } = constants_1.constants;
const errors_1 = require("../../descriptors/errors");
const { WRONG_ARGUMENTS_USED, WRONG_INSTANCE_INVOCATION } = errors_1.ErrorsTypes;
const errors_2 = require("../errors");
const utils_1 = require("../../utils");
const { parse } = utils_1.utils;
const utils_2 = require("../utils");
const { makeFakeModificatorType } = utils_2.default;
const InstanceModificator_1 = require("../types/InstanceModificator");
const checkThrowArgs = (instance, target, error, args) => {
    let wrongThrow;
    if (!target) {
        throw new WRONG_INSTANCE_INVOCATION('exception should be made with new keyword');
    }
    if (!(error instanceof Error)) {
        wrongThrow = new WRONG_ARGUMENTS_USED('error must be instanceof Error');
    }
    if (!(wrongThrow instanceof Error)) {
        return;
    }
    odp(wrongThrow, 'instance', {
        get() {
            return instance;
        }
    });
    odp(wrongThrow, 'error', {
        get() {
            return error;
        }
    });
    odp(wrongThrow, 'args', {
        get() {
            return args;
        }
    });
    throw wrongThrow;
};
const exceptionConsctructHandler = function (opts) {
    const { instance, TypeName, typeStack, args, error } = opts;
    const exception = this;
    odp(exception, 'args', {
        get() {
            return args;
        }
    });
    odp(exception, 'originalError', {
        get() {
            return error;
        }
    });
    odp(exception, 'instance', {
        get() {
            return instance;
        }
    });
    odp(exception, 'extract', {
        get() {
            return () => {
                return instance.extract();
            };
        }
    });
    odp(exception, 'parse', {
        get() {
            return () => {
                return parse(instance);
            };
        }
    });
    const errorStack = exception.stack.split('\n');
    const stack = [];
    const title = `\n<-- lifecycle of [ ${TypeName} ] traced -->`;
    errors_2.getStack.call(exception, title, [], prepareException);
    stack.push(...exception.stack);
    stack.push('<-- with the following error -->');
    errorStack.forEach((line) => {
        if (!stack.includes(line)) {
            stack.push(line);
        }
    });
    stack.push('\n<-- of constructor definitions stack -->');
    stack.push(...typeStack);
    const exceptionStack = (0, errors_2.cleanupStack)(stack).join('\n');
    odp(exception, 'stack', {
        get() {
            return exceptionStack;
        }
    });
    return exception;
};
const prepareException = function (target, error, ...args) {
    const instance = this;
    checkThrowArgs(instance, target, error, args);
    const { __type__, __creator__ } = instance;
    const { stack: typeStack, TypeName } = __type__;
    const ExceptionCreator = Object.create(__creator__);
    ExceptionCreator.config = Object.assign({}, __creator__.config);
    ExceptionCreator.config.blockErrors = false;
    ExceptionCreator.existentInstance = error;
    ExceptionCreator.ModificatorType = makeFakeModificatorType(TypeName, function () {
        return exceptionConsctructHandler.call(this, {
            instance,
            TypeName,
            typeStack,
            args,
            error
        });
    });
    ExceptionCreator.InstanceModificator = (0, InstanceModificator_1.makeInstanceModificator)(ExceptionCreator);
    return new ExceptionCreator.InstanceModificator();
};
exports.default = prepareException;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhjZXB0aW9uQ29uc3RydWN0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvYXBpL2Vycm9ycy9leGNlcHRpb25Db25zdHJ1Y3Rvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7O0FBRWIsK0NBQTRDO0FBQzVDLE1BQU0sRUFBRSxHQUFHLEVBQUUsR0FBRyxxQkFBUyxDQUFDO0FBRTFCLHFEQUF1RDtBQUN2RCxNQUFNLEVBQ0wsb0JBQW9CLEVBQ3BCLHlCQUF5QixFQUN6QixHQUFHLG9CQUFXLENBQUM7QUFFaEIsc0NBQW1EO0FBRW5ELHVDQUFvQztBQUNwQyxNQUFNLEVBQ0wsS0FBSyxFQUNMLEdBQUcsYUFBSyxDQUFDO0FBRVYsb0NBQWtDO0FBRWxDLE1BQU0sRUFDTCx1QkFBdUIsRUFDdkIsR0FBRyxlQUFVLENBQUM7QUFFZixzRUFBdUU7QUFFdkUsTUFBTSxjQUFjLEdBQUcsQ0FBRSxRQUFhLEVBQUUsTUFBVyxFQUFFLEtBQVksRUFBRSxJQUFXLEVBQUcsRUFBRTtJQUVsRixJQUFJLFVBQVUsQ0FBQztJQVdmLElBQUssQ0FBQyxNQUFNLEVBQUcsQ0FBQztRQUNmLE1BQU0sSUFBSSx5QkFBeUIsQ0FBRSwyQ0FBMkMsQ0FBRSxDQUFDO0lBQ3BGLENBQUM7SUFFRCxJQUFLLENBQUMsQ0FBRSxLQUFLLFlBQVksS0FBSyxDQUFFLEVBQUcsQ0FBQztRQUNuQyxVQUFVLEdBQUcsSUFBSSxvQkFBb0IsQ0FBRSxnQ0FBZ0MsQ0FBRSxDQUFDO0lBQzNFLENBQUM7SUFFRCxJQUFLLENBQUMsQ0FBRSxVQUFVLFlBQVksS0FBSyxDQUFFLEVBQUcsQ0FBQztRQUN4QyxPQUFPO0lBQ1IsQ0FBQztJQUVELEdBQUcsQ0FBRSxVQUFVLEVBQUUsVUFBVSxFQUFFO1FBQzVCLEdBQUc7WUFDRixPQUFPLFFBQVEsQ0FBQztRQUNqQixDQUFDO0tBQ0QsQ0FBRSxDQUFDO0lBRUosR0FBRyxDQUFFLFVBQVUsRUFBRSxP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QUUsS0FBSyxFQUFFLElBQUksQ0FBRSxDQUFDO0lBRWhELE1BQU0sRUFDTCxRQUFRLEVBQ1IsV0FBVyxFQUNYLEdBQUcsUUFBUSxDQUFDO0lBR2IsTUFBTSxFQUNMLEtBQUssRUFBRSxTQUFTLEVBQ2hCLFFBQVEsRUFDUixHQUFHLFFBQVEsQ0FBQztJQVViLE1BQU0sZ0JBQWdCLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBRSxXQUFXLENBQUUsQ0FBQztJQUN0RCxnQkFBZ0IsQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBRSxFQUFFLEVBQUUsV0FBVyxDQUFDLE1BQU0sQ0FBRSxDQUFDO0lBQ2xFLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDO0lBRTVDLGdCQUFnQixDQUFDLGdCQUFnQixHQUFHLEtBQUssQ0FBQztJQUUxQyxnQkFBZ0IsQ0FBQyxlQUFlLEdBQUcsdUJBQXVCLENBQUUsUUFBUSxFQUFFO1FBQ3JFLE9BQU8sMEJBQTBCLENBQUMsSUFBSSxDQUFFLElBQUksRUFBRTtZQUM3QyxRQUFRO1lBQ1IsUUFBUTtZQUNSLFNBQVM7WUFDVCxJQUFJO1lBQ0osS0FBSztTQUNMLENBQUUsQ0FBQztJQUNMLENBQUMsQ0FBRSxDQUFDO0lBRUosZ0JBQWdCLENBQUMsbUJBQW1CLEdBQUcsSUFBQSw2Q0FBdUIsRUFBRSxnQkFBZ0IsQ0FBRSxDQUFDO0lBRW5GLE9BQU8sSUFBSSxnQkFBZ0IsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO0FBQ25ELENBQUMsQ0FBQztBQUVGLGtCQUFlLGdCQUFnQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5pbXBvcnQgeyBjb25zdGFudHMgfSBmcm9tICcuLi8uLi9jb25zdGFudHMnO1xuY29uc3QgeyBvZHAgfSA9IGNvbnN0YW50cztcblxuaW1wb3J0IHsgRXJyb3JzVHlwZXMgfSBmcm9tICcuLi8uLi9kZXNjcmlwdG9ycy9lcnJvcnMnO1xuY29uc3Qge1xuXHRXUk9OR19BUkdVTUVOVFNfVVNFRCxcblx0V1JPTkdfSU5TVEFOQ0VfSU5WT0NBVElPTlxufSA9IEVycm9yc1R5cGVzO1xuXG5pbXBvcnQgeyBjbGVhbnVwU3RhY2ssIGdldFN0YWNrIH0gZnJvbSAnLi4vZXJyb3JzJztcblxuaW1wb3J0IHsgdXRpbHMgfSBmcm9tICcuLi8uLi91dGlscyc7XG5jb25zdCB7XG5cdHBhcnNlXG59ID0gdXRpbHM7XG5cbmltcG9ydCBUeXBlc1V0aWxzIGZyb20gJy4uL3V0aWxzJztcblxuY29uc3Qge1xuXHRtYWtlRmFrZU1vZGlmaWNhdG9yVHlwZVxufSA9IFR5cGVzVXRpbHM7XG5cbmltcG9ydCB7IG1ha2VJbnN0YW5jZU1vZGlmaWNhdG9yIH0gZnJvbSAnLi4vdHlwZXMvSW5zdGFuY2VNb2RpZmljYXRvcic7XG5cbmNvbnN0IGNoZWNrVGhyb3dBcmdzID0gKCBpbnN0YW5jZTogYW55LCB0YXJnZXQ6IGFueSwgZXJyb3I6IEVycm9yLCBhcmdzOiBhbnlbXSApID0+IHtcblxuXHRsZXQgd3JvbmdUaHJvdztcblxuXHQvKiB1bnJlYWNoZWJsZSwgY3VzIGluc3RhbmNlIGJvdW5kIGluc2lkZSBvZiBNbmVtb3N5bmVcblx0aWYgKGluc3RhbmNlICE9PSBPYmplY3QoaW5zdGFuY2UpKSB7XG5cdFx0d3JvbmdUaHJvdyA9IG5ldyBXUk9OR19BUkdVTUVOVFNfVVNFRCgnXCJ0aGlzXCIgbXVzdCBiZSBhbiBvYmplY3QnKTtcblx0fVxuXHRpZiAoaW5zdGFuY2UuY29uc3RydWN0b3JbU3ltYm9sQ29uc3RydWN0b3JOYW1lXSAhPT0gaW5zdGFuY2UuY29uc3RydWN0b3IubmFtZSkge1xuXHRcdHdyb25nVGhyb3cgPSBuZXcgV1JPTkdfQVJHVU1FTlRTX1VTRUQoJ1widGhpc1wiIG11c3QgYmUgYW4gb2JqZWN0Jyk7XG5cdH1cblx0Ki9cblxuXHRpZiAoICF0YXJnZXQgKSB7XG5cdFx0dGhyb3cgbmV3IFdST05HX0lOU1RBTkNFX0lOVk9DQVRJT04oICdleGNlcHRpb24gc2hvdWxkIGJlIG1hZGUgd2l0aCBuZXcga2V5d29yZCcgKTtcblx0fVxuXG5cdGlmICggISggZXJyb3IgaW5zdGFuY2VvZiBFcnJvciApICkge1xuXHRcdHdyb25nVGhyb3cgPSBuZXcgV1JPTkdfQVJHVU1FTlRTX1VTRUQoICdlcnJvciBtdXN0IGJlIGluc3RhbmNlb2YgRXJyb3InICk7XG5cdH1cblxuXHRpZiAoICEoIHdyb25nVGhyb3cgaW5zdGFuY2VvZiBFcnJvciApICkge1xuXHRcdHJldHVybjtcblx0fVxuXG5cdG9kcCggd3JvbmdUaHJvdywgJ2luc3RhbmNlJywge1xuXHRcdGdldCAoKSB7XG5cdFx0XHRyZXR1cm4gaW5zdGFuY2U7XG5cdFx0fVxuXHR9ICk7XG5cblx0b2RwKCB3cm9uZ1Rocm93LCAnZXJyb3InLCB7XG5cdFx0Z2V0ICgpIHtcblx0XHRcdHJldHVybiBlcnJvcjtcblx0XHR9XG5cdH0gKTtcblxuXHRvZHAoIHdyb25nVGhyb3csICdhcmdzJywge1xuXHRcdGdldCAoKSB7XG5cdFx0XHRyZXR1cm4gYXJncztcblx0XHR9XG5cdH0gKTtcblxuXHR0aHJvdyB3cm9uZ1Rocm93O1xuXG59O1xuXG5jb25zdCBleGNlcHRpb25Db25zY3RydWN0SGFuZGxlciA9IGZ1bmN0aW9uICggdGhpczogYW55LCBvcHRzOiB7IFsgaW5kZXg6IHN0cmluZyBdOiBhbnkgfSApIHtcblxuXHRjb25zdCB7XG5cdFx0aW5zdGFuY2UsXG5cdFx0VHlwZU5hbWUsXG5cdFx0dHlwZVN0YWNrLFxuXHRcdGFyZ3MsXG5cdFx0ZXJyb3Jcblx0fSA9IG9wdHM7XG5cblxuXHQvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXRoaXMtYWxpYXNcblx0Y29uc3QgZXhjZXB0aW9uID0gdGhpcztcblxuXHRvZHAoIGV4Y2VwdGlvbiwgJ2FyZ3MnLCB7XG5cdFx0Z2V0ICgpIHtcblx0XHRcdHJldHVybiBhcmdzO1xuXHRcdH1cblx0fSApO1xuXG5cdG9kcCggZXhjZXB0aW9uLCAnb3JpZ2luYWxFcnJvcicsIHtcblx0XHRnZXQgKCkge1xuXHRcdFx0cmV0dXJuIGVycm9yO1xuXHRcdH1cblx0fSApO1xuXG5cdG9kcCggZXhjZXB0aW9uLCAnaW5zdGFuY2UnLCB7XG5cdFx0Z2V0ICgpIHtcblx0XHRcdHJldHVybiBpbnN0YW5jZTtcblx0XHR9XG5cdH0gKTtcblxuXHRvZHAoIGV4Y2VwdGlvbiwgJ2V4dHJhY3QnLCB7XG5cdFx0Z2V0ICgpIHtcblx0XHRcdHJldHVybiAoKSA9PiB7XG5cdFx0XHRcdHJldHVybiBpbnN0YW5jZS5leHRyYWN0KCk7XG5cdFx0XHR9O1xuXHRcdH1cblx0fSApO1xuXG5cdG9kcCggZXhjZXB0aW9uLCAncGFyc2UnLCB7XG5cdFx0Z2V0ICgpIHtcblx0XHRcdHJldHVybiAoKSA9PiB7XG5cdFx0XHRcdHJldHVybiBwYXJzZSggaW5zdGFuY2UgKTtcblx0XHRcdH07XG5cdFx0fVxuXHR9ICk7XG5cblx0Ly8gcmVhbCBlcnJvciBzdGFja1xuXHRjb25zdCBlcnJvclN0YWNrID0gZXhjZXB0aW9uLnN0YWNrLnNwbGl0KCAnXFxuJyApO1xuXG5cdGNvbnN0IHN0YWNrOiBzdHJpbmdbXSA9IFtdO1xuXG5cdGNvbnN0IHRpdGxlID0gYFxcbjwtLSBsaWZlY3ljbGUgb2YgWyAke1R5cGVOYW1lfSBdIHRyYWNlZCAtLT5gO1xuXG5cdGdldFN0YWNrLmNhbGwoIGV4Y2VwdGlvbiwgdGl0bGUsIFtdLCBwcmVwYXJlRXhjZXB0aW9uICk7XG5cblx0c3RhY2sucHVzaCggLi4uZXhjZXB0aW9uLnN0YWNrICk7XG5cblx0c3RhY2sucHVzaCggJzwtLSB3aXRoIHRoZSBmb2xsb3dpbmcgZXJyb3IgLS0+JyApO1xuXG5cdGVycm9yU3RhY2suZm9yRWFjaCggKCBsaW5lOiBzdHJpbmcgKSA9PiB7XG5cdFx0aWYgKCAhc3RhY2suaW5jbHVkZXMoIGxpbmUgKSApIHtcblx0XHRcdHN0YWNrLnB1c2goIGxpbmUgKTtcblx0XHR9XG5cdH0gKTtcblxuXHRzdGFjay5wdXNoKCAnXFxuPC0tIG9mIGNvbnN0cnVjdG9yIGRlZmluaXRpb25zIHN0YWNrIC0tPicgKTtcblx0c3RhY2sucHVzaCggLi4udHlwZVN0YWNrICk7XG5cblx0Y29uc3QgZXhjZXB0aW9uU3RhY2sgPSBjbGVhbnVwU3RhY2soIHN0YWNrICkuam9pbiggJ1xcbicgKTtcblxuXHRvZHAoIGV4Y2VwdGlvbiwgJ3N0YWNrJywge1xuXHRcdGdldCAoKSB7XG5cdFx0XHRyZXR1cm4gZXhjZXB0aW9uU3RhY2s7XG5cdFx0fVxuXHR9KTtcblxuXHRyZXR1cm4gZXhjZXB0aW9uO1xuXG5cbn07XG5cbmNvbnN0IHByZXBhcmVFeGNlcHRpb24gPSBmdW5jdGlvbiAoIHRoaXM6IGFueSwgdGFyZ2V0OiBhbnksIGVycm9yOiBFcnJvciwgLi4uYXJnczogYW55W10gKSB7XG5cblx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby10aGlzLWFsaWFzXG5cdGNvbnN0IGluc3RhbmNlID0gdGhpcztcblxuXHRjaGVja1Rocm93QXJncyggaW5zdGFuY2UsIHRhcmdldCwgZXJyb3IsIGFyZ3MgKTtcblxuXHRjb25zdCB7XG5cdFx0X190eXBlX18sXG5cdFx0X19jcmVhdG9yX19cblx0fSA9IGluc3RhbmNlO1xuXG5cblx0Y29uc3Qge1xuXHRcdHN0YWNrOiB0eXBlU3RhY2ssXG5cdFx0VHlwZU5hbWVcblx0fSA9IF9fdHlwZV9fO1xuXG5cdC8qIHNob3J0IHdheSwgbWFrZXMgaG9va3MgY2FsbHMsIHdpbGwgbm90IHVzZVxuXG5cdGNvbnN0IHR5cGUgPSBPYmplY3QuY3JlYXRlKF9fdHlwZV9fKTtcblx0dHlwZS5jb25maWcuYmxvY2tFcnJvcnMgPSBmYWxzZTtcblxuXHRsZXQgZXJyb3JlZCA9IG5ldyBJbnN0YW5jZUNyZWF0b3IodHlwZSwgZXJyb3IsIGFyZ3MpO1xuXHQqL1xuXG5cdGNvbnN0IEV4Y2VwdGlvbkNyZWF0b3IgPSBPYmplY3QuY3JlYXRlKCBfX2NyZWF0b3JfXyApO1xuXHRFeGNlcHRpb25DcmVhdG9yLmNvbmZpZyA9IE9iamVjdC5hc3NpZ24oIHt9LCBfX2NyZWF0b3JfXy5jb25maWcgKTtcblx0RXhjZXB0aW9uQ3JlYXRvci5jb25maWcuYmxvY2tFcnJvcnMgPSBmYWxzZTtcblxuXHRFeGNlcHRpb25DcmVhdG9yLmV4aXN0ZW50SW5zdGFuY2UgPSBlcnJvcjtcblx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXNoYWRvd1xuXHRFeGNlcHRpb25DcmVhdG9yLk1vZGlmaWNhdG9yVHlwZSA9IG1ha2VGYWtlTW9kaWZpY2F0b3JUeXBlKCBUeXBlTmFtZSwgZnVuY3Rpb24gKCB0aGlzOiB1bmtub3duICkge1xuXHRcdHJldHVybiBleGNlcHRpb25Db25zY3RydWN0SGFuZGxlci5jYWxsKCB0aGlzLCB7XG5cdFx0XHRpbnN0YW5jZSxcblx0XHRcdFR5cGVOYW1lLFxuXHRcdFx0dHlwZVN0YWNrLFxuXHRcdFx0YXJncyxcblx0XHRcdGVycm9yXG5cdFx0fSApO1xuXHR9ICk7XG5cblx0RXhjZXB0aW9uQ3JlYXRvci5JbnN0YW5jZU1vZGlmaWNhdG9yID0gbWFrZUluc3RhbmNlTW9kaWZpY2F0b3IoIEV4Y2VwdGlvbkNyZWF0b3IgKTtcblxuXHRyZXR1cm4gbmV3IEV4Y2VwdGlvbkNyZWF0b3IuSW5zdGFuY2VNb2RpZmljYXRvcigpO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgcHJlcGFyZUV4Y2VwdGlvbjtcbiJdfQ==