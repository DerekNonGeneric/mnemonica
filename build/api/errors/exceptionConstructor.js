'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
const constants_1 = require("../../constants");
const { odp } = constants_1.constants;
const errors_1 = require("../../descriptors/errors");
const { WRONG_ARGUMENTS_USED, WRONG_INSTANCE_INVOCATION } = errors_1.ErrorsTypes;
const errors_2 = require("../errors");
const utils_1 = require("../../utils");
const { parse } = utils_1.utils;
const utils_2 = require("../utils");
const { makeFakeModificatorType } = utils_2.default;
const InstanceModificator_1 = require("../types/InstanceModificator");
const addProps_1 = require("../types/addProps");
const checkThrowArgs = (instance, target, error, args) => {
    let wrongThrow;
    if (!target) {
        throw new WRONG_INSTANCE_INVOCATION('exception should be made with new keyword');
    }
    if (!(error instanceof Error)) {
        wrongThrow = new WRONG_ARGUMENTS_USED('error must be instanceof Error');
    }
    if (!(wrongThrow instanceof Error)) {
        return;
    }
    odp(wrongThrow, 'instance', {
        get() {
            return instance;
        }
    });
    odp(wrongThrow, 'error', {
        get() {
            return error;
        }
    });
    odp(wrongThrow, 'args', {
        get() {
            return args;
        }
    });
    throw wrongThrow;
};
const exceptionConsctructHandler = function (opts) {
    const { instance, TypeName, typeStack, args, error } = opts;
    const exception = this;
    odp(exception, 'args', {
        get() {
            return args;
        }
    });
    odp(exception, 'originalError', {
        get() {
            return error;
        }
    });
    odp(exception, 'instance', {
        get() {
            return instance;
        }
    });
    odp(exception, 'extract', {
        get() {
            return () => {
                return instance.extract();
            };
        }
    });
    odp(exception, 'parse', {
        get() {
            return () => {
                return parse(instance);
            };
        }
    });
    const errorStack = exception.stack.split('\n');
    const stack = [];
    const title = `\n<-- lifecycle of [ ${TypeName} ] traced -->`;
    errors_2.getStack.call(exception, title, [], prepareException);
    stack.push(...exception.stack);
    stack.push('<-- with the following error -->');
    errorStack.forEach((line) => {
        if (!stack.includes(line)) {
            stack.push(line);
        }
    });
    stack.push('\n<-- of constructor definitions stack -->');
    stack.push(...typeStack);
    const exceptionStack = (0, errors_2.cleanupStack)(stack).join('\n');
    odp(exception, 'stack', {
        get() {
            return exceptionStack;
        }
    });
    return exception;
};
const prepareException = function (target, error, ...args) {
    const instance = this;
    checkThrowArgs(instance, target, error, args);
    const props = (0, addProps_1.getProps)(instance);
    const { __type__, __creator__ } = props;
    const { stack: typeStack, TypeName } = __type__;
    const ExceptionCreator = Object.create(__creator__);
    ExceptionCreator.config = Object.assign({}, __creator__.config);
    ExceptionCreator.config.blockErrors = false;
    ExceptionCreator.existentInstance = error;
    ExceptionCreator.ModificatorType = makeFakeModificatorType(TypeName, function () {
        return exceptionConsctructHandler.call(this, {
            instance,
            TypeName,
            typeStack,
            args,
            error
        });
    });
    ExceptionCreator.InstanceModificator = (0, InstanceModificator_1.makeInstanceModificator)(ExceptionCreator);
    return new ExceptionCreator.InstanceModificator();
};
exports.default = prepareException;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhjZXB0aW9uQ29uc3RydWN0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvYXBpL2Vycm9ycy9leGNlcHRpb25Db25zdHJ1Y3Rvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7O0FBRWIsK0NBQTRDO0FBQzVDLE1BQU0sRUFBRSxHQUFHLEVBQUUsR0FBRyxxQkFBUyxDQUFDO0FBRTFCLHFEQUF1RDtBQUN2RCxNQUFNLEVBQ0wsb0JBQW9CLEVBQ3BCLHlCQUF5QixFQUN6QixHQUFHLG9CQUFXLENBQUM7QUFFaEIsc0NBQW1EO0FBRW5ELHVDQUFvQztBQUNwQyxNQUFNLEVBQ0wsS0FBSyxFQUNMLEdBQUcsYUFBSyxDQUFDO0FBRVYsb0NBQWtDO0FBRWxDLE1BQU0sRUFDTCx1QkFBdUIsRUFDdkIsR0FBRyxlQUFVLENBQUM7QUFFZixzRUFBdUU7QUFFdkUsZ0RBQW9EO0FBRXBELE1BQU0sY0FBYyxHQUFHLENBQUUsUUFBYSxFQUFFLE1BQVcsRUFBRSxLQUFZLEVBQUUsSUFBVyxFQUFHLEVBQUU7SUFFbEYsSUFBSSxVQUFVLENBQUM7SUFXZixJQUFLLENBQUMsTUFBTSxFQUFHLENBQUM7UUFDZixNQUFNLElBQUkseUJBQXlCLENBQUUsMkNBQTJDLENBQUUsQ0FBQztJQUNwRixDQUFDO0lBRUQsSUFBSyxDQUFDLENBQUUsS0FBSyxZQUFZLEtBQUssQ0FBRSxFQUFHLENBQUM7UUFDbkMsVUFBVSxHQUFHLElBQUksb0JBQW9CLENBQUUsZ0NBQWdDLENBQUUsQ0FBQztJQUMzRSxDQUFDO0lBRUQsSUFBSyxDQUFDLENBQUUsVUFBVSxZQUFZLEtBQUssQ0FBRSxFQUFHLENBQUM7UUFDeEMsT0FBTztJQUNSLENBQUM7SUFFRCxHQUFHLENBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRTtRQUM1QixHQUFHO1lBQ0YsT0FBTyxRQUFRLENBQUM7UUFDakIsQ0FBQztLQUNELENBQUUsQ0FBQztJQUVKLEdBQUcsQ0FBRSxVQUFVLEVBQUUsT0FBTyxFQUFFO1FBQ3pCLEdBQUc7WUFDRixPQUFPLEtBQUssQ0FBQztRQUNkLENBQUM7S0FDRCxDQUFFLENBQUM7SUFFSixHQUFHLENBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRTtRQUN4QixHQUFHO1lBQ0YsT0FBTyxJQUFJLENBQUM7UUFDYixDQUFDO0tBQ0QsQ0FBRSxDQUFDO0lBRUosTUFBTSxVQUFVLENBQUM7QUFFbEIsQ0FBQyxDQUFDO0FBRUYsTUFBTSwwQkFBMEIsR0FBRyxVQUFzQixJQUFnQztJQUV4RixNQUFNLEVBQ0wsUUFBUSxFQUNSLFFBQVEsRUFDUixTQUFTLEVBQ1QsSUFBSSxFQUNKLEtBQUssRUFDTCxHQUFHLElBQUksQ0FBQztJQUlULE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQztJQUV2QixHQUFHLENBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRTtRQUN2QixHQUFHO1lBQ0YsT0FBTyxJQUFJLENBQUM7UUFDYixDQUFDO0tBQ0QsQ0FBRSxDQUFDO0lBRUosR0FBRyxDQUFFLFNBQVMsRUFBRSxlQUFlLEVBQUU7UUFDaEMsR0FBRztZQUNGLE9BQU8sS0FBSyxDQUFDO1FBQ2QsQ0FBQztLQUNELENBQUUsQ0FBQztJQUVKLEdBQUcsQ0FBRSxTQUFTLEVBQUUsVUFBVSxFQUFFO1FBQzNCLEdBQUc7WUFDRixPQUFPLFFBQVEsQ0FBQztRQUNqQixDQUFDO0tBQ0QsQ0FBRSxDQUFDO0lBRUosR0FBRyxDQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUU7UUFDMUIsR0FBRztZQUNGLE9BQU8sR0FBRyxFQUFFO2dCQUNYLE9BQU8sUUFBUSxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQzNCLENBQUMsQ0FBQztRQUNILENBQUM7S0FDRCxDQUFFLENBQUM7SUFFSixHQUFHLENBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRTtRQUN4QixHQUFHO1lBQ0YsT0FBTyxHQUFHLEVBQUU7Z0JBQ1gsT0FBTyxLQUFLLENBQUUsUUFBUSxDQUFFLENBQUM7WUFDMUIsQ0FBQyxDQUFDO1FBQ0gsQ0FBQztLQUNELENBQUUsQ0FBQztJQUdKLE1BQU0sVUFBVSxHQUFHLFNBQVMsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFFLElBQUksQ0FBRSxDQUFDO0lBRWpELE1BQU0sS0FBSyxHQUFhLEVBQUUsQ0FBQztJQUUzQixNQUFNLEtBQUssR0FBRyx3QkFBd0IsUUFBUSxlQUFlLENBQUM7SUFFOUQsaUJBQVEsQ0FBQyxJQUFJLENBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsZ0JBQWdCLENBQUUsQ0FBQztJQUV4RCxLQUFLLENBQUMsSUFBSSxDQUFFLEdBQUcsU0FBUyxDQUFDLEtBQUssQ0FBRSxDQUFDO0lBRWpDLEtBQUssQ0FBQyxJQUFJLENBQUUsa0NBQWtDLENBQUUsQ0FBQztJQUVqRCxVQUFVLENBQUMsT0FBTyxDQUFFLENBQUUsSUFBWSxFQUFHLEVBQUU7UUFDdEMsSUFBSyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUUsSUFBSSxDQUFFLEVBQUcsQ0FBQztZQUMvQixLQUFLLENBQUMsSUFBSSxDQUFFLElBQUksQ0FBRSxDQUFDO1FBQ3BCLENBQUM7SUFDRixDQUFDLENBQUUsQ0FBQztJQUVKLEtBQUssQ0FBQyxJQUFJLENBQUUsNENBQTRDLENBQUUsQ0FBQztJQUMzRCxLQUFLLENBQUMsSUFBSSxDQUFFLEdBQUcsU0FBUyxDQUFFLENBQUM7SUFFM0IsTUFBTSxjQUFjLEdBQUcsSUFBQSxxQkFBWSxFQUFFLEtBQUssQ0FBRSxDQUFDLElBQUksQ0FBRSxJQUFJLENBQUUsQ0FBQztJQUUxRCxHQUFHLENBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRTtRQUN4QixHQUFHO1lBQ0YsT0FBTyxjQUFjLENBQUM7UUFDdkIsQ0FBQztLQUNELENBQUMsQ0FBQztJQUVILE9BQU8sU0FBUyxDQUFDO0FBR2xCLENBQUMsQ0FBQztBQUVGLE1BQU0sZ0JBQWdCLEdBQUcsVUFBc0IsTUFBVyxFQUFFLEtBQVksRUFBRSxHQUFHLElBQVc7SUFHdkYsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDO0lBRXRCLGNBQWMsQ0FBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUUsQ0FBQztJQUVoRCxNQUFNLEtBQUssR0FBRyxJQUFBLG1CQUFRLEVBQUMsUUFBUSxDQUFVLENBQUM7SUFFMUMsTUFBTSxFQUNMLFFBQVEsRUFDUixXQUFXLEVBQ1gsR0FBRyxLQUFLLENBQUM7SUFHVixNQUFNLEVBQ0wsS0FBSyxFQUFFLFNBQVMsRUFDaEIsUUFBUSxFQUNSLEdBQUcsUUFBUSxDQUFDO0lBVWIsTUFBTSxnQkFBZ0IsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFFLFdBQVcsQ0FBRSxDQUFDO0lBQ3RELGdCQUFnQixDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFFLEVBQUUsRUFBRSxXQUFXLENBQUMsTUFBTSxDQUFFLENBQUM7SUFDbEUsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUM7SUFFNUMsZ0JBQWdCLENBQUMsZ0JBQWdCLEdBQUcsS0FBSyxDQUFDO0lBRTFDLGdCQUFnQixDQUFDLGVBQWUsR0FBRyx1QkFBdUIsQ0FBRSxRQUFRLEVBQUU7UUFDckUsT0FBTywwQkFBMEIsQ0FBQyxJQUFJLENBQUUsSUFBSSxFQUFFO1lBQzdDLFFBQVE7WUFDUixRQUFRO1lBQ1IsU0FBUztZQUNULElBQUk7WUFDSixLQUFLO1NBQ0wsQ0FBRSxDQUFDO0lBQ0wsQ0FBQyxDQUFFLENBQUM7SUFFSixnQkFBZ0IsQ0FBQyxtQkFBbUIsR0FBRyxJQUFBLDZDQUF1QixFQUFFLGdCQUFnQixDQUFFLENBQUM7SUFFbkYsT0FBTyxJQUFJLGdCQUFnQixDQUFDLG1CQUFtQixFQUFFLENBQUM7QUFDbkQsQ0FBQyxDQUFDO0FBRUYsa0JBQWUsZ0JBQWdCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmltcG9ydCB7IGNvbnN0YW50cyB9IGZyb20gJy4uLy4uL2NvbnN0YW50cyc7XG5jb25zdCB7IG9kcCB9ID0gY29uc3RhbnRzO1xuXG5pbXBvcnQgeyBFcnJvcnNUeXBlcyB9IGZyb20gJy4uLy4uL2Rlc2NyaXB0b3JzL2Vycm9ycyc7XG5jb25zdCB7XG5cdFdST05HX0FSR1VNRU5UU19VU0VELFxuXHRXUk9OR19JTlNUQU5DRV9JTlZPQ0FUSU9OXG59ID0gRXJyb3JzVHlwZXM7XG5cbmltcG9ydCB7IGNsZWFudXBTdGFjaywgZ2V0U3RhY2sgfSBmcm9tICcuLi9lcnJvcnMnO1xuXG5pbXBvcnQgeyB1dGlscyB9IGZyb20gJy4uLy4uL3V0aWxzJztcbmNvbnN0IHtcblx0cGFyc2Vcbn0gPSB1dGlscztcblxuaW1wb3J0IFR5cGVzVXRpbHMgZnJvbSAnLi4vdXRpbHMnO1xuXG5jb25zdCB7XG5cdG1ha2VGYWtlTW9kaWZpY2F0b3JUeXBlXG59ID0gVHlwZXNVdGlscztcblxuaW1wb3J0IHsgbWFrZUluc3RhbmNlTW9kaWZpY2F0b3IgfSBmcm9tICcuLi90eXBlcy9JbnN0YW5jZU1vZGlmaWNhdG9yJztcblxuaW1wb3J0IHsgZ2V0UHJvcHMsIFByb3BzIH0gZnJvbSAnLi4vdHlwZXMvYWRkUHJvcHMnO1xuXG5jb25zdCBjaGVja1Rocm93QXJncyA9ICggaW5zdGFuY2U6IGFueSwgdGFyZ2V0OiBhbnksIGVycm9yOiBFcnJvciwgYXJnczogYW55W10gKSA9PiB7XG5cblx0bGV0IHdyb25nVGhyb3c7XG5cblx0LyogdW5yZWFjaGVibGUsIGN1cyBpbnN0YW5jZSBib3VuZCBpbnNpZGUgb2YgTW5lbW9zeW5lXG5cdGlmIChpbnN0YW5jZSAhPT0gT2JqZWN0KGluc3RhbmNlKSkge1xuXHRcdHdyb25nVGhyb3cgPSBuZXcgV1JPTkdfQVJHVU1FTlRTX1VTRUQoJ1widGhpc1wiIG11c3QgYmUgYW4gb2JqZWN0Jyk7XG5cdH1cblx0aWYgKGluc3RhbmNlLmNvbnN0cnVjdG9yW1N5bWJvbENvbnN0cnVjdG9yTmFtZV0gIT09IGluc3RhbmNlLmNvbnN0cnVjdG9yLm5hbWUpIHtcblx0XHR3cm9uZ1Rocm93ID0gbmV3IFdST05HX0FSR1VNRU5UU19VU0VEKCdcInRoaXNcIiBtdXN0IGJlIGFuIG9iamVjdCcpO1xuXHR9XG5cdCovXG5cblx0aWYgKCAhdGFyZ2V0ICkge1xuXHRcdHRocm93IG5ldyBXUk9OR19JTlNUQU5DRV9JTlZPQ0FUSU9OKCAnZXhjZXB0aW9uIHNob3VsZCBiZSBtYWRlIHdpdGggbmV3IGtleXdvcmQnICk7XG5cdH1cblxuXHRpZiAoICEoIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgKSApIHtcblx0XHR3cm9uZ1Rocm93ID0gbmV3IFdST05HX0FSR1VNRU5UU19VU0VEKCAnZXJyb3IgbXVzdCBiZSBpbnN0YW5jZW9mIEVycm9yJyApO1xuXHR9XG5cblx0aWYgKCAhKCB3cm9uZ1Rocm93IGluc3RhbmNlb2YgRXJyb3IgKSApIHtcblx0XHRyZXR1cm47XG5cdH1cblxuXHRvZHAoIHdyb25nVGhyb3csICdpbnN0YW5jZScsIHtcblx0XHRnZXQgKCkge1xuXHRcdFx0cmV0dXJuIGluc3RhbmNlO1xuXHRcdH1cblx0fSApO1xuXG5cdG9kcCggd3JvbmdUaHJvdywgJ2Vycm9yJywge1xuXHRcdGdldCAoKSB7XG5cdFx0XHRyZXR1cm4gZXJyb3I7XG5cdFx0fVxuXHR9ICk7XG5cblx0b2RwKCB3cm9uZ1Rocm93LCAnYXJncycsIHtcblx0XHRnZXQgKCkge1xuXHRcdFx0cmV0dXJuIGFyZ3M7XG5cdFx0fVxuXHR9ICk7XG5cblx0dGhyb3cgd3JvbmdUaHJvdztcblxufTtcblxuY29uc3QgZXhjZXB0aW9uQ29uc2N0cnVjdEhhbmRsZXIgPSBmdW5jdGlvbiAoIHRoaXM6IGFueSwgb3B0czogeyBbIGluZGV4OiBzdHJpbmcgXTogYW55IH0gKSB7XG5cblx0Y29uc3Qge1xuXHRcdGluc3RhbmNlLFxuXHRcdFR5cGVOYW1lLFxuXHRcdHR5cGVTdGFjayxcblx0XHRhcmdzLFxuXHRcdGVycm9yXG5cdH0gPSBvcHRzO1xuXG5cblx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby10aGlzLWFsaWFzXG5cdGNvbnN0IGV4Y2VwdGlvbiA9IHRoaXM7XG5cblx0b2RwKCBleGNlcHRpb24sICdhcmdzJywge1xuXHRcdGdldCAoKSB7XG5cdFx0XHRyZXR1cm4gYXJncztcblx0XHR9XG5cdH0gKTtcblxuXHRvZHAoIGV4Y2VwdGlvbiwgJ29yaWdpbmFsRXJyb3InLCB7XG5cdFx0Z2V0ICgpIHtcblx0XHRcdHJldHVybiBlcnJvcjtcblx0XHR9XG5cdH0gKTtcblxuXHRvZHAoIGV4Y2VwdGlvbiwgJ2luc3RhbmNlJywge1xuXHRcdGdldCAoKSB7XG5cdFx0XHRyZXR1cm4gaW5zdGFuY2U7XG5cdFx0fVxuXHR9ICk7XG5cblx0b2RwKCBleGNlcHRpb24sICdleHRyYWN0Jywge1xuXHRcdGdldCAoKSB7XG5cdFx0XHRyZXR1cm4gKCkgPT4ge1xuXHRcdFx0XHRyZXR1cm4gaW5zdGFuY2UuZXh0cmFjdCgpO1xuXHRcdFx0fTtcblx0XHR9XG5cdH0gKTtcblxuXHRvZHAoIGV4Y2VwdGlvbiwgJ3BhcnNlJywge1xuXHRcdGdldCAoKSB7XG5cdFx0XHRyZXR1cm4gKCkgPT4ge1xuXHRcdFx0XHRyZXR1cm4gcGFyc2UoIGluc3RhbmNlICk7XG5cdFx0XHR9O1xuXHRcdH1cblx0fSApO1xuXG5cdC8vIHJlYWwgZXJyb3Igc3RhY2tcblx0Y29uc3QgZXJyb3JTdGFjayA9IGV4Y2VwdGlvbi5zdGFjay5zcGxpdCggJ1xcbicgKTtcblxuXHRjb25zdCBzdGFjazogc3RyaW5nW10gPSBbXTtcblxuXHRjb25zdCB0aXRsZSA9IGBcXG48LS0gbGlmZWN5Y2xlIG9mIFsgJHtUeXBlTmFtZX0gXSB0cmFjZWQgLS0+YDtcblxuXHRnZXRTdGFjay5jYWxsKCBleGNlcHRpb24sIHRpdGxlLCBbXSwgcHJlcGFyZUV4Y2VwdGlvbiApO1xuXG5cdHN0YWNrLnB1c2goIC4uLmV4Y2VwdGlvbi5zdGFjayApO1xuXG5cdHN0YWNrLnB1c2goICc8LS0gd2l0aCB0aGUgZm9sbG93aW5nIGVycm9yIC0tPicgKTtcblxuXHRlcnJvclN0YWNrLmZvckVhY2goICggbGluZTogc3RyaW5nICkgPT4ge1xuXHRcdGlmICggIXN0YWNrLmluY2x1ZGVzKCBsaW5lICkgKSB7XG5cdFx0XHRzdGFjay5wdXNoKCBsaW5lICk7XG5cdFx0fVxuXHR9ICk7XG5cblx0c3RhY2sucHVzaCggJ1xcbjwtLSBvZiBjb25zdHJ1Y3RvciBkZWZpbml0aW9ucyBzdGFjayAtLT4nICk7XG5cdHN0YWNrLnB1c2goIC4uLnR5cGVTdGFjayApO1xuXG5cdGNvbnN0IGV4Y2VwdGlvblN0YWNrID0gY2xlYW51cFN0YWNrKCBzdGFjayApLmpvaW4oICdcXG4nICk7XG5cblx0b2RwKCBleGNlcHRpb24sICdzdGFjaycsIHtcblx0XHRnZXQgKCkge1xuXHRcdFx0cmV0dXJuIGV4Y2VwdGlvblN0YWNrO1xuXHRcdH1cblx0fSk7XG5cblx0cmV0dXJuIGV4Y2VwdGlvbjtcblxuXG59O1xuXG5jb25zdCBwcmVwYXJlRXhjZXB0aW9uID0gZnVuY3Rpb24gKCB0aGlzOiBhbnksIHRhcmdldDogYW55LCBlcnJvcjogRXJyb3IsIC4uLmFyZ3M6IGFueVtdICkge1xuXG5cdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdGhpcy1hbGlhc1xuXHRjb25zdCBpbnN0YW5jZSA9IHRoaXM7XG5cblx0Y2hlY2tUaHJvd0FyZ3MoIGluc3RhbmNlLCB0YXJnZXQsIGVycm9yLCBhcmdzICk7XG5cblx0Y29uc3QgcHJvcHMgPSBnZXRQcm9wcyhpbnN0YW5jZSkgYXMgUHJvcHM7XG5cblx0Y29uc3Qge1xuXHRcdF9fdHlwZV9fLFxuXHRcdF9fY3JlYXRvcl9fXG5cdH0gPSBwcm9wcztcblxuXG5cdGNvbnN0IHtcblx0XHRzdGFjazogdHlwZVN0YWNrLFxuXHRcdFR5cGVOYW1lXG5cdH0gPSBfX3R5cGVfXztcblxuXHQvKiBzaG9ydCB3YXksIG1ha2VzIGhvb2tzIGNhbGxzLCB3aWxsIG5vdCB1c2VcblxuXHRjb25zdCB0eXBlID0gT2JqZWN0LmNyZWF0ZShfX3R5cGVfXyk7XG5cdHR5cGUuY29uZmlnLmJsb2NrRXJyb3JzID0gZmFsc2U7XG5cblx0bGV0IGVycm9yZWQgPSBuZXcgSW5zdGFuY2VDcmVhdG9yKHR5cGUsIGVycm9yLCBhcmdzKTtcblx0Ki9cblxuXHRjb25zdCBFeGNlcHRpb25DcmVhdG9yID0gT2JqZWN0LmNyZWF0ZSggX19jcmVhdG9yX18gKTtcblx0RXhjZXB0aW9uQ3JlYXRvci5jb25maWcgPSBPYmplY3QuYXNzaWduKCB7fSwgX19jcmVhdG9yX18uY29uZmlnICk7XG5cdEV4Y2VwdGlvbkNyZWF0b3IuY29uZmlnLmJsb2NrRXJyb3JzID0gZmFsc2U7XG5cblx0RXhjZXB0aW9uQ3JlYXRvci5leGlzdGVudEluc3RhbmNlID0gZXJyb3I7XG5cdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1zaGFkb3dcblx0RXhjZXB0aW9uQ3JlYXRvci5Nb2RpZmljYXRvclR5cGUgPSBtYWtlRmFrZU1vZGlmaWNhdG9yVHlwZSggVHlwZU5hbWUsIGZ1bmN0aW9uICggdGhpczogdW5rbm93biApIHtcblx0XHRyZXR1cm4gZXhjZXB0aW9uQ29uc2N0cnVjdEhhbmRsZXIuY2FsbCggdGhpcywge1xuXHRcdFx0aW5zdGFuY2UsXG5cdFx0XHRUeXBlTmFtZSxcblx0XHRcdHR5cGVTdGFjayxcblx0XHRcdGFyZ3MsXG5cdFx0XHRlcnJvclxuXHRcdH0gKTtcblx0fSApO1xuXG5cdEV4Y2VwdGlvbkNyZWF0b3IuSW5zdGFuY2VNb2RpZmljYXRvciA9IG1ha2VJbnN0YW5jZU1vZGlmaWNhdG9yKCBFeGNlcHRpb25DcmVhdG9yICk7XG5cblx0cmV0dXJuIG5ldyBFeGNlcHRpb25DcmVhdG9yLkluc3RhbmNlTW9kaWZpY2F0b3IoKTtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IHByZXBhcmVFeGNlcHRpb247XG4iXX0=