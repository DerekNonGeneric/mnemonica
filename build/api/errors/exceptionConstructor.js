'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
const constants_1 = require("../../constants");
const { odp } = constants_1.constants;
const errors_1 = require("../../descriptors/errors");
const { WRONG_ARGUMENTS_USED, WRONG_INSTANCE_INVOCATION } = errors_1.ErrorsTypes;
const errors_2 = require("../errors");
const utils_1 = require("../../utils");
const { parse } = utils_1.utils;
const utils_2 = require("../utils");
const { makeFakeModificatorType } = utils_2.default;
const InstanceModificator_1 = require("../types/InstanceModificator");
const Props_1 = require("../types/Props");
const checkThrowArgs = (instance, target, error, args) => {
    let wrongThrow;
    if (!target) {
        throw new WRONG_INSTANCE_INVOCATION('exception should be made with new keyword');
    }
    if (!(error instanceof Error)) {
        wrongThrow = new WRONG_ARGUMENTS_USED('error must be instanceof Error');
    }
    if (!(wrongThrow instanceof Error)) {
        return;
    }
    odp(wrongThrow, 'instance', {
        get() {
            return instance;
        }
    });
    odp(wrongThrow, 'error', {
        get() {
            return error;
        }
    });
    odp(wrongThrow, 'args', {
        get() {
            return args;
        }
    });
    throw wrongThrow;
};
const exceptionConsctructHandler = function (opts) {
    const { instance, TypeName, typeStack, args, error } = opts;
    const exception = this;
    odp(exception, 'args', {
        get() {
            return args;
        }
    });
    odp(exception, 'originalError', {
        get() {
            return error;
        }
    });
    odp(exception, 'instance', {
        get() {
            return instance;
        }
    });
    odp(exception, 'extract', {
        get() {
            return () => {
                return instance.extract();
            };
        }
    });
    odp(exception, 'parse', {
        get() {
            return () => {
                return parse(instance);
            };
        }
    });
    const errorStack = exception.stack.split('\n');
    const stack = [];
    const title = `\n<-- lifecycle of [ ${TypeName} ] traced -->`;
    errors_2.getStack.call(exception, title, [], prepareException);
    stack.push(...exception.stack);
    stack.push('<-- with the following error -->');
    errorStack.forEach((line) => {
        if (!stack.includes(line)) {
            stack.push(line);
        }
    });
    stack.push('\n<-- of constructor definitions stack -->');
    stack.push(...typeStack);
    const exceptionStack = (0, errors_2.cleanupStack)(stack).join('\n');
    odp(exception, 'stack', {
        get() {
            return exceptionStack;
        }
    });
    return exception;
};
const prepareException = function (target, error, ...args) {
    const instance = this;
    checkThrowArgs(instance, target, error, args);
    const props = (0, Props_1._getProps)(instance);
    const { __type__, __creator__ } = props;
    const { stack: typeStack, TypeName } = __type__;
    const ExceptionCreator = Object.create(__creator__);
    ExceptionCreator.config = Object.assign({}, __creator__.config);
    ExceptionCreator.config.blockErrors = false;
    ExceptionCreator.existentInstance = error;
    ExceptionCreator.ModificatorType = makeFakeModificatorType(TypeName, function () {
        return exceptionConsctructHandler.call(this, {
            instance,
            TypeName,
            typeStack,
            args,
            error
        });
    });
    ExceptionCreator.InstanceModificator = (0, InstanceModificator_1.makeInstanceModificator)(ExceptionCreator);
    return new ExceptionCreator.InstanceModificator();
};
exports.default = prepareException;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhjZXB0aW9uQ29uc3RydWN0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvYXBpL2Vycm9ycy9leGNlcHRpb25Db25zdHJ1Y3Rvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7O0FBRWIsK0NBQTRDO0FBQzVDLE1BQU0sRUFBRSxHQUFHLEVBQUUsR0FBRyxxQkFBUyxDQUFDO0FBRTFCLHFEQUF1RDtBQUN2RCxNQUFNLEVBQ0wsb0JBQW9CLEVBQ3BCLHlCQUF5QixFQUN6QixHQUFHLG9CQUFXLENBQUM7QUFFaEIsc0NBQW1EO0FBRW5ELHVDQUFvQztBQUNwQyxNQUFNLEVBQ0wsS0FBSyxFQUNMLEdBQUcsYUFBSyxDQUFDO0FBRVYsb0NBQWtDO0FBRWxDLE1BQU0sRUFDTCx1QkFBdUIsRUFDdkIsR0FBRyxlQUFVLENBQUM7QUFFZixzRUFBdUU7QUFFdkUsMENBQWtEO0FBRWxELE1BQU0sY0FBYyxHQUFHLENBQUUsUUFBYSxFQUFFLE1BQVcsRUFBRSxLQUFZLEVBQUUsSUFBVyxFQUFHLEVBQUU7SUFFbEYsSUFBSSxVQUFVLENBQUM7SUFXZixJQUFLLENBQUMsTUFBTSxFQUFHLENBQUM7UUFDZixNQUFNLElBQUkseUJBQXlCLENBQUUsMkNBQTJDLENBQUUsQ0FBQztJQUNwRixDQUFDO0lBRUQsSUFBSyxDQUFDLENBQUUsS0FBSyxZQUFZLEtBQUssQ0FBRSxFQUFHLENBQUM7UUFDbkMsVUFBVSxHQUFHLElBQUksb0JBQW9CLENBQUUsZ0NBQWdDLENBQUUsQ0FBQztJQUMzRSxDQUFDO0lBRUQsSUFBSyxDQUFDLENBQUUsVUFBVSxZQUFZLEtBQUssQ0FBRSxFQUFHLENBQUM7UUFDeEMsT0FBTztJQUNSLENBQUM7SUFFRCxHQUFHLENBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRTtRQUM1QixHQUFHO1lBQ0YsT0FBTyxRQUFRLENBQUM7UUFDakIsQ0FBQztLQUNELENBQUUsQ0FBQztJQUVKLEdBQUcsQ0FB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LEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUUsQ0FBQztJQUVoRCxNQUFNLEtBQUssR0FBRyxJQUFBLGlCQUFTLEVBQUMsUUFBUSxDQUFVLENBQUM7SUFFM0MsTUFBTSxFQUNMLFFBQVEsRUFDUixXQUFXLEVBQ1gsR0FBRyxLQUFLLENBQUM7SUFHVixNQUFNLEVBQ0wsS0FBSyxFQUFFLFNBQVMsRUFDaEIsUUFBUSxFQUNSLEdBQUcsUUFBUSxDQUFDO0lBVWIsTUFBTSxnQkFBZ0IsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFFLFdBQVcsQ0FBRSxDQUFDO0lBQ3RELGdCQUFnQixDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFFLEVBQUUsRUFBRSxXQUFXLENBQUMsTUFBTSxDQUFFLENBQUM7SUFDbEUsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUM7SUFFNUMsZ0JBQWdCLENBQUMsZ0JBQWdCLEdBQUcsS0FBSyxDQUFDO0lBRTFDLGdCQUFnQixDQUFDLGVBQWUsR0FBRyx1QkFBdUIsQ0FBRSxRQUFRLEVBQUU7UUFDckUsT0FBTywwQkFBMEIsQ0FBQyxJQUFJLENBQUUsSUFBSSxFQUFFO1lBQzdDLFFBQVE7WUFDUixRQUFRO1lBQ1IsU0FBUztZQUNULElBQUk7WUFDSixLQUFLO1NBQ0wsQ0FBRSxDQUFDO0lBQ0wsQ0FBQyxDQUFFLENBQUM7SUFFSixnQkFBZ0IsQ0FBQyxtQkFBbUIsR0FBRyxJQUFBLDZDQUF1QixFQUFFLGdCQUFnQixDQUFFLENBQUM7SUFFbkYsT0FBTyxJQUFJLGdCQUFnQixDQUFDLG1CQUFtQixFQUFFLENBQUM7QUFDbkQsQ0FBQyxDQUFDO0FBRUYsa0JBQWUsZ0JBQWdCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmltcG9ydCB7IGNvbnN0YW50cyB9IGZyb20gJy4uLy4uL2NvbnN0YW50cyc7XG5jb25zdCB7IG9kcCB9ID0gY29uc3RhbnRzO1xuXG5pbXBvcnQgeyBFcnJvcnNUeXBlcyB9IGZyb20gJy4uLy4uL2Rlc2NyaXB0b3JzL2Vycm9ycyc7XG5jb25zdCB7XG5cdFdST05HX0FSR1VNRU5UU19VU0VELFxuXHRXUk9OR19JTlNUQU5DRV9JTlZPQ0FUSU9OXG59ID0gRXJyb3JzVHlwZXM7XG5cbmltcG9ydCB7IGNsZWFudXBTdGFjaywgZ2V0U3RhY2sgfSBmcm9tICcuLi9lcnJvcnMnO1xuXG5pbXBvcnQgeyB1dGlscyB9IGZyb20gJy4uLy4uL3V0aWxzJztcbmNvbnN0IHtcblx0cGFyc2Vcbn0gPSB1dGlscztcblxuaW1wb3J0IFR5cGVzVXRpbHMgZnJvbSAnLi4vdXRpbHMnO1xuXG5jb25zdCB7XG5cdG1ha2VGYWtlTW9kaWZpY2F0b3JUeXBlXG59ID0gVHlwZXNVdGlscztcblxuaW1wb3J0IHsgbWFrZUluc3RhbmNlTW9kaWZpY2F0b3IgfSBmcm9tICcuLi90eXBlcy9JbnN0YW5jZU1vZGlmaWNhdG9yJztcblxuaW1wb3J0IHsgX2dldFByb3BzLCBQcm9wcyB9IGZyb20gJy4uL3R5cGVzL1Byb3BzJztcblxuY29uc3QgY2hlY2tUaHJvd0FyZ3MgPSAoIGluc3RhbmNlOiBhbnksIHRhcmdldDogYW55LCBlcnJvcjogRXJyb3IsIGFyZ3M6IGFueVtdICkgPT4ge1xuXG5cdGxldCB3cm9uZ1Rocm93O1xuXG5cdC8qIHVucmVhY2hlYmxlLCBjdXMgaW5zdGFuY2UgYm91bmQgaW5zaWRlIG9mIE1uZW1vc3luZVxuXHRpZiAoaW5zdGFuY2UgIT09IE9iamVjdChpbnN0YW5jZSkpIHtcblx0XHR3cm9uZ1Rocm93ID0gbmV3IFdST05HX0FSR1VNRU5UU19VU0VEKCdcInRoaXNcIiBtdXN0IGJlIGFuIG9iamVjdCcpO1xuXHR9XG5cdGlmIChpbnN0YW5jZS5jb25zdHJ1Y3RvcltTeW1ib2xDb25zdHJ1Y3Rvck5hbWVdICE9PSBpbnN0YW5jZS5jb25zdHJ1Y3Rvci5uYW1lKSB7XG5cdFx0d3JvbmdUaHJvdyA9IG5ldyBXUk9OR19BUkdVTUVOVFNfVVNFRCgnXCJ0aGlzXCIgbXVzdCBiZSBhbiBvYmplY3QnKTtcblx0fVxuXHQqL1xuXG5cdGlmICggIXRhcmdldCApIHtcblx0XHR0aHJvdyBuZXcgV1JPTkdfSU5TVEFOQ0VfSU5WT0NBVElPTiggJ2V4Y2VwdGlvbiBzaG91bGQgYmUgbWFkZSB3aXRoIG5ldyBrZXl3b3JkJyApO1xuXHR9XG5cblx0aWYgKCAhKCBlcnJvciBpbnN0YW5jZW9mIEVycm9yICkgKSB7XG5cdFx0d3JvbmdUaHJvdyA9IG5ldyBXUk9OR19BUkdVTUVOVFNfVVNFRCggJ2Vycm9yIG11c3QgYmUgaW5zdGFuY2VvZiBFcnJvcicgKTtcblx0fVxuXG5cdGlmICggISggd3JvbmdUaHJvdyBpbnN0YW5jZW9mIEVycm9yICkgKSB7XG5cdFx0cmV0dXJuO1xuXHR9XG5cblx0b2RwKCB3cm9uZ1Rocm93LCAnaW5zdGFuY2UnLCB7XG5cdFx0Z2V0ICgpIHtcblx0XHRcdHJldHVybiBpbnN0YW5jZTtcblx0XHR9XG5cdH0gKTtcblxuXHRvZHAoIHdyb25nVGhyb3csICdlcnJvcicsIHtcblx0XHRnZXQgKCkge1xuXHRcdFx0cmV0dXJuIGVycm9yO1xuXHRcdH1cblx0fSApO1xuXG5cdG9kcCggd3JvbmdUaHJvdywgJ2FyZ3MnLCB7XG5cdFx0Z2V0ICgpIHtcblx0XHRcdHJldHVybiBhcmdzO1xuXHRcdH1cblx0fSApO1xuXG5cdHRocm93IHdyb25nVGhyb3c7XG5cbn07XG5cbmNvbnN0IGV4Y2VwdGlvbkNvbnNjdHJ1Y3RIYW5kbGVyID0gZnVuY3Rpb24gKCB0aGlzOiBhbnksIG9wdHM6IHsgWyBpbmRleDogc3RyaW5nIF06IGFueSB9ICkge1xuXG5cdGNvbnN0IHtcblx0XHRpbnN0YW5jZSxcblx0XHRUeXBlTmFtZSxcblx0XHR0eXBlU3RhY2ssXG5cdFx0YXJncyxcblx0XHRlcnJvclxuXHR9ID0gb3B0cztcblxuXG5cdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdGhpcy1hbGlhc1xuXHRjb25zdCBleGNlcHRpb24gPSB0aGlzO1xuXG5cdG9kcCggZXhjZXB0aW9uLCAnYXJncycsIHtcblx0XHRnZXQgKCkge1xuXHRcdFx0cmV0dXJuIGFyZ3M7XG5cdFx0fVxuXHR9ICk7XG5cblx0b2RwKCBleGNlcHRpb24sICdvcmlnaW5hbEVycm9yJywge1xuXHRcdGdldCAoKSB7XG5cdFx0XHRyZXR1cm4gZXJyb3I7XG5cdFx0fVxuXHR9ICk7XG5cblx0b2RwKCBleGNlcHRpb24sICdpbnN0YW5jZScsIHtcblx0XHRnZXQgKCkge1xuXHRcdFx0cmV0dXJuIGluc3RhbmNlO1xuXHRcdH1cblx0fSApO1xuXG5cdG9kcCggZXhjZXB0aW9uLCAnZXh0cmFjdCcsIHtcblx0XHRnZXQgKCkge1xuXHRcdFx0cmV0dXJuICgpID0+IHtcblx0XHRcdFx0cmV0dXJuIGluc3RhbmNlLmV4dHJhY3QoKTtcblx0XHRcdH07XG5cdFx0fVxuXHR9ICk7XG5cblx0b2RwKCBleGNlcHRpb24sICdwYXJzZScsIHtcblx0XHRnZXQgKCkge1xuXHRcdFx0cmV0dXJuICgpID0+IHtcblx0XHRcdFx0cmV0dXJuIHBhcnNlKCBpbnN0YW5jZSApO1xuXHRcdFx0fTtcblx0XHR9XG5cdH0gKTtcblxuXHQvLyByZWFsIGVycm9yIHN0YWNrXG5cdGNvbnN0IGVycm9yU3RhY2sgPSBleGNlcHRpb24uc3RhY2suc3BsaXQoICdcXG4nICk7XG5cblx0Y29uc3Qgc3RhY2s6IHN0cmluZ1tdID0gW107XG5cblx0Y29uc3QgdGl0bGUgPSBgXFxuPC0tIGxpZmVjeWNsZSBvZiBbICR7VHlwZU5hbWV9IF0gdHJhY2VkIC0tPmA7XG5cblx0Z2V0U3RhY2suY2FsbCggZXhjZXB0aW9uLCB0aXRsZSwgW10sIHByZXBhcmVFeGNlcHRpb24gKTtcblxuXHRzdGFjay5wdXNoKCAuLi5leGNlcHRpb24uc3RhY2sgKTtcblxuXHRzdGFjay5wdXNoKCAnPC0tIHdpdGggdGhlIGZvbGxvd2luZyBlcnJvciAtLT4nICk7XG5cblx0ZXJyb3JTdGFjay5mb3JFYWNoKCAoIGxpbmU6IHN0cmluZyApID0+IHtcblx0XHRpZiAoICFzdGFjay5pbmNsdWRlcyggbGluZSApICkge1xuXHRcdFx0c3RhY2sucHVzaCggbGluZSApO1xuXHRcdH1cblx0fSApO1xuXG5cdHN0YWNrLnB1c2goICdcXG48LS0gb2YgY29uc3RydWN0b3IgZGVmaW5pdGlvbnMgc3RhY2sgLS0+JyApO1xuXHRzdGFjay5wdXNoKCAuLi50eXBlU3RhY2sgKTtcblxuXHRjb25zdCBleGNlcHRpb25TdGFjayA9IGNsZWFudXBTdGFjayggc3RhY2sgKS5qb2luKCAnXFxuJyApO1xuXG5cdG9kcCggZXhjZXB0aW9uLCAnc3RhY2snLCB7XG5cdFx0Z2V0ICgpIHtcblx0XHRcdHJldHVybiBleGNlcHRpb25TdGFjaztcblx0XHR9XG5cdH0pO1xuXG5cdHJldHVybiBleGNlcHRpb247XG5cblxufTtcblxuY29uc3QgcHJlcGFyZUV4Y2VwdGlvbiA9IGZ1bmN0aW9uICggdGhpczogYW55LCB0YXJnZXQ6IGFueSwgZXJyb3I6IEVycm9yLCAuLi5hcmdzOiBhbnlbXSApIHtcblxuXHQvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXRoaXMtYWxpYXNcblx0Y29uc3QgaW5zdGFuY2UgPSB0aGlzO1xuXG5cdGNoZWNrVGhyb3dBcmdzKCBpbnN0YW5jZSwgdGFyZ2V0LCBlcnJvciwgYXJncyApO1xuXG5cdGNvbnN0IHByb3BzID0gX2dldFByb3BzKGluc3RhbmNlKSBhcyBQcm9wcztcblxuXHRjb25zdCB7XG5cdFx0X190eXBlX18sXG5cdFx0X19jcmVhdG9yX19cblx0fSA9IHByb3BzO1xuXG5cblx0Y29uc3Qge1xuXHRcdHN0YWNrOiB0eXBlU3RhY2ssXG5cdFx0VHlwZU5hbWVcblx0fSA9IF9fdHlwZV9fO1xuXG5cdC8qIHNob3J0IHdheSwgbWFrZXMgaG9va3MgY2FsbHMsIHdpbGwgbm90IHVzZVxuXG5cdGNvbnN0IHR5cGUgPSBPYmplY3QuY3JlYXRlKF9fdHlwZV9fKTtcblx0dHlwZS5jb25maWcuYmxvY2tFcnJvcnMgPSBmYWxzZTtcblxuXHRsZXQgZXJyb3JlZCA9IG5ldyBJbnN0YW5jZUNyZWF0b3IodHlwZSwgZXJyb3IsIGFyZ3MpO1xuXHQqL1xuXG5cdGNvbnN0IEV4Y2VwdGlvbkNyZWF0b3IgPSBPYmplY3QuY3JlYXRlKCBfX2NyZWF0b3JfXyApO1xuXHRFeGNlcHRpb25DcmVhdG9yLmNvbmZpZyA9IE9iamVjdC5hc3NpZ24oIHt9LCBfX2NyZWF0b3JfXy5jb25maWcgKTtcblx0RXhjZXB0aW9uQ3JlYXRvci5jb25maWcuYmxvY2tFcnJvcnMgPSBmYWxzZTtcblxuXHRFeGNlcHRpb25DcmVhdG9yLmV4aXN0ZW50SW5zdGFuY2UgPSBlcnJvcjtcblx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXNoYWRvd1xuXHRFeGNlcHRpb25DcmVhdG9yLk1vZGlmaWNhdG9yVHlwZSA9IG1ha2VGYWtlTW9kaWZpY2F0b3JUeXBlKCBUeXBlTmFtZSwgZnVuY3Rpb24gKCB0aGlzOiB1bmtub3duICkge1xuXHRcdHJldHVybiBleGNlcHRpb25Db25zY3RydWN0SGFuZGxlci5jYWxsKCB0aGlzLCB7XG5cdFx0XHRpbnN0YW5jZSxcblx0XHRcdFR5cGVOYW1lLFxuXHRcdFx0dHlwZVN0YWNrLFxuXHRcdFx0YXJncyxcblx0XHRcdGVycm9yXG5cdFx0fSApO1xuXHR9ICk7XG5cblx0RXhjZXB0aW9uQ3JlYXRvci5JbnN0YW5jZU1vZGlmaWNhdG9yID0gbWFrZUluc3RhbmNlTW9kaWZpY2F0b3IoIEV4Y2VwdGlvbkNyZWF0b3IgKTtcblxuXHRyZXR1cm4gbmV3IEV4Y2VwdGlvbkNyZWF0b3IuSW5zdGFuY2VNb2RpZmljYXRvcigpO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgcHJlcGFyZUV4Y2VwdGlvbjtcbiJdfQ==