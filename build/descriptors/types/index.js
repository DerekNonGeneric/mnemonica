'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.types = void 0;
const constants_1 = require("../../constants");
const { odp, SymbolConstructorName, SymbolDefaultTypesCollection, SymbolConfig, defaultOptions, defaultOptionsKeys, MNEMONICA, MNEMOSYNE, } = constants_1.constants;
const types_1 = require("../../api/types");
const hooksAPI = require("../../api/hooks");
const { registerHook, invokeHook, registerFlowChecker, } = hooksAPI;
const typesCollections = new Map();
const TypesCollection = function (_config) {
    const self = this;
    const subtypes = new Map();
    const config = defaultOptionsKeys.reduce((o, key) => {
        const value = _config[key];
        const option = defaultOptions[key];
        const t_conf = typeof value;
        const t_opts = typeof option;
        if (t_conf === t_opts) {
            o[key] = value;
        }
        else {
            o[key] = option;
        }
        return o;
    }, {});
    odp(this, SymbolConfig, {
        get() {
            return config;
        }
    });
    odp(this, Symbol.hasInstance, {
        get() {
            return (instance) => {
                return instance[SymbolConstructorName] === MNEMONICA;
            };
        }
    });
    odp(this, 'subtypes', {
        get() {
            return subtypes;
        }
    });
    odp(subtypes, MNEMOSYNE, {
        get() {
            return typesCollections.get(self);
        }
    });
    odp(this, MNEMOSYNE, {
        get() {
            return typesCollections.get(self);
        }
    });
    const hooks = Object.create(null);
    odp(this, 'hooks', {
        get() {
            return hooks;
        }
    });
};
odp(TypesCollection.prototype, MNEMONICA, {
    get() {
        return typesCollections.get(this);
    }
});
odp(TypesCollection.prototype, 'define', {
    get() {
        const { subtypes } = this;
        return function (...args) {
            return types_1.define.call(this, subtypes, ...args);
        };
    },
    enumerable: true
});
odp(TypesCollection.prototype, 'lookup', {
    get() {
        return function (...args) {
            return types_1.lookup.call(this.subtypes, ...args);
        }.bind(this);
    },
    enumerable: true
});
odp(TypesCollection.prototype, 'registerHook', {
    get() {
        const self = this;
        return function (hookName, hookCallback) {
            return registerHook.call(self, hookName, hookCallback);
        }.bind(this);
    },
    enumerable: true
});
odp(TypesCollection.prototype, 'invokeHook', {
    get() {
        return function (hookName, hookCallback) {
            const self = this;
            return invokeHook.call(typesCollections.get(self), hookName, hookCallback);
        }.bind(this);
    }
});
odp(TypesCollection.prototype, 'registerFlowChecker', {
    get() {
        return function (flowCheckerCallback) {
            const self = this;
            return registerFlowChecker.call(typesCollections.get(self), flowCheckerCallback);
        }.bind(this);
    }
});
const typesCollectionProxyHandler = {
    get(target, prop) {
        if (target.subtypes.has(prop)) {
            return target.subtypes.get(prop);
        }
        return Reflect.get(target, prop);
    },
    set(target, TypeName, Constructor) {
        return target.define(TypeName, Constructor);
    },
    getOwnPropertyDescriptor(target, prop) {
        return target.subtypes.has(prop) ? {
            configurable: true,
            enumerable: true,
            writable: false,
            value: target.subtypes.get(prop)
        } : undefined;
    }
};
const createTypesCollection = (config = {}) => {
    const typesCollection = new TypesCollection(config);
    const typesCollectionProxy = new Proxy(typesCollection, typesCollectionProxyHandler);
    typesCollections.set(typesCollection, typesCollectionProxy);
    return typesCollectionProxy;
};
const DEFAULT_TYPES = createTypesCollection();
odp(DEFAULT_TYPES, SymbolDefaultTypesCollection, {
    get() {
        return true;
    }
});
exports.types = {
    get createTypesCollection() {
        return function (config = {}) {
            return createTypesCollection(config);
        };
    },
    get defaultTypes() {
        return DEFAULT_TYPES;
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvZGVzY3JpcHRvcnMvdHlwZXMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7QUFNYiwrQ0FBNEM7QUFDNUMsTUFBTSxFQUNMLEdBQUcsRUFDSCxxQkFBcUIsRUFDckIsNEJBQTRCLEVBQzVCLFlBQVksRUFDWixjQUFjLEVBQ2Qsa0JBQWtCLEVBQ2xCLFNBQVMsRUFDVCxTQUFTLEdBQ1QsR0FBRyxxQkFBUyxDQUFDO0FBR2QsMkNBQWlEO0FBRWpELDRDQUE0QztBQUU1QyxNQUFNLEVBQ0wsWUFBWSxFQUNaLFVBQVUsRUFDVixtQkFBbUIsR0FDbkIsR0FBRyxRQUFRLENBQUM7QUFFYixNQUFNLGdCQUFnQixHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7QUFFbkMsTUFBTSxlQUFlLEdBQUcsVUFBVyxPQUFnQztJQUdsRSxNQUFNLElBQUksR0FBRyxJQUFJLENBQUM7SUFFbEIsTUFBTSxRQUFRLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztJQUczQixNQUFNLE1BQU0sR0FBRyxrQkFBa0IsQ0FBQyxNQUFNLENBQUUsQ0FBRSxDQUEwQixFQUFFLEdBQVcsRUFBRyxFQUFFO1FBQ3ZGLE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBRSxHQUFHLENBQUUsQ0FBQztRQUM3QixNQUFNLE1BQU0sR0FBRyxjQUFjLENBQUUsR0FBRyxDQUFFLENBQUM7UUFDckMsTUFBTSxNQUFNLEdBQUcsT0FBTyxLQUFLLENBQUM7UUFDNUIsTUFBTSxNQUFNLEdBQUcsT0FBTyxNQUFNLENBQUM7UUFDN0IsSUFBSyxNQUFNLEtBQUssTUFBTSxFQUFHLENBQUM7WUFDekIsQ0FBQyxDQUFFLEdBQUcsQ0FBRSxHQUFHLEtBQUssQ0FBQztRQUNsQixDQUFDO2FBQU0sQ0FBQztZQUNQLENBQUMsQ0FBRSxHQUFHLENBQUUsR0FBRyxNQUFNLENBQUM7UUFDbkIsQ0FBQztRQUNE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LENBQUM7WUFDcEMsWUFBWSxFQUFHLElBQUk7WUFDbkIsVUFBVSxFQUFLLElBQUk7WUFDbkIsUUFBUSxFQUFPLEtBQUs7WUFDcEIsS0FBSyxFQUFVLE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFFLElBQUksQ0FBRTtTQUMxQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7SUFDZixDQUFDO0NBQ0QsQ0FBQztBQUVGLE1BQU0scUJBQXFCLEdBQUcsQ0FBRSxNQUFNLEdBQUcsRUFBRSxFQUFHLEVBQUU7SUFFL0MsTUFBTSxlQUFlLEdBQUcsSUFBSSxlQUFlLENBQUUsTUFBTSxDQUFFLENBQUM7SUFDdEQsTUFBTSxvQkFBb0IsR0FBRyxJQUFJLEtBQUssQ0FBRSxlQUFlLEVBQUUsMkJBQTJCLENBQUUsQ0FBQztJQUV2RixnQkFBZ0IsQ0FBQyxHQUFHLENBQUUsZUFBZSxFQUFFLG9CQUFvQixDQUFFLENBQUM7SUFFOUQsT0FBTyxvQkFBb0IsQ0FBQztBQUU3QixDQUFDLENBQUM7QUFFRixNQUFNLGFBQWEsR0FBRyxxQkFBcUIsRUFBRSxDQUFDO0FBQzlDLEdBQUcsQ0FBRSxhQUFhLEVBQUUsNEJBQTRCLEVBQUU7SUFDakQsR0FBRztRQUNGLE9BQU8sSUFBSSxDQUFDO0lBQ2IsQ0FBQztDQUNELENBQUUsQ0FBQztBQUVTLFFBQUEsS0FBSyxHQUFHO0lBQ3BCLElBQUkscUJBQXFCO1FBQ3hCLE9BQU8sVUFBVyxNQUFNLEdBQUcsRUFBRTtZQUM1QixPQUFPLHFCQUFxQixDQUFFLE1BQU0sQ0FBRSxDQUFDO1FBQ3hDLENBQUMsQ0FBQztJQUNILENBQUM7SUFDRCxJQUFJLFlBQVk7UUFDZixPQUFPLGFBQWEsQ0FBQztJQUN0QixDQUFDO0NBRUQsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuaW1wb3J0IHtcblx0Q29uc3RydWN0b3JGdW5jdGlvblxufSBmcm9tICcuLi8uLi90eXBlcyc7XG5cbmltcG9ydCB7IGNvbnN0YW50cyB9IGZyb20gJy4uLy4uL2NvbnN0YW50cyc7XG5jb25zdCB7XG5cdG9kcCxcblx0U3ltYm9sQ29uc3RydWN0b3JOYW1lLFxuXHRTeW1ib2xEZWZhdWx0VHlwZXNDb2xsZWN0aW9uLFxuXHRTeW1ib2xDb25maWcsXG5cdGRlZmF1bHRPcHRpb25zLFxuXHRkZWZhdWx0T3B0aW9uc0tleXMsXG5cdE1ORU1PTklDQSxcblx0TU5FTU9TWU5FLFxufSA9IGNvbnN0YW50cztcblxuLy8gaGVyZSBpcyBUeXBlc0NvbGxlY3Rpb24uZGVmaW5lKCkgbWV0aG9kXG5pbXBvcnQgeyBkZWZpbmUsIGxvb2t1cCB9IGZyb20gJy4uLy4uL2FwaS90eXBlcyc7XG5cbmltcG9ydCAqIGFzIGhvb2tzQVBJIGZyb20gJy4uLy4uL2FwaS9ob29rcyc7XG5cbmNvbnN0IHtcblx0cmVnaXN0ZXJIb29rLFxuXHRpbnZva2VIb29rLFxuXHRyZWdpc3RlckZsb3dDaGVja2VyLFxufSA9IGhvb2tzQVBJO1xuXG5jb25zdCB0eXBlc0NvbGxlY3Rpb25zID0gbmV3IE1hcCgpO1xuXG5jb25zdCBUeXBlc0NvbGxlY3Rpb24gPSBmdW5jdGlvbiAoIF9jb25maWc6IFJlY29yZDxzdHJpbmcsIHVua25vd24+ICkge1xuXG5cdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdGhpcy1hbGlhc1xuXHRjb25zdCBzZWxmID0gdGhpcztcblxuXHRjb25zdCBzdWJ0eXBlcyA9IG5ldyBNYXAoKTtcblxuXHQvLyBkZWZhdWx0IGNvbmZpZyBpcyBsZXNzIGltcG9ydGFudCB0aGFuIHR5cGVzIGNvbGxlY3Rpb24gY29uZmlnXG5cdGNvbnN0IGNvbmZpZyA9IGRlZmF1bHRPcHRpb25zS2V5cy5yZWR1Y2UoICggbzogUmVjb3JkPHN0cmluZywgdW5rbm93bj4sIGtleTogc3RyaW5nICkgPT4ge1xuXHRcdGNvbnN0IHZhbHVlID0gX2NvbmZpZ1sga2V5IF07XG5cdFx0Y29uc3Qgb3B0aW9uID0gZGVmYXVsdE9wdGlvbnNbIGtleSBdO1xuXHRcdGNvbnN0IHRfY29uZiA9IHR5cGVvZiB2YWx1ZTtcblx0XHRjb25zdCB0X29wdHMgPSB0eXBlb2Ygb3B0aW9uO1xuXHRcdGlmICggdF9jb25mID09PSB0X29wdHMgKSB7XG5cdFx0XHRvWyBrZXkgXSA9IHZhbHVlO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRvWyBrZXkgXSA9IG9wdGlvbjtcblx0XHR9XG5cdFx0cmV0dXJuIG87XG5cdH0sIHt9ICk7XG5cblx0b2RwKCB0aGlzLCBTeW1ib2xDb25maWcsIHtcblx0XHRnZXQgKCkge1xuXHRcdFx0cmV0dXJuIGNvbmZpZztcblx0XHR9XG5cdH0gKTtcblxuXHRvZHAoIHRoaXMsIFN5bWJvbC5oYXNJbnN0YW5jZSwge1xuXHRcdGdldCAoKSB7XG5cdFx0XHRyZXR1cm4gKCBpbnN0YW5jZTogYW55ICkgPT4ge1xuXHRcdFx0XHRyZXR1cm4gaW5zdGFuY2VbIFN5bWJvbENvbnN0cnVjdG9yTmFtZSBdID09PSBNTkVNT05JQ0E7XG5cdFx0XHR9O1xuXHRcdH1cblx0fSApO1xuXG5cdG9kcCggdGhpcywgJ3N1YnR5cGVzJywge1xuXHRcdGdldCAoKSB7XG5cdFx0XHRyZXR1cm4gc3VidHlwZXM7XG5cdFx0fVxuXHR9ICk7XG5cblx0Ly8gRm9yIGluc3RhbmNlb2YgTU5FTU9TWU5FXG5cdG9kcCggc3VidHlwZXMsIE1ORU1PU1lORSwge1xuXHRcdGdldCAoKSB7XG5cdFx0XHQvLyByZXR1cm5pbmcgcHJveHlcblx0XHRcdHJldHVybiB0eXBlc0NvbGxlY3Rpb25zLmdldCggc2VsZiApO1xuXHRcdH1cblx0fSApO1xuXG5cdC8vIEZvciBpbnN0YW5jZW9mIE1ORU1PU1lORVxuXHRvZHAoIHRoaXMsIE1ORU1PU1lORSwge1xuXHRcdGdldCAoKSB7XG5cdFx0XHQvLyByZXR1cm5pbmcgcHJveHlcblx0XHRcdHJldHVybiB0eXBlc0NvbGxlY3Rpb25zLmdldCggc2VsZiApO1xuXHRcdH1cblx0fSApO1xuXG5cdGNvbnN0IGhvb2tzID0gT2JqZWN0LmNyZWF0ZSggbnVsbCApO1xuXHRvZHAoIHRoaXMsICdob29rcycsIHtcblx0XHRnZXQgKCkge1xuXHRcdFx0cmV0dXJuIGhvb2tzO1xuXHRcdH1cblx0fSApO1xuXG59IGFzIENvbnN0cnVjdG9yRnVuY3Rpb248b2JqZWN0Pjtcblxub2RwKCBUeXBlc0NvbGxlY3Rpb24ucHJvdG90eXBlLCBNTkVNT05JQ0EsIHtcblx0Z2V0ICgpIHtcblx0XHRyZXR1cm4gdHlwZXNDb2xsZWN0aW9ucy5nZXQoIHRoaXMgKTtcblx0fVxufSApO1xuXG5vZHAoIFR5cGVzQ29sbGVjdGlvbi5wcm90b3R5cGUsICdkZWZpbmUnLCB7XG5cdGdldCAoKSB7XG5cdFx0Y29uc3Qge1xuXHRcdFx0c3VidHlwZXNcblx0XHR9ID0gdGhpcztcblx0XHRyZXR1cm4gZnVuY3Rpb24gKCB0aGlzOiBhbnksIC4uLmFyZ3M6IGFueVtdICkge1xuXHRcdFx0Ly8gdGhpcyAtIGRlZmluZSBmdW5jdGlvbiBvZiBtbmVtb25pY2EgaW50ZXJmYWNlXG5cdFx0XHRyZXR1cm4gZGVmaW5lLmNhbGwoIHRoaXMsIHN1YnR5cGVzLCAuLi5hcmdzICk7XG5cdFx0fTtcblx0fSxcblx0ZW51bWVyYWJsZSA6IHRydWVcbn0gKTtcblxub2RwKCBUeXBlc0NvbGxlY3Rpb24ucHJvdG90eXBlLCAnbG9va3VwJywge1xuXHRnZXQgKCkge1xuXHRcdHJldHVybiBmdW5jdGlvbiAoIHRoaXM6IGFueSwgLi4uYXJnczogYW55W10gKSB7XG5cdFx0XHRyZXR1cm4gbG9va3VwLmNhbGwoIHRoaXMuc3VidHlwZXMsIC4uLmFyZ3MgKTtcblx0XHR9LmJpbmQoIHRoaXMgKTtcblx0fSxcblx0ZW51bWVyYWJsZSA6IHRydWVcbn0gKTtcblxub2RwKCBUeXBlc0NvbGxlY3Rpb24ucHJvdG90eXBlLCAncmVnaXN0ZXJIb29rJywge1xuXHRnZXQgKCkge1xuXHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdGhpcy1hbGlhc1xuXHRcdGNvbnN0IHNlbGYgPSB0aGlzO1xuXHRcdHJldHVybiBmdW5jdGlvbiAoIHRoaXM6IHVua25vd24sIGhvb2tOYW1lOiBzdHJpbmcsIGhvb2tDYWxsYmFjazogQ2FsbGFibGVGdW5jdGlvbiApIHtcblx0XHRcdC8vIHJldHVybiBwcm90by5yZWdpc3Rlckhvb2suY2FsbCggdHlwZXNDb2xsZWN0aW9ucy5nZXQoIHNlbGYgKSwgaG9va05hbWUsIGhvb2tDYWxsYmFjayApO1xuXHRcdFx0cmV0dXJuIHJlZ2lzdGVySG9vay5jYWxsKCBzZWxmLCBob29rTmFtZSwgaG9va0NhbGxiYWNrICk7XG5cdFx0fS5iaW5kKCB0aGlzICk7XG5cdH0sXG5cdGVudW1lcmFibGUgOiB0cnVlXG59ICk7XG5cbm9kcCggVHlwZXNDb2xsZWN0aW9uLnByb3RvdHlwZSwgJ2ludm9rZUhvb2snLCB7XG5cdGdldCAoKSB7XG5cdFx0cmV0dXJuIGZ1bmN0aW9uICggdGhpczogdW5rbm93biwgaG9va05hbWU6IHN0cmluZywgaG9va0NhbGxiYWNrOiBDYWxsYWJsZUZ1bmN0aW9uICkge1xuXHRcdFx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby10aGlzLWFsaWFzXG5cdFx0XHRjb25zdCBzZWxmID0gdGhpcztcblx0XHRcdC8vIHJldHVybiBwcm90by5pbnZva2VIb29rLmNhbGwoIHR5cGVzQ29sbGVjdGlvbnMuZ2V0KCBzZWxmICksIGhvb2tOYW1lLCBob29rQ2FsbGJhY2sgKTtcblx0XHRcdHJldHVybiBpbnZva2VIb29rLmNhbGwoIHR5cGVzQ29sbGVjdGlvbnMuZ2V0KCBzZWxmICksIGhvb2tOYW1lLCBob29rQ2FsbGJhY2sgKTtcblx0XHR9LmJpbmQoIHRoaXMgKTtcblx0fVxufSApO1xuXG5vZHAoIFR5cGVzQ29sbGVjdGlvbi5wcm90b3R5cGUsICdyZWdpc3RlckZsb3dDaGVja2VyJywge1xuXHRnZXQgKCkge1xuXHRcdHJldHVybiBmdW5jdGlvbiAoIHRoaXM6IHVua25vd24sIGZsb3dDaGVja2VyQ2FsbGJhY2s6ICgpID0+IHVua25vd24gKSB7XG5cdFx0XHQvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXRoaXMtYWxpYXNcblx0XHRcdGNvbnN0IHNlbGYgPSB0aGlzO1xuXHRcdFx0cmV0dXJuIHJlZ2lzdGVyRmxvd0NoZWNrZXIuY2FsbCggdHlwZXNDb2xsZWN0aW9ucy5nZXQoIHNlbGYgKSwgZmxvd0NoZWNrZXJDYWxsYmFjayApO1xuXHRcdH0uYmluZCggdGhpcyApO1xuXHR9XG59ICk7XG5cblxuY29uc3QgdHlwZXNDb2xsZWN0aW9uUHJveHlIYW5kbGVyID0ge1xuXHRnZXQgKCB0YXJnZXQ6IGFueSwgcHJvcDogc3RyaW5nICkge1xuXHRcdGlmICggdGFyZ2V0LnN1YnR5cGVzLmhhcyggcHJvcCApICkge1xuXHRcdFx0cmV0dXJuIHRhcmdldC5zdWJ0eXBlcy5nZXQoIHByb3AgKTtcblx0XHR9XG5cdFx0cmV0dXJuIFJlZmxlY3QuZ2V0KCB0YXJnZXQsIHByb3AgKTtcblx0fSxcblx0c2V0ICggdGFyZ2V0OiBhbnksIFR5cGVOYW1lOiBzdHJpbmcsIENvbnN0cnVjdG9yOiBGdW5jdGlvbkNvbnN0cnVjdG9yICkge1xuXHRcdHJldHVybiB0YXJnZXQuZGVmaW5lKCBUeXBlTmFtZSwgQ29uc3RydWN0b3IgKTtcblx0fSxcblx0Ly8gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsXG5cdGdldE93blByb3BlcnR5RGVzY3JpcHRvciAoIHRhcmdldDogYW55LCBwcm9wOiBzdHJpbmcgKSB7XG5cdFx0cmV0dXJuIHRhcmdldC5zdWJ0eXBlcy5oYXMoIHByb3AgKSA/IHtcblx0XHRcdGNvbmZpZ3VyYWJsZSA6IHRydWUsXG5cdFx0XHRlbnVtZXJhYmxlICAgOiB0cnVlLFxuXHRcdFx0d3JpdGFibGUgICAgIDogZmFsc2UsXG5cdFx0XHR2YWx1ZSAgICAgICAgOiB0YXJnZXQuc3VidHlwZXMuZ2V0KCBwcm9wIClcblx0XHR9IDogdW5kZWZpbmVkO1xuXHR9XG59O1xuXG5jb25zdCBjcmVhdGVUeXBlc0NvbGxlY3Rpb24gPSAoIGNvbmZpZyA9IHt9ICkgPT4ge1xuXG5cdGNvbnN0IHR5cGVzQ29sbGVjdGlvbiA9IG5ldyBUeXBlc0NvbGxlY3Rpb24oIGNvbmZpZyApO1xuXHRjb25zdCB0eXBlc0NvbGxlY3Rpb25Qcm94eSA9IG5ldyBQcm94eSggdHlwZXNDb2xsZWN0aW9uLCB0eXBlc0NvbGxlY3Rpb25Qcm94eUhhbmRsZXIgKTtcblxuXHR0eXBlc0NvbGxlY3Rpb25zLnNldCggdHlwZXNDb2xsZWN0aW9uLCB0eXBlc0NvbGxlY3Rpb25Qcm94eSApO1xuXG5cdHJldHVybiB0eXBlc0NvbGxlY3Rpb25Qcm94eTtcblxufTtcblxuY29uc3QgREVGQVVMVF9UWVBFUyA9IGNyZWF0ZVR5cGVzQ29sbGVjdGlvbigpO1xub2RwKCBERUZBVUxUX1RZUEVTLCBTeW1ib2xEZWZhdWx0VHlwZXNDb2xsZWN0aW9uLCB7XG5cdGdldCAoKSB7XG5cdFx0cmV0dXJuIHRydWU7XG5cdH1cbn0gKTtcblxuZXhwb3J0IGNvbnN0IHR5cGVzID0ge1xuXHRnZXQgY3JlYXRlVHlwZXNDb2xsZWN0aW9uICgpIHtcblx0XHRyZXR1cm4gZnVuY3Rpb24gKCBjb25maWcgPSB7fSApIHtcblx0XHRcdHJldHVybiBjcmVhdGVUeXBlc0NvbGxlY3Rpb24oIGNvbmZpZyApO1xuXHRcdH07XG5cdH0sXG5cdGdldCBkZWZhdWx0VHlwZXMgKCkge1xuXHRcdHJldHVybiBERUZBVUxUX1RZUEVTO1xuXHR9XG5cbn07XG4iXX0=